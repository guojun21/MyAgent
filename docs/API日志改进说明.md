# API æ—¥å¿—è®°å½•åŠŸèƒ½æ”¹è¿›è¯´æ˜

> æ›´æ–°æ—¶é—´ï¼š2025-10-27  
> æ”¹è¿›ç‰ˆæœ¬ï¼šv1.1

---

## ğŸ“‹ æ”¹è¿›å†…å®¹

æœ¬æ¬¡æ›´æ–°è§£å†³äº†ä¸¤ä¸ªé‡è¦é—®é¢˜ï¼š

### 1. Session ä½¿ç”¨æ—¶é—´æˆ³å‘½å

**é—®é¢˜**ï¼š
- æ‰€æœ‰æ—¥å¿—éƒ½ä¿å­˜åœ¨ `session_unknown` æ–‡ä»¶å¤¹ä¸­
- å› ä¸ºæ²¡æœ‰ä¼ é€’ session_idï¼Œå¯¼è‡´æ‰€æœ‰è°ƒç”¨æ··åœ¨ä¸€èµ·

**è§£å†³æ–¹æ¡ˆ**ï¼š
- Session æ–‡ä»¶å¤¹æ”¹ç”¨ Logger åˆ›å»ºæ—¶çš„æ—¶é—´æˆ³å‘½å
- æ ¼å¼ï¼š`session_20251027_040210`ï¼ˆå¹´æœˆæ—¥_æ—¶åˆ†ç§’ï¼‰
- æ¯æ¬¡ç¨‹åºå¯åŠ¨éƒ½ä¼šæœ‰å”¯ä¸€çš„ session æ ‡è¯†

**ä¼˜åŠ¿**ï¼š
- âœ… æ— éœ€æ‰‹åŠ¨ä¼ é€’ session_id
- âœ… æ¯æ¬¡å¯åŠ¨è‡ªåŠ¨æœ‰å”¯ä¸€æ ‡è¯†
- âœ… æ—¶é—´æˆ³æ¸…æ™°ï¼Œæ˜“äºè¿½æº¯
- âœ… é¿å… "unknown" æ··ä¹±

**ç¤ºä¾‹**ï¼š
```
llmlogs/apiCall/20251027/
â”œâ”€â”€ session_20251027_040105/  â† ä¸Šåˆ 4:01:05 å¯åŠ¨
â”‚   â”œâ”€â”€ call_20251027_040105_001/
â”‚   â”œâ”€â”€ call_20251027_040105_002/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ session_20251027_040210/  â† ä¸Šåˆ 4:02:10 é‡å¯
â”‚   â”œâ”€â”€ call_20251027_040210_001/
â”‚   â””â”€â”€ ...
```

### 2. è®°å½•å¤±è´¥çš„ API è°ƒç”¨

**é—®é¢˜**ï¼š
- API è°ƒç”¨å¤±è´¥ï¼ˆ400ã€è¶…æ—¶ç­‰ï¼‰æ—¶ä¸è®°å½•æ—¥å¿—
- æ— æ³•è¿½æº¯å¤±è´¥åŸå› 
- ä¸¢å¤±é‡è¦çš„è°ƒè¯•ä¿¡æ¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åœ¨ `except` å—ä¸­ä¹Ÿè®°å½•å¤±è´¥è°ƒç”¨
- æ„é€ åŒ…å«é”™è¯¯ä¿¡æ¯çš„ response_data
- åœ¨ metadata å’Œ output ä¸­æ ‡è®°é”™è¯¯

**è®°å½•çš„é”™è¯¯ä¿¡æ¯**ï¼š
1. é”™è¯¯ç±»å‹ï¼ˆerror_typeï¼‰ï¼šå¦‚ APIError, TimeoutError
2. é”™è¯¯æ¶ˆæ¯ï¼ˆerror_messageï¼‰ï¼šå®Œæ•´çš„é”™è¯¯æè¿°
3. å»¶è¿Ÿæ—¶é—´ï¼šè®°å½•è¶…æ—¶å‰ç­‰å¾…çš„æ—¶é—´
4. è¯·æ±‚å†…å®¹ï¼šå®Œæ•´è®°å½•å‘é€äº†ä»€ä¹ˆ

**metadata.json ç¤ºä¾‹**ï¼š
```json
{
  "response_info": {
    "error": true,
    "error_type": "APIError",
    "error_message": "Request timed out after 30 seconds",
    "finish_reason": "",
    "has_tool_calls": false
  },
  "performance": {
    "latency_ms": 30501,
    "tokens_per_second": 0.0
  },
  "usage": {
    "prompt_tokens": 0,
    "completion_tokens": 0,
    "total_tokens": 0
  }
}
```

**output.txt ç¤ºä¾‹**ï¼š
```
================================================================================
API RESPONSE OUTPUT
================================================================================

âš ï¸ API è°ƒç”¨å¤±è´¥

é”™è¯¯ç±»å‹: APIError
é”™è¯¯æ¶ˆæ¯: Request timed out after 30 seconds

================================================================================
```

---

## ğŸ”§ ä»£ç æ”¹åŠ¨

### 1. services/api_logger.py

**ä¿®æ”¹ç‚¹**ï¼š
```python
# ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸º session æ ‡è¯†
self.session_timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')

# Session ç›®å½•å‘½å
session_dir = date_dir / f"session_{self.session_timestamp}"

# metadata ä¸­æ·»åŠ é”™è¯¯æ ‡è®°
"response_info": {
    "error": response_data.get("error", False),
    "error_type": response_data.get("error_type", ""),
    "error_message": response_data.get("error_message", ""),
    ...
}

# output.txt æ ¼å¼åŒ–é”™è¯¯
if response_data.get("error"):
    lines.append("âš ï¸ API è°ƒç”¨å¤±è´¥")
    lines.append(f"é”™è¯¯ç±»å‹: {response_data.get('error_type')}")
    lines.append(f"é”™è¯¯æ¶ˆæ¯: {response_data.get('error_message')}")
```

### 2. services/llm_service.py

**ä¿®æ”¹ç‚¹**ï¼š
```python
except Exception as e:
    # è®°å½•å¤±è´¥çš„ API è°ƒç”¨
    if self.enable_api_logging:
        response_data = {
            "error": True,
            "error_type": type(e).__name__,
            "error_message": str(e),
            "timestamp": time.time(),
            "id": "error_" + str(int(time.time())),
            "object": "error",
            "model": self.model,
            "choices": [],
            "usage": {"prompt_tokens": 0, "completion_tokens": 0, "total_tokens": 0}
        }
        
        self.api_logger.log_api_call(request_data, response_data, full_context)
        print(f"[DeepSeek] âœ… å¤±è´¥è°ƒç”¨å·²è®°å½•åˆ°æ—¥å¿—")
```

---

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•1ï¼šSession æ—¶é—´æˆ³å‘½å

**æµ‹è¯•ä»£ç **ï¼š
```python
logger1 = APILogger()
print(f"Session: {logger1.session_timestamp}")  # è¾“å‡ºï¼š20251027_040210

time.sleep(1)

logger2 = APILogger()
print(f"Session: {logger2.session_timestamp}")  # è¾“å‡ºï¼š20251027_040211
```

**ç»“æœ**ï¼šâœ… é€šè¿‡
- ä¸åŒ Logger å®ä¾‹æœ‰ä¸åŒçš„æ—¶é—´æˆ³
- set_session() ä¸å†æ”¹å˜æ—¶é—´æˆ³

### æµ‹è¯•2ï¼šå¤±è´¥è°ƒç”¨è®°å½•

**æµ‹è¯•åœºæ™¯**ï¼šæ¨¡æ‹Ÿ API è¶…æ—¶

**ç»“æœ**ï¼šâœ… é€šè¿‡
- å¤±è´¥è°ƒç”¨å·²è®°å½•
- metadata.json æ­£ç¡®æ ‡è®° error: true
- output.txt æ¸…æ™°æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
- å»¶è¿Ÿæ—¶é—´æ­£ç¡®è®°å½•ï¼ˆ30.5ç§’ï¼‰

---

## ğŸ“Š æ”¹è¿›å‰åå¯¹æ¯”

| åŠŸèƒ½ | æ”¹è¿›å‰ | æ”¹è¿›å |
|------|--------|--------|
| Session å‘½å | session_unknown | session_20251027_040210 |
| å¤±è´¥è°ƒç”¨ | âŒ ä¸è®°å½• | âœ… å®Œæ•´è®°å½• |
| é”™è¯¯è¿½æº¯ | âŒ æ— æ³•è¿½æº¯ | âœ… é”™è¯¯ç±»å‹+æ¶ˆæ¯ |
| æ—¥å¿—ç»„ç»‡ | æ··ä¹±ï¼ˆéƒ½åœ¨ unknownï¼‰ | æ¸…æ™°ï¼ˆæŒ‰æ—¶é—´æˆ³åˆ†ç»„ï¼‰ |

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šè°ƒè¯•è¶…æ—¶é—®é¢˜

**é—®é¢˜**ï¼šAPI ç»å¸¸è¶…æ—¶ï¼Œä¸çŸ¥é“åŸå› 

**è§£å†³**ï¼š
1. æŸ¥çœ‹å¤±è´¥æ—¥å¿—ï¼š`python tools/view_api_log.py`
2. æ£€æŸ¥ error_message
3. æŸ¥çœ‹ input.json çœ‹æ˜¯å¦ prompt å¤ªé•¿
4. ä¼˜åŒ–åå¯¹æ¯”

### åœºæ™¯2ï¼šè¿½è¸ªæŸæ¬¡å¯åŠ¨çš„æ‰€æœ‰è°ƒç”¨

**é—®é¢˜**ï¼šæƒ³çœ‹ä¸Šåˆ 4 ç‚¹é‚£æ¬¡è¿è¡Œçš„æ‰€æœ‰æ—¥å¿—

**è§£å†³**ï¼š
1. æ‰¾åˆ° `session_20251027_040210` æ–‡ä»¶å¤¹
2. æŸ¥çœ‹è¯¥æ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰ call
3. å®Œæ•´è¿½æº¯æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹

### åœºæ™¯3ï¼šç»Ÿè®¡å¤±è´¥ç‡

**é—®é¢˜**ï¼šæƒ³çŸ¥é“ API è°ƒç”¨çš„æˆåŠŸç‡

**è§£å†³**ï¼š
1. è¿è¡Œåˆ†æå·¥å…·
2. æ£€æŸ¥ metadata ä¸­çš„ error æ ‡è®°
3. è®¡ç®—å¤±è´¥ç‡ = å¤±è´¥æ•° / æ€»æ•°

---

## ğŸš€ åç»­ä¼˜åŒ–æ–¹å‘

1. **å¤±è´¥å‘Šè­¦**
   - å¤±è´¥æ¬¡æ•°è¶…è¿‡é˜ˆå€¼æ—¶å‘é€é€šçŸ¥
   - è¿ç»­å¤±è´¥æ—¶è‡ªåŠ¨é™çº§

2. **é‡è¯•æœºåˆ¶**
   - è‡ªåŠ¨é‡è¯•å¤±è´¥çš„è°ƒç”¨
   - è®°å½•é‡è¯•å†å²

3. **å¤±è´¥åˆ†æ**
   - ç»Ÿè®¡å¤±è´¥ç±»å‹åˆ†å¸ƒ
   - è¯†åˆ«é«˜é¢‘å¤±è´¥åŸå› 

4. **æ€§èƒ½ç›‘æ§**
   - å®æ—¶ç›‘æ§æˆåŠŸç‡
   - Dashboard å¯è§†åŒ–

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [APIæ—¥å¿—è®°å½•ä½¿ç”¨è¯´æ˜](./APIæ—¥å¿—è®°å½•ä½¿ç”¨è¯´æ˜.md)
- [åŸå§‹è®¾è®¡æ–¹æ¡ˆ](./resolution/20251026_1909_APIè°ƒç”¨å®Œæ•´æ—¥å¿—æ–¹æ¡ˆ.md)
- [å®æ–½å®ŒæˆæŠ¥å‘Š](./resolution/20251026_1909_APIè°ƒç”¨å®Œæ•´æ—¥å¿—æ–¹æ¡ˆ_å®æ–½å®Œæˆ.md)

---

**æ›´æ–°æ—¥æœŸ**ï¼š2025-10-27  
**ç‰ˆæœ¬**ï¼šv1.1  
**æ”¹è¿›è€…**ï¼šAI Assistant + User

