# Plan-Execute-Think å¾ªç¯æ‰§è¡Œæ–¹æ¡ˆ

> åˆ›å»ºæ—¶é—´ï¼š2025-10-26 19:00  
> çŠ¶æ€ï¼šå¾…å®æ–½  
> ä¼˜å…ˆçº§ï¼šP0ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

---

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

### å½“å‰é—®é¢˜
1. **å·¥å…·è°ƒç”¨å¤±æ§**ï¼š`tool_choice="required"` æ— æ³•æŒ‡å®šå…·ä½“å·¥å…·ï¼ŒLLMä¹±è°ƒç”¨å…¶ä»–å·¥å…·
2. **30æ­¥èµ°æ»¡**ï¼šæ¯æ¬¡è¿­ä»£éƒ½è¿”å›å·¥å…·è°ƒç”¨ï¼Œä»æœªè¿”å›æ–‡æœ¬ç»™ç”¨æˆ·
3. **ç¼ºä¹åœæ­¢æœºåˆ¶**ï¼šæ²¡æœ‰æ˜ç¡®çš„ä»»åŠ¡å®Œæˆä¿¡å·
4. **æ•ˆç‡ä½ä¸‹**ï¼šä¸€æ¬¡æ€§è§„åˆ’æ— æ³•æ ¹æ®æ‰§è¡Œç»“æœåŠ¨æ€è°ƒæ•´

### å¯¹æ¯”åˆ†æ

| æ¶æ„æ¨¡å¼ | å½“å‰é¡¹ç›® | trae-agent | é—®é¢˜ |
|---------|---------|-----------|------|
| æ¨¡å¼ | Planner-Executor | ReAct | å½“å‰å®ç°æœ‰bug |
| è¿­ä»£ä¸Šé™ | 30æ¬¡ | 20æ¬¡ | 30æ¬¡å¤ªå¤šï¼Œå®¹æ˜“å¤±æ§ |
| å·¥å…·æ•°é‡ | 11ä¸ª | 5ä¸ª | å·¥å…·å¤ªå¤šï¼ŒLLMé€‰æ‹©å›°éš¾ |
| åœæ­¢æœºåˆ¶ | âŒ æ—  | âœ… task_done | å¯¼è‡´30æ­¥èµ°æ»¡ |

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆï¼šæ‰¹é‡Plan-Execute-Thinkå¾ªç¯

### æ ¸å¿ƒç†å¿µ
```
ä¸æ˜¯"ä¸€æ¬¡è§„åˆ’å…¨éƒ¨"ï¼Œä¹Ÿä¸æ˜¯"å•æ­¥å¾ªç¯"
è€Œæ˜¯"åˆ†æ‰¹è§„åˆ’-æ‰¹é‡æ‰§è¡Œ-é˜¶æ®µæ€»ç»“"çš„å¾ªç¯

æ¯è½®ï¼š
  Plan  â†’ è§„åˆ’1-8ä¸ªæ­¥éª¤
  Execute â†’ æ‰¹é‡æ‰§è¡Œè¿™äº›æ­¥éª¤
  Think â†’ æ€»ç»“æœ¬è½®ï¼Œåˆ¤æ–­æ˜¯å¦ç»§ç»­
```

---

## ğŸ”„ å®Œæ•´æµç¨‹å›¾

```
å¼€å§‹ä»»åŠ¡
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆå§‹åŒ–ï¼šrounds = 0, task_completed = False  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¤§å¾ªç¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  rounds++                               â”‚                 â”‚
â”‚  â”‚  åˆ¤æ–­ï¼šrounds > max_rounds (3-5) ?      â”‚                 â”‚
â”‚  â”‚    - æ˜¯ â†’ è·³å‡ºå¾ªç¯åˆ°ã€å¼ºåˆ¶æ€»ç»“ã€‘         â”‚                 â”‚
â”‚  â”‚    - å¦ â†’ ç»§ç»­                          â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚     â†“                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  ğŸ¯ Plané˜¶æ®µï¼ˆå¼ºåˆ¶è°ƒç”¨ï¼‰                 â”‚                 â”‚
â”‚  â”‚                                         â”‚                 â”‚
â”‚  â”‚  tool_choice = {                        â”‚                 â”‚
â”‚  â”‚    "type": "function",                  â”‚                 â”‚
â”‚  â”‚    "function": {                        â”‚                 â”‚
â”‚  â”‚      "name": "plan_tool_call"           â”‚                 â”‚
â”‚  â”‚    }                                    â”‚                 â”‚
â”‚  â”‚  }                                      â”‚                 â”‚
â”‚  â”‚                                         â”‚                 â”‚
â”‚  â”‚  è¿”å›ç»“æœï¼š                              â”‚                 â”‚
â”‚  â”‚  {                                      â”‚                 â”‚
â”‚  â”‚    "steps": [                           â”‚                 â”‚
â”‚  â”‚      {"tool":"read_file","args":{...}}, â”‚                 â”‚
â”‚  â”‚      {"tool":"edit_file","args":{...}}, â”‚                 â”‚
â”‚  â”‚      ...  // 1-8ä¸ªæ­¥éª¤                   â”‚                 â”‚
â”‚  â”‚    ],                                   â”‚                 â”‚
â”‚  â”‚    "reasoning": "è®¡åˆ’è¯´æ˜"               â”‚                 â”‚
â”‚  â”‚  }                                      â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚     â†“                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  ğŸ”§ Executeé˜¶æ®µï¼ˆæ‰¹é‡æ‰§è¡Œï¼‰              â”‚                 â”‚
â”‚  â”‚                                         â”‚                 â”‚
â”‚  â”‚  for step in plan.steps:                â”‚                 â”‚
â”‚  â”‚    result = execute_tool(               â”‚                 â”‚
â”‚  â”‚      tool_name=step.tool,               â”‚                 â”‚
â”‚  â”‚      arguments=step.args                â”‚                 â”‚
â”‚  â”‚    )                                    â”‚                 â”‚
â”‚  â”‚    messages.append({                    â”‚                 â”‚
â”‚  â”‚      "role": "tool",                    â”‚                 â”‚
â”‚  â”‚      "content": result                  â”‚                 â”‚
â”‚  â”‚    })                                   â”‚                 â”‚
â”‚  â”‚                                         â”‚                 â”‚
â”‚  â”‚  æ‰§è¡Œå®Œæ¯•ï¼š1-8ä¸ªå·¥å…·                     â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚     â†“                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  ğŸ’­ Thinké˜¶æ®µï¼ˆå¼ºåˆ¶è°ƒç”¨ï¼‰                â”‚                 â”‚
â”‚  â”‚                                         â”‚                 â”‚
â”‚  â”‚  tool_choice = {                        â”‚                 â”‚
â”‚  â”‚    "type": "function",                  â”‚                 â”‚
â”‚  â”‚    "function": {                        â”‚                 â”‚
â”‚  â”‚      "name": "think"                    â”‚                 â”‚
â”‚  â”‚    }                                    â”‚                 â”‚
â”‚  â”‚  }                                      â”‚                 â”‚
â”‚  â”‚                                         â”‚                 â”‚
â”‚  â”‚  è¿”å›ç»“æœï¼ˆåŒé‡è¾“å‡ºï¼‰ï¼š                   â”‚                 â”‚
â”‚  â”‚  {                                      â”‚                 â”‚
â”‚  â”‚    "internal_analysis": "å†…éƒ¨åˆ†æ...",  â”‚ â† ç³»ç»Ÿå†…éƒ¨ç”¨    â”‚
â”‚  â”‚    "user_summary": "æœ¬è½®å®Œæˆäº†XX...",   â”‚ â† ç”¨æˆ·å¯è§     â”‚
â”‚  â”‚    "task_completed": true/false,       â”‚                 â”‚
â”‚  â”‚    "next_steps_preview": "ä¸‹ä¸€è½®..."    â”‚                 â”‚
â”‚  â”‚  }                                      â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚     â†“                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  ä¿å­˜ last_think_summary                â”‚                 â”‚
â”‚  â”‚  = think_result.user_summary            â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚     â†“                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  åˆ¤æ–­ï¼štask_completed == true ?         â”‚                 â”‚
â”‚  â”‚    - æ˜¯ â†’ è·³å‡ºå¾ªç¯                       â”‚                 â”‚
â”‚  â”‚    - å¦ â†’ å›åˆ°å¾ªç¯å¼€å¤´ï¼ˆä¸‹ä¸€è½®Planï¼‰     â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚     â†‘                                                         â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç»§ç»­ä¸‹ä¸€è½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é€€å‡ºå¾ªç¯åï¼ˆå…³é”®ï¼ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                â”‚
â”‚  æ£€æŸ¥ï¼šæ˜¯å¦æœ‰ last_think_summary ï¼Ÿ                            â”‚
â”‚     â†“                              â†“                          â”‚
â”‚  ã€æœ‰ã€‘                        ã€æ— /ä¸ºç©ºã€‘                      â”‚
â”‚     â†“                              â†“                          â”‚
â”‚  ç›´æ¥è¿”å›                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  last_think_summary         â”‚  ğŸ”’ å…œåº•æ€»ç»“æœºåˆ¶        â”‚        â”‚
â”‚  ç»™ç”¨æˆ·                     â”‚                        â”‚        â”‚
â”‚     â†“                       â”‚  å¼ºåˆ¶è°ƒç”¨LLMï¼š          â”‚        â”‚
â”‚  âœ… ç”¨æˆ·æ”¶åˆ°æ–‡å­—            â”‚  messages.append({     â”‚        â”‚
â”‚                             â”‚    "role": "user",     â”‚        â”‚
â”‚                             â”‚    "content": "è¯·æ€»ç»“" â”‚        â”‚
â”‚                             â”‚  })                    â”‚        â”‚
â”‚                             â”‚                        â”‚        â”‚
â”‚                             â”‚  llm.chat(             â”‚        â”‚
â”‚                             â”‚    messages,           â”‚        â”‚
â”‚                             â”‚    tools=None,  â† å…³é”® â”‚        â”‚
â”‚                             â”‚    tool_choice="none"  â”‚        â”‚
â”‚                             â”‚  )                     â”‚        â”‚
â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                      â†“                        â”‚
â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚                             â”‚  è¿”å›çº¯æ–‡æœ¬æ€»ç»“ç»™ç”¨æˆ·   â”‚        â”‚
â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                      â†“                        â”‚
â”‚                                 âœ… ç”¨æˆ·æ”¶åˆ°æ–‡å­—               â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‰ ä¿è¯ï¼šç”¨æˆ·å¿…å®šæ”¶åˆ°æœ€ç»ˆæ–‡å­—æ€»ç»“        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» å®ç°è¦ç‚¹

### 1. tool_choiceç²¾ç¡®æŒ‡å®šï¼ˆP0 - å¿…é¡»ç«‹å³ä¿®å¤ï¼‰

**é—®é¢˜ä»£ç ï¼ˆcore/agent.py ç¬¬81è¡Œï¼‰ï¼š**
```python
tool_choice = "required"  # âŒ ä¸æŒ‡å®šå·¥å…·åï¼ŒLLMä¼šä¹±é€‰
```

**ä¿®å¤åï¼š**
```python
tool_choice = {
    "type": "function",
    "function": {"name": "plan_tool_call"}
}
# âœ… å¼ºåˆ¶åªèƒ½è°ƒç”¨plan_tool_call
```

**åŒç†ï¼ŒThinké˜¶æ®µï¼š**
```python
tool_choice = {
    "type": "function",
    "function": {"name": "think"}
}
```

---

### 2. Planå·¥å…·è¿”å›æ‰¹é‡æ­¥éª¤

```python
# plan_tool_call çš„è¿”å›æ ¼å¼
{
    "steps": [
        {
            "tool": "read_file",
            "arguments": {"path": "config.py"}
        },
        {
            "tool": "edit_file",
            "arguments": {"path": "config.py", ...}
        },
        ...  // æœ€å¤š8ä¸ªæ­¥éª¤
    ],
    "reasoning": "æˆ‘è®¡åˆ’å…ˆè¯»å–é…ç½®æ–‡ä»¶ï¼Œç„¶åä¿®æ”¹ç«¯å£å·...",
    "estimated_steps": 3
}
```

---

### 3. Thinkå·¥å…·åŒé‡è¾“å‡º

```python
# think å·¥å…·çš„è¿”å›æ ¼å¼
{
    "internal_analysis": "æ‰§è¡Œäº†3ä¸ªæ­¥éª¤ï¼šè¯»å–ã€ä¿®æ”¹ã€éªŒè¯ã€‚é…ç½®æ–‡ä»¶å·²æˆåŠŸæ›´æ–°ã€‚",
    "user_summary": "âœ… å·²æˆåŠŸå°†ç«¯å£å·ä¿®æ”¹ä¸º8080ï¼Œé…ç½®æ–‡ä»¶å·²æ›´æ–°ã€‚",
    "task_completed": true,
    "next_steps_preview": "æ— éœ€åç»­æ“ä½œ"
}
```

**å…³é”®**ï¼š`user_summary` æ˜¯å¿…å¡«é¡¹ï¼Œå¿…å®šæœ‰ç»™ç”¨æˆ·çš„æ–‡å­—ï¼

---

### 4. å¾ªç¯æ§åˆ¶é€»è¾‘

```python
async def run(self, user_message, context_history):
    rounds = 0
    max_rounds = 5  # æœ€å¤š5è½®
    task_completed = False
    last_think_summary = None
    
    # ========== Plan-Execute-Think å¾ªç¯ ==========
    while not task_completed and rounds < max_rounds:
        rounds += 1
        print(f"\n{'='*60}")
        print(f"ç¬¬ {rounds} è½®å¾ªç¯")
        print(f"{'='*60}")
        
        # 1ï¸âƒ£ Plané˜¶æ®µ
        plan_response = self.llm_service.chat(
            messages,
            tools=[plan_tool],  # åªç»™planå·¥å…·
            tool_choice={"type":"function","function":{"name":"plan_tool_call"}}
        )
        plan = parse_plan(plan_response)
        
        # 2ï¸âƒ£ Executeé˜¶æ®µï¼ˆæ‰¹é‡ï¼‰
        for step in plan.steps:
            result = await execute_tool(step.tool, step.arguments)
            messages.append({
                "role": "tool",
                "content": json.dumps(result)
            })
        
        # 3ï¸âƒ£ Thinké˜¶æ®µ
        think_response = self.llm_service.chat(
            messages,
            tools=[think_tool],  # åªç»™thinkå·¥å…·
            tool_choice={"type":"function","function":{"name":"think"}}
        )
        think_result = parse_think(think_response)
        
        # ä¿å­˜ç”¨æˆ·å¯è§æ€»ç»“
        last_think_summary = think_result.user_summary
        
        # åˆ¤æ–­æ˜¯å¦å®Œæˆ
        if think_result.task_completed:
            task_completed = True
            break
    
    # ========== å¼ºåˆ¶ä¿è¯æœ‰æ€»ç»“ ==========
    if last_think_summary and last_think_summary.strip():
        final_message = last_think_summary
    else:
        # å…œåº•ï¼šå¼ºåˆ¶æ€»ç»“
        final_message = await self._force_summarize(messages)
    
    return {
        "success": True,
        "message": final_message,  # â† å¿…å®šæœ‰æ–‡å­—
        "rounds": rounds,
        ...
    }

async def _force_summarize(self, messages):
    """å…œåº•æœºåˆ¶ï¼šå¼ºåˆ¶ç”Ÿæˆæ€»ç»“"""
    summary_response = self.llm_service.chat(
        messages=messages + [{
            "role": "user",
            "content": "è¯·ç”¨ç®€æ´çš„è¯­è¨€æ€»ç»“æ•´ä¸ªä»»åŠ¡çš„æ‰§è¡Œç»“æœ"
        }],
        tools=None,  # â† ä¸ä¼ å·¥å…·
        tool_choice="none"  # â† ç¦æ­¢å·¥å…·è°ƒç”¨
    )
    return summary_response.get("content", "ä»»åŠ¡æ‰§è¡Œå®Œæˆ")
```

---

## ğŸ“Š å‚æ•°é…ç½®

### å»ºè®®çš„è½®æ¬¡ä¸æ­¥éª¤é…ç½®

| ä»»åŠ¡å¤æ‚åº¦ | max_rounds | steps_per_round | æ€»è¿­ä»£ä¸Šé™ | é€‚ç”¨åœºæ™¯ |
|-----------|-----------|-----------------|-----------|----------|
| ç®€å• | 2 | 3-5 | ~10 | æŸ¥çœ‹æ–‡ä»¶ã€ç®€å•ä¿®æ”¹ |
| ä¸­ç­‰ | 3 | 5-8 | ~24 | ä»£ç é‡æ„ã€é…ç½®ä¿®æ”¹ |
| å¤æ‚ | 5 | 6-8 | ~40 | æ¶æ„è°ƒæ•´ã€å¤æ‚è°ƒè¯• |

---

## âœ… å…³é”®ä¿è¯æœºåˆ¶

### 1. å¼ºåˆ¶æŒ‡å®šå·¥å…·ï¼ˆè§£å†³ä¹±è°ƒç”¨ï¼‰
```python
tool_choice = {
    "type": "function",
    "function": {"name": "å…·ä½“å·¥å…·å"}
}
```

### 2. Thinkå¿…é¡»è¾“å‡ºuser_summaryï¼ˆä¿è¯æœ‰æ–‡å­—ï¼‰
```python
{
    "name": "think",
    "parameters": {
        "user_summary": {
            "type": "string",
            "description": "ç»™ç”¨æˆ·çš„æ€»ç»“ï¼ˆå¿…å¡«ï¼‰",
            "required": true  # â† å¿…å¡«
        },
        ...
    }
}
```

### 3. å…œåº•æ€»ç»“æœºåˆ¶ï¼ˆç»ˆæä¿é™©ï¼‰
```python
# å¦‚æœæ²¡æœ‰user_summaryï¼Œå¼ºåˆ¶è°ƒç”¨
if not last_think_summary:
    final_message = force_summarize(
        messages,
        tools=None,  # â† ä¸ç»™å·¥å…·
        tool_choice="none"  # â† ç¦æ­¢å·¥å…·
    )
```

---

## ğŸ¨ å®æˆ˜ç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·è¯·æ±‚"ä¿®æ”¹UIé¢œè‰²ä¸ºç´«è‰²ç³»"

```
ã€ç¬¬1è½®ã€‘Plan-Execute-Think
  
  ğŸ¯ Plan:
    steps: [
      {tool: "read_file", args: {path: "ui/index.html"}},
      {tool: "search_code", args: {query: "color|background", path: "ui/index.html"}}
    ]
    reasoning: "å…ˆè¯»å–UIæ–‡ä»¶ï¼Œæœç´¢æ‰€æœ‰é¢œè‰²å®šä¹‰"
  
  ğŸ”§ Execute:
    â†’ read_file æ‰§è¡Œ âœ…
    â†’ search_code æ‰§è¡Œ âœ… (æ‰¾åˆ°12å¤„é¢œè‰²)
  
  ğŸ’­ Think:
    internal_analysis: "å·²æ‰¾åˆ°12å¤„é¢œè‰²å®šä¹‰ï¼Œåˆ†å¸ƒåœ¨bodyã€containerç­‰å…ƒç´ "
    user_summary: "å·²å®šä½åˆ°12å¤„éœ€è¦ä¿®æ”¹çš„é¢œè‰²"
    task_completed: false
    next_steps_preview: "ä¸‹ä¸€è½®å°†æ‰¹é‡ä¿®æ”¹è¿™äº›é¢œè‰²"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ã€ç¬¬2è½®ã€‘Plan-Execute-Think
  
  ğŸ¯ Plan:
    steps: [
      {tool: "edit_file", args: {path: "ui/index.html", old: "#ff6b6b", new: "#667eea"}},
      {tool: "edit_file", args: {path: "ui/index.html", old: "#4ecdc4", new: "#764ba2"}},
      ...  // å…±5ä¸ªeditæ“ä½œ
    ]
    reasoning: "æ‰¹é‡æ›¿æ¢æ‰€æœ‰é¢œè‰²ä¸ºç´«è‰²ç³»"
  
  ğŸ”§ Execute:
    â†’ edit_file Ã— 5 å…¨éƒ¨æ‰§è¡Œ âœ…
  
  ğŸ’­ Think:
    internal_analysis: "å·²å®Œæˆæ‰€æœ‰é¢œè‰²æ›¿æ¢ï¼ŒUIå·²æ›´æ–°ä¸ºç´«è‰²æ¸å˜ä¸»é¢˜"
    user_summary: "âœ… å·²æˆåŠŸå°†UIé¢œè‰²ä¿®æ”¹ä¸ºç´«è‰²ç³»ï¼ˆ#667eea â†’ #764ba2æ¸å˜ï¼‰ï¼Œå…±ä¿®æ”¹12å¤„"
    task_completed: true  â† ä»»åŠ¡å®Œæˆ

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ã€é€€å‡ºå¾ªç¯ã€‘
  æ£€æŸ¥ï¼šlast_think_summary = "âœ… å·²æˆåŠŸå°†UIé¢œè‰²..."
  è¿”å›ç»™ç”¨æˆ·ï¼š"âœ… å·²æˆåŠŸå°†UIé¢œè‰²ä¿®æ”¹ä¸ºç´«è‰²ç³»..."
  
ç”¨æˆ·æ”¶åˆ°ï¼šå®Œæ•´çš„æ‰§è¡Œæ€»ç»“ âœ…
```

---

## ğŸ”¢ æ•ˆç‡å¯¹æ¯”

### Tokenæ¶ˆè€—å¯¹æ¯”

| æ¨¡å¼ | LLMè°ƒç”¨æ¬¡æ•° | é¢„ä¼°Token | æ—¶é—´ |
|------|-----------|-----------|------|
| å½“å‰ï¼ˆ30æ¬¡å•æ­¥è¿­ä»£ï¼‰ | 30æ¬¡ | 300K | 120ç§’ |
| æ‰¹é‡å¾ªç¯ï¼ˆ2è½®ï¼‰ | 6æ¬¡ (PlanÃ—2 + ExeÃ—0 + ThinkÃ—2) | 50K | 30ç§’ |
| trae-agentï¼ˆ20æ¬¡ReActï¼‰ | 20æ¬¡ | 200K | 80ç§’ |

**æ‰¹é‡å¾ªç¯æ•ˆç‡æå‡6å€ï¼** ğŸš€

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Planå·¥å…·é™åˆ¶æ­¥éª¤æ•°
```python
# Planè¿”å›çš„stepsä¸èƒ½è¶…è¿‡8ä¸ª
if len(plan.steps) > 8:
    return error("æ¯è½®æœ€å¤šè§„åˆ’8ä¸ªæ­¥éª¤")
```

### 2. å¼‚å¸¸å¤„ç†
```python
# Executeé˜¶æ®µæŸä¸ªå·¥å…·å¤±è´¥
if tool_result.success == False:
    # ç«‹å³è¿›å…¥Thinkï¼Œè®©LLMå†³å®šï¼š
    # - é‡è¯•ï¼Ÿ
    # - è°ƒæ•´è®¡åˆ’ï¼Ÿ
    # - æ”¾å¼ƒï¼Ÿ
```

### 3. è¶…æ—¶ä¿æŠ¤
```python
# å•è½®æ‰§è¡Œæ—¶é—´è¿‡é•¿
if round_time > 60ç§’:
    å¼ºåˆ¶è¿›å…¥Thinkæ€»ç»“
```

---

## ğŸš€ å®æ–½æ­¥éª¤

### Phase 1: ä¿®å¤å½“å‰bugï¼ˆ1å¤©ï¼‰
- [ ] ä¿®æ”¹tool_choiceä¸ºç²¾ç¡®æŒ‡å®š
- [ ] æ·»åŠ å…œåº•æ€»ç»“æœºåˆ¶
- [ ] æµ‹è¯•éªŒè¯

### Phase 2: å®ç°æ‰¹é‡å¾ªç¯ï¼ˆ2å¤©ï¼‰
- [ ] Planå·¥å…·æ”¯æŒæ‰¹é‡æ­¥éª¤
- [ ] Thinkå·¥å…·åŒé‡è¾“å‡º
- [ ] å¾ªç¯æ§åˆ¶é€»è¾‘
- [ ] å‰ç«¯è¿›åº¦å±•ç¤º

### Phase 3: ä¼˜åŒ–å®Œå–„ï¼ˆ3å¤©ï¼‰
- [ ] æ™ºèƒ½æ­¥éª¤æ•°å»ºè®®
- [ ] å¼‚å¸¸å¤„ç†ä¸é‡è¯•
- [ ] æ€§èƒ½ç›‘æ§
- [ ] ç”¨æˆ·ä½“éªŒä¼˜åŒ–

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

âœ… **å·¥å…·è°ƒç”¨å¯æ§**ï¼šæ¯è½®æœ€å¤š8ä¸ªï¼Œæ€»å…±å¯æ§  
âœ… **å¿…å®šæœ‰æ€»ç»“**ï¼šThink + å…œåº•åŒä¿é™©  
âœ… **æ•ˆç‡æå‡**ï¼šå‡å°‘60-80% tokenæ¶ˆè€—  
âœ… **ç”¨æˆ·ä½“éªŒå¥½**ï¼šåˆ†é˜¶æ®µå±•ç¤ºè¿›å±•  
âœ… **çµæ´»æ€§å¼º**ï¼šå¯æ ¹æ®ç»“æœåŠ¨æ€è°ƒæ•´è®¡åˆ’

---

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

- [ ] å¹³å‡è¿­ä»£æ¬¡æ•°ä»30é™åˆ°8ä»¥å†…
- [ ] 100%çš„å¯¹è¯éƒ½æœ‰ç”¨æˆ·å¯è§æ€»ç»“
- [ ] Tokenæ¶ˆè€—é™ä½70%
- [ ] ä»»åŠ¡å®Œæˆç‡æå‡åˆ°85%+
- [ ] ç”¨æˆ·æ»¡æ„åº¦æå‡

---

## ç›¸å…³æ–‡æ¡£

- [Contextç®¡ç†ç­–ç•¥](./context_tool_strategy.md)
- [å·¥å…·è°ƒç”¨é—®é¢˜åˆ†æ](./FunctionCallingè§„åˆ’è€…æ¨¡å¼é—®é¢˜.md)

