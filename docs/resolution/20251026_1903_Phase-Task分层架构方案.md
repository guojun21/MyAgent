# Phase-Task åˆ†å±‚æ¶æ„æ–¹æ¡ˆ

> åˆ›å»ºæ—¶é—´ï¼š2025-10-26 19:03  
> çŠ¶æ€ï¼šå¾…å®æ–½  
> ä¼˜å…ˆçº§ï¼šP1ï¼ˆä¸­é«˜ä¼˜å…ˆçº§ï¼‰  
> å®æ–½å‘¨æœŸï¼š3-6å¤©

---

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

**æ ¸å¿ƒç†å¿µ**ï¼šå¼•å…¥"Phaseï¼ˆé˜¶æ®µï¼‰- Taskï¼ˆä»»åŠ¡ï¼‰- Toolï¼ˆå·¥å…·ï¼‰"ä¸‰å±‚æ¶æ„ï¼Œå®ç°å¤§å‹å¤æ‚ä»»åŠ¡çš„åˆ†å±‚ç®¡ç†å’Œç²¾å‡†æ§åˆ¶ã€‚

### ä¸‰å±‚æ¶æ„

```
Requestï¼ˆç”¨æˆ·éœ€æ±‚ï¼‰
   â†“
Phaseï¼ˆæ‰§è¡Œé˜¶æ®µï¼‰
   â†“
Taskï¼ˆå…·ä½“ä»»åŠ¡ï¼‰
   â†“
Toolï¼ˆå·¥å…·è°ƒç”¨ï¼‰
```

---

## ğŸ¯ è§£å†³çš„æ ¸å¿ƒé—®é¢˜

### å½“å‰ç—›ç‚¹

1. **æ— æ³•å¤„ç†å¤æ‚ä»»åŠ¡**  
   "é‡æ„æ•´ä¸ªè®¤è¯ç³»ç»Ÿ" â†’ ä¸€æ¬¡æ€§è§„åˆ’æ‰€æœ‰æ­¥éª¤ â†’ æ— æ³•åŠ¨æ€è°ƒæ•´

2. **æ‰§è¡Œå¤±è´¥éš¾æ¢å¤**  
   30ä¸ªæ­¥éª¤ä¸­ç¬¬15ä¸ªå¤±è´¥ â†’ ä¸çŸ¥é“å“ªä¸ªå¤±è´¥ â†’ å…¨éƒ¨é‡æ¥

3. **ç¼ºä¹è¿›åº¦å¯è§†åŒ–**  
   ç”¨æˆ·ä¸çŸ¥é“æ‰§è¡Œåˆ°å“ªä¸€æ­¥ â†’ ç„¦è™‘ç­‰å¾…

4. **æ— æ³•è¯„ä¼°å®Œæˆåº¦**  
   "æˆ‘è§‰å¾—å®Œæˆäº†" â†’ ä¸»è§‚åˆ¤æ–­ â†’ å®é™…å¯èƒ½æ¼åš

---

## ğŸ—ï¸ å®Œæ•´æ¶æ„è®¾è®¡

### å±‚çº§1ï¼šPhase Planningï¼ˆé˜¶æ®µè§„åˆ’ï¼‰

```
è¾“å…¥ï¼šç”¨æˆ·éœ€æ±‚

å·¥å…·ï¼šphase_planner
tool_choice = {
    "type": "function",
    "function": {"name": "phase_planner"}
}

è¿”å›æ ¼å¼ï¼š
{
    "complexity_analysis": {
        "score": 8.5,  // 1-10åˆ†
        "category": "complex",  // simple/medium/complex
        "reasoning": "æ¶‰åŠå¤šæ¨¡å—ä¿®æ”¹å’Œæ¶æ„è°ƒæ•´"
    },
    "needs_phases": true,
    "phases": [
        {
            "id": 1,
            "name": "ä»£ç ç†è§£ä¸åˆ†æ",
            "goal": "ç†è§£ç°æœ‰è®¤è¯æ¶æ„å’Œæµç¨‹",
            "estimated_tasks": 5,
            "estimated_tokens": 20000,
            "estimated_time": 30,  // ç§’
            "priority": "high"
        },
        {
            "id": 2,
            "name": "è®¤è¯æ¨¡å—é‡æ„",
            "goal": "é‡æ„è®¤è¯é€»è¾‘ï¼Œæå–å…¬å…±ä»£ç ",
            "estimated_tasks": 12,
            "estimated_tokens": 50000,
            "estimated_time": 90,
            "dependencies": [1]  // ä¾èµ–Phase 1
        },
        {
            "id": 3,
            "name": "OAuthé›†æˆ",
            "goal": "æ·»åŠ ç¬¬ä¸‰æ–¹ç™»å½•æ”¯æŒ",
            "estimated_tasks": 8,
            "estimated_tokens": 30000,
            "estimated_time": 60,
            "dependencies": [2]
        }
    ],
    "total_estimated_time": 180,  // æ€»é¢„ä¼°æ—¶é—´
    "total_estimated_cost": 0.18   // æ€»é¢„ä¼°æˆæœ¬
}
```

**åˆ¤æ–­é€»è¾‘**ï¼š
```python
if complexity_score < 4:
    # ç®€å•ä»»åŠ¡ï¼šè·³è¿‡Phaseï¼Œç›´æ¥Task
    needs_phases = False
elif complexity_score < 7:
    # ä¸­ç­‰ä»»åŠ¡ï¼šå¯é€‰Phase
    needs_phases = True, phases = 1-2ä¸ª
else:
    # å¤æ‚ä»»åŠ¡ï¼šå¿…é¡»Phase
    needs_phases = True, phases = 2-5ä¸ª
```

---

### å±‚çº§2ï¼šTask Planningï¼ˆä»»åŠ¡è§„åˆ’ï¼‰

```
è¾“å…¥ï¼šPhaseç›®æ ‡

å·¥å…·ï¼šplan_tool_callï¼ˆæ”¹è¿›ç‰ˆï¼‰
tool_choice = {
    "type": "function",
    "function": {"name": "plan_tool_call"}
}

è¿”å›æ ¼å¼ï¼š
{
    "tasks": [
        {
            "id": 1,
            "title": "è¯»å–auth/login.pyæ–‡ä»¶",
            "description": "è¯»å–ç™»å½•æ¨¡å—ä»£ç ï¼Œç†è§£ç°æœ‰æµç¨‹",
            "tool": "read_file",
            "arguments": {
                "path": "auth/login.py"
            },
            "status": "pending",
            "priority": 10,  // 1-10ï¼Œæ•°å­—è¶Šå¤§è¶Šä¼˜å…ˆ
            "dependencies": [],  // ä¾èµ–çš„Task ID
            "estimated_tokens": 2000,
            "timeout": 30  // è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
        },
        {
            "id": 2,
            "title": "æœç´¢æ‰€æœ‰è®¤è¯ç›¸å…³å‡½æ•°",
            "description": "åœ¨é¡¹ç›®ä¸­æœç´¢authenticateã€loginç­‰å…³é”®å‡½æ•°",
            "tool": "search_code",
            "arguments": {
                "query": "authenticate|login|verify",
                "regex": true
            },
            "status": "pending",
            "priority": 9,
            "dependencies": [1],  // ä¾èµ–Task 1
            "estimated_tokens": 3000,
            "timeout": 45
        },
        ...  // æœ€å¤š8ä¸ªTasks
    ],
    "plan_reasoning": "å…ˆè¯»å–ä¸»æ–‡ä»¶ç†è§£ç»“æ„ï¼Œå†æœç´¢ç›¸å…³å‡½æ•°å®šä½æ‰€æœ‰è®¤è¯é€»è¾‘ï¼Œæœ€å..."
}
```

**TaskçŠ¶æ€æœº**ï¼š
```
pending â†’ running â†’ done
              â†“
            failed â†’ retry â†’ done/abandoned
```

---

### å±‚çº§3ï¼šTask Executionï¼ˆä»»åŠ¡æ‰§è¡Œï¼‰

```python
async def execute_tasks(tasks):
    """æ‰¹é‡æ‰§è¡ŒTasks"""
    results = []
    
    # æŒ‰ä¼˜å…ˆçº§å’Œä¾èµ–å…³ç³»æ’åº
    sorted_tasks = topological_sort(tasks)
    
    for task in sorted_tasks:
        # æ£€æŸ¥ä¾èµ–
        if not all_dependencies_completed(task):
            task.status = "blocked"
            continue
        
        # æ‰§è¡Œ
        task.status = "running"
        result = await execute_tool(
            task.tool,
            task.arguments,
            timeout=task.timeout
        )
        
        # æ›´æ–°çŠ¶æ€
        if result.success:
            task.status = "done"
            task.actual_result = result
        else:
            task.status = "failed"
            task.error_message = result.error
        
        results.append({
            "task_id": task.id,
            "task_title": task.title,
            "status": task.status,
            "result": result
        })
    
    return results
```

---

### å±‚çº§4ï¼šJudge Evaluationï¼ˆå®¢è§‚è¯„åˆ¤ï¼‰

```
è¾“å…¥ï¼šTasks + æ‰§è¡Œç»“æœ

å·¥å…·ï¼šjudge_tool
tool_choice = {
    "type": "function",
    "function": {"name": "judge_tasks"}
}

è¿”å›æ ¼å¼ï¼š
{
    "task_evaluation": [
        {
            "task_id": 1,
            "status": "done",
            "quality_score": 9.5,  // æ‰§è¡Œè´¨é‡è¯„åˆ†
            "output_valid": true,
            "notes": "æ–‡ä»¶è¯»å–æˆåŠŸï¼Œå†…å®¹å®Œæ•´"
        },
        {
            "task_id": 2,
            "status": "done",
            "quality_score": 8.0,
            "output_valid": true,
            "notes": "æ‰¾åˆ°7ä¸ªç›¸å…³å‡½æ•°"
        },
        {
            "task_id": 3,
            "status": "failed",
            "quality_score": 0,
            "output_valid": false,
            "notes": "å·¥å…·æ‰§è¡Œå¤±è´¥ï¼Œè·¯å¾„ä¸å­˜åœ¨"
        }
    ],
    "phase_metrics": {
        "completion_rate": 0.67,  // å®Œæˆç‡
        "success_rate": 0.67,     // æˆåŠŸç‡
        "quality_average": 5.83   // å¹³å‡è´¨é‡
    },
    "phase_should_end": false,
    "decision": {
        "action": "retry_with_adjustment",  // continue/retry/replan/end
        "reason": "Task 3å¤±è´¥éœ€è¦ä¿®æ­£å‚æ•°",
        "failed_tasks_to_retry": [3],
        "suggested_adjustments": {
            "task_id": 3,
            "new_arguments": {"path": "auth/utils.py"}  // å»ºè®®çš„ä¿®æ­£
        }
    },
    "phase_plan_quality": {
        "score": 8.0,
        "needs_revision": false,
        "revision_reason": null
    }
}
```

---

### å±‚çº§5ï¼šThink Analysisï¼ˆä¸»è§‚åˆ†æï¼‰

```
è¾“å…¥ï¼šJudgeç»“æœ

å·¥å…·ï¼šthink_tool

è¿”å›æ ¼å¼ï¼š
{
    "internal_analysis": "æœ¬è½®æ‰§è¡Œäº†3ä¸ªä»»åŠ¡ï¼Œ2ä¸ªæˆåŠŸ1ä¸ªå¤±è´¥ã€‚å¤±è´¥åŸå› æ˜¯è·¯å¾„é”™è¯¯ï¼Œå·²åœ¨Judgeä¸­è¯†åˆ«å¹¶æä¾›ä¿®æ­£å»ºè®®ã€‚",
    "user_summary": "ğŸ“Š Phaseè¿›åº¦ï¼šå·²å®Œæˆ2/3ä»»åŠ¡\nâœ… æˆåŠŸè¯»å–ç™»å½•æ¨¡å—\nâœ… æ‰¾åˆ°7ä¸ªè®¤è¯å‡½æ•°\nâŒ Task 3å¤±è´¥ï¼ˆè·¯å¾„é”™è¯¯ï¼‰ï¼Œå°†åœ¨ä¸‹ä¸€è½®ä¿®æ­£",
    "continue_phase": true,
    "next_round_strategy": "é‡è¯•Task 3ï¼Œä½¿ç”¨ä¿®æ­£åçš„è·¯å¾„"
}
```

---

## ğŸ”„ å®Œæ•´æ‰§è¡Œæµç¨‹

```
ç”¨æˆ·è¯·æ±‚ï¼š"é‡æ„è®¤è¯ç³»ç»Ÿå¹¶æ·»åŠ OAuth"
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” Phase Planning                           â”‚
â”‚  å¤æ‚åº¦åˆ†æ â†’ 8.5/10 (å¤æ‚)                  â”‚
â”‚  å†³å®šï¼šåˆ’åˆ†ä¸º3ä¸ªPhase                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Phase 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¯ åç§°ï¼šä»£ç ç†è§£ä¸åˆ†æ                          â”‚
â”‚ ğŸ¯ ç›®æ ‡ï¼šç†è§£ç°æœ‰è®¤è¯æ¶æ„                        â”‚
â”‚                                                 â”‚
â”‚  ã€Round 1.1ã€‘                                  â”‚
â”‚  â”œâ”€ Plan â†’ è§„åˆ’5ä¸ªTasks                         â”‚
â”‚  â”œâ”€ Execute â†’ æ‰§è¡ŒTasks 1-5                     â”‚
â”‚  â”œâ”€ Judge â†’ è¯„åˆ¤ï¼š5/5å®Œæˆ âœ…                    â”‚
â”‚  â””â”€ Think â†’ "å·²ç†è§£æ¶æ„ï¼Œå¯è¿›å…¥é‡æ„"             â”‚
â”‚      phase_should_end: true                     â”‚
â”‚                                                 â”‚
â”‚  Phase 1 å®Œæˆ âœ…                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Phase 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¯ åç§°ï¼šè®¤è¯æ¨¡å—é‡æ„                            â”‚
â”‚ ğŸ¯ ç›®æ ‡ï¼šé‡æ„è®¤è¯é€»è¾‘                            â”‚
â”‚                                                 â”‚
â”‚  ã€Round 2.1ã€‘                                  â”‚
â”‚  â”œâ”€ Plan â†’ è§„åˆ’8ä¸ªTasks                         â”‚
â”‚  â”œâ”€ Execute â†’ æ‰§è¡ŒTasks 1-8                     â”‚
â”‚  â”œâ”€ Judge â†’ è¯„åˆ¤ï¼š7/8å®Œæˆï¼ŒTask 5å¤±è´¥ âŒ         â”‚
â”‚  â””â”€ Think â†’ "éœ€è¦ä¿®æ­£Task 5å¹¶é‡è¯•"              â”‚
â”‚      phase_should_end: false                    â”‚
â”‚                                                 â”‚
â”‚  ã€Round 2.2ã€‘                                  â”‚
â”‚  â”œâ”€ Plan â†’ é‡æ–°è§„åˆ’Task 5                       â”‚
â”‚  â”œâ”€ Execute â†’ æ‰§è¡ŒTask 5                        â”‚
â”‚  â”œâ”€ Judge â†’ è¯„åˆ¤ï¼š1/1å®Œæˆ âœ…                    â”‚
â”‚  â””â”€ Think â†’ "é‡æ„å®Œæˆ"                          â”‚
â”‚      phase_should_end: true                     â”‚
â”‚                                                 â”‚
â”‚  Phase 2 å®Œæˆ âœ…                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Phase 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¯ åç§°ï¼šOAuthé›†æˆ                              â”‚
â”‚ ğŸ¯ ç›®æ ‡ï¼šæ·»åŠ ç¬¬ä¸‰æ–¹ç™»å½•                          â”‚
â”‚                                                 â”‚
â”‚  ã€Round 3.1ã€‘                                  â”‚
â”‚  â”œâ”€ Plan â†’ è§„åˆ’6ä¸ªTasks                         â”‚
â”‚  â”œâ”€ Execute â†’ æ‰§è¡ŒTasks 1-6                     â”‚
â”‚  â”œâ”€ Judge â†’ è¯„åˆ¤ï¼š6/6å®Œæˆ âœ…                    â”‚
â”‚  â””â”€ Think â†’ "OAuthé›†æˆå®Œæˆ"                     â”‚
â”‚      phase_should_end: true                     â”‚
â”‚                                                 â”‚
â”‚  Phase 3 å®Œæˆ âœ…                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ æœ€ç»ˆæ€»ç»“                                     â”‚
â”‚                                                 â”‚
â”‚  æ•´åˆæ‰€æœ‰Phaseçš„Thinkæ€»ç»“ï¼š                      â”‚
â”‚  "âœ… å·²å®Œæˆè®¤è¯ç³»ç»Ÿé‡æ„å’ŒOAuthé›†æˆ               â”‚
â”‚   Phase 1: ç†è§£äº†ç°æœ‰æ¶æ„ï¼ˆ5ä¸ªTasksï¼‰            â”‚
â”‚   Phase 2: é‡æ„è®¤è¯æ¨¡å—ï¼ˆ8ä¸ªTasksï¼Œ1æ¬¡é‡è¯•ï¼‰     â”‚
â”‚   Phase 3: é›†æˆOAuthæ”¯æŒï¼ˆ6ä¸ªTasksï¼‰             â”‚
â”‚   æ€»è®¡ï¼š19ä¸ªTasksï¼Œ3ä¸ªPhasesï¼Œ2ä¸ªRoundsé‡è¯•"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
è¿”å›ç»™ç”¨æˆ·
```

---

## ğŸ“Š æ•°æ®ç»“æ„è®¾è®¡

### Taskæ•°æ®ç»“æ„

```python
@dataclass
class Task:
    """å•ä¸ªä»»åŠ¡"""
    id: int
    title: str                    # "è¯»å–auth/login.py"
    description: str              # è¯¦ç»†è¯´æ˜
    tool: str                     # "read_file"
    arguments: Dict[str, Any]     # {"path": "auth/login.py"}
    
    # çŠ¶æ€ç®¡ç†
    status: str                   # pending/running/done/failed/blocked
    created_at: float
    started_at: Optional[float]
    completed_at: Optional[float]
    
    # ä¾èµ–ä¸ä¼˜å…ˆçº§
    priority: int                 # 1-10
    dependencies: List[int]       # ä¾èµ–çš„Task IDåˆ—è¡¨
    
    # æ‰§è¡Œç»“æœ
    actual_result: Optional[Dict]
    error_message: Optional[str]
    retry_count: int              # é‡è¯•æ¬¡æ•°
    max_retries: int              # æœ€å¤§é‡è¯•æ¬¡æ•°
    
    # èµ„æºé¢„ä¼°
    estimated_tokens: int
    actual_tokens: int
    timeout: int                  # è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    
    # è´¨é‡è¯„ä¼°
    quality_score: Optional[float]  # Judgeè¯„åˆ†
    output_valid: bool
```

### Phaseæ•°æ®ç»“æ„

```python
@dataclass
class Phase:
    """æ‰§è¡Œé˜¶æ®µ"""
    id: int
    name: str                     # "ä»£ç ç†è§£ä¸åˆ†æ"
    goal: str                     # ç›®æ ‡æè¿°
    status: str                   # pending/running/done/failed
    
    # Tasksç®¡ç†
    tasks: List[Task]
    completed_tasks: List[int]    # å·²å®ŒæˆTask ID
    failed_tasks: List[int]       # å¤±è´¥Task ID
    
    # ä¾èµ–å…³ç³»
    dependencies: List[int]       # ä¾èµ–çš„Phase ID
    
    # æ‰§è¡Œç»Ÿè®¡
    rounds: int                   # å½“å‰Phaseçš„Roundæ•°
    max_rounds: int               # æœ€å¤§Roundæ•°
    
    # èµ„æºç»Ÿè®¡
    estimated_tasks: int
    estimated_tokens: int
    estimated_time: int
    actual_tokens: int
    actual_time: float
    
    # å®Œæˆåº¦è¯„ä¼°
    completion_rate: float        # 0.0-1.0
    quality_average: float        # å¹³å‡è´¨é‡åˆ†
    
    # ç”¨æˆ·å¯è§æ€»ç»“
    summary: str
```

---

## ğŸ”„ æ‰§è¡Œæµç¨‹è¯¦è§£

### ä¸»æµç¨‹

```python
async def run_with_phases(user_message, context_history):
    """Phase-Taskæ¶æ„çš„ä¸»æ‰§è¡Œæµç¨‹"""
    
    # ========== æ­¥éª¤0ï¼šå¤æ‚åº¦è¯„ä¼°ä¸Phaseè§„åˆ’ ==========
    phase_plan = await phase_planner(user_message)
    
    if not phase_plan.needs_phases:
        # ç®€å•ä»»åŠ¡ï¼šå•Phaseå¿«é€Ÿæ‰§è¡Œ
        return await simple_execution(user_message)
    
    # ========== æ­¥éª¤1ï¼šé€Phaseæ‰§è¡Œ ==========
    all_phase_summaries = []
    
    for phase in phase_plan.phases:
        print(f"\n{'='*60}")
        print(f"ğŸ¯ å¼€å§‹æ‰§è¡Œ Phase {phase.id}: {phase.name}")
        print(f"{'='*60}")
        
        phase_result = await execute_phase(phase, context_history)
        
        all_phase_summaries.append({
            "phase_name": phase.name,
            "summary": phase_result.summary,
            "completion_rate": phase_result.completion_rate
        })
        
        # Phaseå¤±è´¥ä¸”æ— æ³•æ¢å¤
        if phase_result.status == "failed" and not phase_result.recoverable:
            break
    
    # ========== æ­¥éª¤2ï¼šæ•´åˆæ‰€æœ‰Phaseçš„æ€»ç»“ ==========
    final_summary = synthesize_summaries(all_phase_summaries)
    
    return {
        "success": True,
        "message": final_summary,
        "phases_completed": len(all_phase_summaries),
        "total_tasks": sum(len(p.tasks) for p in phase_plan.phases)
    }
```

### Phaseæ‰§è¡Œå¾ªç¯

```python
async def execute_phase(phase: Phase, context_history):
    """æ‰§è¡Œå•ä¸ªPhase"""
    
    phase.status = "running"
    round_num = 0
    
    while round_num < phase.max_rounds:
        round_num += 1
        print(f"\n--- Phase {phase.id} - Round {round_num} ---")
        
        # ========== 1ï¸âƒ£ Planï¼šè§„åˆ’Tasks ==========
        plan_response = llm.chat(
            messages=build_messages(phase.goal, context_history),
            tools=[plan_tool],
            tool_choice={"type":"function","function":{"name":"plan_tool_call"}}
        )
        
        tasks = parse_tasks(plan_response)
        phase.tasks.extend(tasks)
        
        # ========== 2ï¸âƒ£ Executeï¼šæ‰¹é‡æ‰§è¡ŒTasks ==========
        execution_results = await execute_tasks(tasks)
        
        # æ›´æ–°context
        for result in execution_results:
            context_history.append({
                "role": "tool",
                "tool_call_id": result.tool_call_id,
                "content": json.dumps(result.data)
            })
        
        # ========== 3ï¸âƒ£ Judgeï¼šå®¢è§‚è¯„åˆ¤ ==========
        judge_response = llm.chat(
            messages=context_history,
            tools=[judge_tool],
            tool_choice={"type":"function","function":{"name":"judge_tasks"}}
        )
        
        judge_result = parse_judge(judge_response)
        
        # æ›´æ–°Taskè´¨é‡è¯„åˆ†
        for eval in judge_result.task_evaluation:
            task = find_task_by_id(tasks, eval.task_id)
            task.quality_score = eval.quality_score
            task.output_valid = eval.output_valid
        
        # ========== 4ï¸âƒ£ Thinkï¼šä¸»è§‚åˆ†æ ==========
        think_response = llm.chat(
            messages=context_history + [judge_response],
            tools=[think_tool],
            tool_choice={"type":"function","function":{"name":"think"}}
        )
        
        think_result = parse_think(think_response)
        
        # ========== 5ï¸âƒ£ å†³ç­–ï¼šæ˜¯å¦ç»“æŸPhase ==========
        if judge_result.phase_should_end and think_result.phase_completed:
            # Phaseæ­£å¸¸å®Œæˆ
            phase.status = "done"
            phase.summary = think_result.user_summary
            break
        
        elif judge_result.decision.action == "retry_with_adjustment":
            # é‡è¯•å¤±è´¥çš„Tasksï¼ˆè°ƒæ•´å‚æ•°ï¼‰
            continue
        
        elif judge_result.phase_plan_needs_revision:
            # Phaseè§„åˆ’é”™è¯¯ï¼Œéœ€è¦é‡æ–°è§„åˆ’
            phase.status = "failed"
            return {
                "status": "failed",
                "recoverable": True,
                "need_replanning": True,
                "feedback": judge_result.feedback
            }
        
        else:
            # ç»§ç»­ä¸‹ä¸€Round
            continue
    
    # Roundç”¨å°½
    if phase.status != "done":
        phase.status = "partial"
        phase.summary = think_result.user_summary
    
    return {
        "status": phase.status,
        "summary": phase.summary,
        "completion_rate": judge_result.phase_metrics.completion_rate,
        "rounds": round_num
    }
```

---

## ğŸ¨ å‰ç«¯å¯è§†åŒ–

### Phaseè¿›åº¦é¢æ¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š æ‰§è¡Œè¿›åº¦                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  âœ… Phase 1: ä»£ç ç†è§£ä¸åˆ†æ (100%)               â”‚
â”‚     â””â”€ 5/5 Taskså®Œæˆ                            â”‚
â”‚                                                 â”‚
â”‚  ğŸ”„ Phase 2: è®¤è¯æ¨¡å—é‡æ„ (75%)                  â”‚
â”‚     â”œâ”€ âœ… Task 1: æå–å…¬å…±å‡½æ•°                   â”‚
â”‚     â”œâ”€ âœ… Task 2: é‡æ„loginé€»è¾‘                  â”‚
â”‚     â”œâ”€ âœ… Task 3: é‡æ„registeré€»è¾‘               â”‚
â”‚     â”œâ”€ â³ Task 4: æ‰§è¡Œä¸­...                      â”‚
â”‚     â””â”€ â¸ï¸ Task 5: ç­‰å¾…Task 4...                 â”‚
â”‚                                                 â”‚
â”‚  â¸ï¸ Phase 3: OAuthé›†æˆ (0%)                     â”‚
â”‚     â””â”€ ç­‰å¾…Phase 2å®Œæˆ                          â”‚
â”‚                                                 â”‚
â”‚  æ•´ä½“è¿›åº¦ï¼š11/19 Tasks (58%)                    â”‚
â”‚  é¢„ä¼°å‰©ä½™æ—¶é—´ï¼š45ç§’                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Taskè¯¦æƒ…å¡ç‰‡ï¼ˆç‚¹å‡»å±•å¼€ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Task 4: æ·»åŠ å¯†ç åŠ å¯†å‡½æ•°             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·¥å…·ï¼šedit_file                     â”‚
â”‚ çŠ¶æ€ï¼šğŸ”„ æ‰§è¡Œä¸­                      â”‚
â”‚ ä¼˜å…ˆçº§ï¼šâ­â­â­â­â­â­â­â­ (8/10)      â”‚
â”‚ ä¾èµ–ï¼šTask 1, Task 2                â”‚
â”‚ é¢„ä¼°Tokenï¼š5000                     â”‚
â”‚ å·²ç”¨æ—¶é—´ï¼š8ç§’                        â”‚
â”‚                                     â”‚
â”‚ æ‰§è¡Œå‚æ•°ï¼š                           â”‚
â”‚ {                                   â”‚
â”‚   "path": "auth/crypto.py",         â”‚
â”‚   "old": "...",                     â”‚
â”‚   "new": "..."                      â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. ç²¾å‡†å¤±è´¥æ¢å¤

```
ä¼ ç»Ÿæ–¹å¼ï¼š
  30æ­¥ä¸­ç¬¬15æ­¥å¤±è´¥ â†’ ä»å¤´å¼€å§‹ï¼Ÿç»§ç»­ï¼Ÿ
  â†’ ä¸çŸ¥é“è¯¥æ€ä¹ˆåŠ

Phase-Taskæ–¹å¼ï¼š
  Phase 2, Round 1, Task 5å¤±è´¥
  â†’ Judgeè¯†åˆ«ï¼šåªéœ€é‡è¯•Task 5
  â†’ Planè°ƒæ•´Task 5å‚æ•°
  â†’ Executeé‡æ–°æ‰§è¡ŒTask 5
  â†’ å…¶ä»–14ä¸ªTaskä¿ç•™
```

---

### 2. æ¸è¿›å¼å±•ç¤º

```
ç”¨æˆ·çœ‹åˆ°ï¼š
  ç¬¬1åˆ†é’Ÿï¼š"Phase 1å¼€å§‹ï¼Œæ­£åœ¨ç†è§£ä»£ç ..."
  ç¬¬2åˆ†é’Ÿï¼š"Phase 1å®Œæˆ(5/5)ï¼Œè¿›å…¥Phase 2..."
  ç¬¬3åˆ†é’Ÿï¼š"Phase 2è¿›åº¦ 3/8..."
  
vs ä¼ ç»Ÿï¼š
  "æ€è€ƒä¸­..." (æŒç»­2åˆ†é’Ÿï¼Œæ²¡æœ‰ä»»ä½•åé¦ˆ)
```

---

### 3. èµ„æºç²¾å‡†æ§åˆ¶

```
Phase 1é¢„ä¼°ï¼š20K tokens, 30ç§’
Phase 2é¢„ä¼°ï¼š50K tokens, 90ç§’
Phase 3é¢„ä¼°ï¼š30K tokens, 60ç§’

ç”¨æˆ·å¯ä»¥ï¼š
  - åªæ‰§è¡ŒPhase 1å’Œ2ï¼Œæš‚åœPhase 3
  - è°ƒæ•´æŸä¸ªPhaseçš„max_rounds
  - è·³è¿‡æŸä¸ªéå…³é”®Phase
```

---

## âš ï¸ å®æ–½æŒ‘æˆ˜

### æŒ‘æˆ˜1ï¼šå·¥å…·è®¾è®¡å¤æ‚åº¦

```
éœ€è¦è®¾è®¡ï¼š
  âœ… phase_planner å·¥å…·
  âœ… plan_tool_call å·¥å…·ï¼ˆå‡çº§ç‰ˆï¼Œè¿”å›Taskåˆ—è¡¨ï¼‰
  âœ… judge_tasks å·¥å…·
  âœ… think_tool å·¥å…·ï¼ˆå·²æœ‰ï¼Œéœ€å¾®è°ƒï¼‰

= 4ä¸ªå·¥å…·ï¼Œæ¯ä¸ªéƒ½éœ€è¦ç²¾å¿ƒè®¾è®¡schema
```

### æŒ‘æˆ˜2ï¼šçŠ¶æ€ç®¡ç†å¤æ‚

```
éœ€è¦è¿½è¸ªï¼š
  - æ¯ä¸ªPhaseçš„çŠ¶æ€
  - æ¯ä¸ªTaskçš„çŠ¶æ€
  - Taskä¹‹é—´çš„ä¾èµ–å…³ç³»
  - Phaseä¹‹é—´çš„ä¾èµ–å…³ç³»

= çŠ¶æ€ç®¡ç†å™¨éœ€è¦å¢å¼º
```

### æŒ‘æˆ˜3ï¼šå‰ç«¯æ¸²æŸ“

```
éœ€è¦å®ç°ï¼š
  - Phaseè¿›åº¦æ ‘
  - TaskçŠ¶æ€å¡ç‰‡
  - ä¾èµ–å…³ç³»å¯è§†åŒ–
  - å®æ—¶æ›´æ–°

= å‰ç«¯å·¥ä½œé‡è¾ƒå¤§
```

---

## ğŸš€ å®æ–½è·¯çº¿å›¾

### MVPç‰ˆæœ¬ï¼ˆ3å¤©ï¼‰- æ¨èå…ˆåš

```
åŠŸèƒ½èŒƒå›´ï¼š
  âœ… å•Phase
  âœ… Taskæ ¼å¼åŒ–Plan
  âœ… Judgeè¯„åˆ¤
  âœ… Thinkæ€»ç»“
  âŒ æš‚ä¸æ”¯æŒå¤šPhase

ä¼˜åŠ¿ï¼š
  - å¿«é€ŸéªŒè¯æ–¹æ¡ˆå¯è¡Œæ€§
  - ç«‹å³è·å¾—Taskç²’åº¦ç®¡ç†
  - å‰ç«¯åªéœ€ç®€å•Taskåˆ—è¡¨
```

### å®Œæ•´ç‰ˆæœ¬ï¼ˆ1å‘¨ï¼‰

```
Day 1-2: å·¥å…·è®¾è®¡
  - phase_plannerå·¥å…·
  - å‡çº§plan_tool_callï¼ˆè¿”å›Taskåˆ—è¡¨ï¼‰
  - judge_taskså·¥å…·
  - è°ƒæ•´think_tool

Day 3-4: Agentæ‰§è¡Œé€»è¾‘
  - Phaseå¾ªç¯æ§åˆ¶
  - Taskæ‰§è¡Œä¸ä¾èµ–å¤„ç†
  - Judge-Thinkè”åŠ¨

Day 5-6: å‰ç«¯å¯è§†åŒ–
  - Phaseè¿›åº¦é¢æ¿
  - Taskå¡ç‰‡å±•ç¤º
  - å®æ—¶çŠ¶æ€æ›´æ–°

Day 7: æµ‹è¯•ä¸ä¼˜åŒ–
```

---

## ğŸ“Š æ•ˆæœé¢„æœŸ

| æŒ‡æ ‡ | å½“å‰ | MVPç‰ˆ | å®Œæ•´ç‰ˆ |
|------|-----|-------|--------|
| ä»»åŠ¡å®Œæˆç‡ | 65% | 80% | 90% |
| å¤±è´¥æ¢å¤èƒ½åŠ› | 20% | 70% | 95% |
| ç”¨æˆ·æ»¡æ„åº¦ | 70% | 82% | 92% |
| å¤æ‚ä»»åŠ¡æ”¯æŒ | âŒ | âš ï¸ | âœ… |
| è¿›åº¦å¯è§†åŒ– | âŒ | âš ï¸ | âœ… |

---

## ğŸ’¡ ä¸å…¶ä»–æ–¹æ¡ˆçš„ååŒ

### ç»“åˆåŠ¨æ€æ‰§è¡Œæ¨¡å¼

```
ç”¨æˆ·é€‰æ‹©"æ·±åº¦æ¨¡å¼" +  Phase-Taskæ¶æ„ï¼š
  - æ¯ä¸ªPhaseçš„max_rounds = 5
  - æ¯ä¸ªTaskå…è®¸3æ¬¡é‡è¯•
  - å¯ç”¨å®Œæ•´Judgeè¯„ä¼°
  
ç”¨æˆ·é€‰æ‹©"è½»é‡æ¨¡å¼" + Phase-Taskæ¶æ„ï¼š
  - å¼ºåˆ¶å•Phase
  - max_rounds = 2
  - æ¯ä¸ªTaskåªé‡è¯•1æ¬¡
```

### ç»“åˆContexté‡è¦åº¦è¯„åˆ†

```
Phaseæ‰§è¡Œå®Œæˆåï¼š
  - ç”¨MiniMaxè¯„åˆ†è¯¥Phaseçš„æ‰€æœ‰æ¶ˆæ¯
  - ä¿ç•™é«˜åˆ†æ¶ˆæ¯ï¼ˆå…³é”®å†³ç­–ï¼‰
  - å‹ç¼©ä½åˆ†æ¶ˆæ¯ï¼ˆæ¢ç´¢æ€§è®¨è®ºï¼‰
  - ä¸‹ä¸€Phaseè½»è£…ä¸Šé˜µ
```

---

## ğŸ¯ æ€»ç»“

### åˆç†æ€§è¯„åˆ†ï¼šâ­â­â­â­â­ (5/5)

**éå¸¸åˆç†ï¼åˆ›æ–°ç‚¹ï¼š**
1. âœ… åˆ†å±‚ç®¡ç†ï¼ˆPhase-Task-Toolï¼‰
2. âœ… ç»“æ„åŒ–Planï¼ˆTaskæ ¼å¼ï¼‰
3. âœ… å®¢è§‚è¯„åˆ¤ï¼ˆJudgeï¼‰
4. âœ… æ¸è¿›å¯è§†åŒ–
5. âœ… ç²¾å‡†æ¢å¤

**æ”¹è¿›æ•ˆæœ**ï¼š
- ğŸš€ å¤æ‚ä»»åŠ¡æˆåŠŸç‡ +40%
- ğŸš€ å¤±è´¥æ¢å¤èƒ½åŠ› +75%
- ğŸš€ ç”¨æˆ·ä½“éªŒ +30%
- ğŸš€ Tokenæ•ˆç‡ +50%

**å»ºè®®**ï¼š
1. å…ˆå®ç°MVPï¼ˆ3å¤©ï¼‰éªŒè¯æ•ˆæœ
2. ç”¨æˆ·åé¦ˆå¥½å†æŠ•å…¥å®Œæ•´ç‰ˆï¼ˆ1å‘¨ï¼‰
3. é€æ­¥è¿­ä»£ä¼˜åŒ–

**è¿™æ˜¯ä¸€ä¸ªå€¼å¾—æŠ•å…¥çš„åˆ›æ–°æ¶æ„ï¼** ğŸŒŸğŸš€

