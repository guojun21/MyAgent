# èŠå¤©è®°å½•æ£€ç´¢å·¥å…·ä½¿ç”¨è§„èŒƒä¸æ»¥ç”¨é˜²æŠ¤æ–¹æ¡ˆ

> åˆ›å»ºæ—¶é—´ï¼š2025-10-26 19:08  
> çŠ¶æ€ï¼šå¾…å®æ–½  
> ä¼˜å…ˆçº§ï¼šP1ï¼ˆé¿å…æˆæœ¬æµªè´¹ï¼‰  
> å®æ–½å‘¨æœŸï¼š1å¤©

---

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

### å·¥å…·ä»‹ç»

**query_history** (èŠå¤©è®°å½•æ£€ç´¢å·¥å…·)
- åŸºäºMiniMaxçš„è¯­ä¹‰æœç´¢
- ç”¨äºæ£€ç´¢å†å²å¯¹è¯ä¸­çš„ç›¸å…³ä¿¡æ¯
- æˆæœ¬ï¼šæ¯æ¬¡è°ƒç”¨ Â¥0.002-0.005

### å½“å‰é—®é¢˜ï¼šæ»¥ç”¨å¯¼è‡´æˆæœ¬æµªè´¹

```
âŒ é”™è¯¯ä½¿ç”¨æ¡ˆä¾‹1ï¼š
ç”¨æˆ·ï¼š"åˆ—å‡ºå½“å‰ç›®å½•çš„æ–‡ä»¶"
LLMï¼šè°ƒç”¨ query_history(query="æ–‡ä»¶åˆ—è¡¨")
â†’ é”™è¯¯ï¼åº”è¯¥ç”¨ list_files

âŒ é”™è¯¯ä½¿ç”¨æ¡ˆä¾‹2ï¼š
ç”¨æˆ·ï¼š"æŸ¥çœ‹config.pyçš„å†…å®¹"
LLMï¼šè°ƒç”¨ query_history(query="config.pyå†…å®¹")
â†’ é”™è¯¯ï¼åº”è¯¥ç”¨ read_file

âŒ é”™è¯¯ä½¿ç”¨æ¡ˆä¾‹3ï¼š
ç”¨æˆ·ï¼š"æœç´¢ä»£ç ä¸­çš„loginå‡½æ•°"
LLMï¼šè°ƒç”¨ query_history(query="loginå‡½æ•°")
â†’ é”™è¯¯ï¼åº”è¯¥ç”¨ search_code

é—®é¢˜æ ¹æºï¼š
  - å·¥å…·æè¿°ä¸å¤Ÿç²¾ç¡®
  - LLMè¯¯åˆ¤ä½¿ç”¨åœºæ™¯
  - ç¼ºä¹æ˜ç¡®çš„ä½¿ç”¨è¾¹ç•Œ
```

---

## ğŸ¯ æ­£ç¡®ä½¿ç”¨åœºæ™¯ï¼ˆä»…é™è¿™äº›ï¼ï¼‰

### âœ… åº”è¯¥ä½¿ç”¨ query_history çš„åœºæ™¯

#### åœºæ™¯1ï¼šè¯¢é—®å†å²å¯¹è¯å†…å®¹

```
ç”¨æˆ·ï¼š"æˆ‘ä¹‹å‰è®©ä½ ä¿®æ”¹äº†ä»€ä¹ˆæ–‡ä»¶ï¼Ÿ"
ç”¨æˆ·ï¼š"åˆšæ‰æˆ‘ä»¬è®¨è®ºçš„é‚£ä¸ªBugæ˜¯ä»€ä¹ˆï¼Ÿ"
ç”¨æˆ·ï¼š"ä½ ä¸Šæ¬¡ç»™æˆ‘çš„å»ºè®®æ˜¯ä»€ä¹ˆï¼Ÿ"
ç”¨æˆ·ï¼š"æˆ‘ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ"

å…³é”®è¯ï¼š
  - "ä¹‹å‰"ã€"åˆšæ‰"ã€"ä¸Šæ¬¡"
  - "æˆ‘ä»¬è®¨è®ºè¿‡"ã€"ä½ è¯´è¿‡"
  - "å†å²è®°å½•"ã€"å¯¹è¯è®°å½•"
```

#### åœºæ™¯2ï¼šå›æº¯å†³ç­–å’Œè®¨è®º

```
ç”¨æˆ·ï¼š"ä¸ºä»€ä¹ˆæˆ‘ä»¬å½“æ—¶é€‰æ‹©ç”¨JWTè€Œä¸æ˜¯Sessionï¼Ÿ"
ç”¨æˆ·ï¼š"ä¹‹å‰å…³äºæ€§èƒ½ä¼˜åŒ–çš„è®¨è®ºç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ"
ç”¨æˆ·ï¼š"æˆ‘è®°å¾—æˆ‘ä»¬æ”¹è¿‡ç«¯å£å·ï¼Œæ”¹æˆå¤šå°‘äº†ï¼Ÿ"

å…³é”®è¯ï¼š
  - "ä¸ºä»€ä¹ˆå½“æ—¶"ã€"ä¹‹å‰çš„å†³ç­–"
  - "è®¨è®ºç»“æœ"ã€"è¾¾æˆå…±è¯†"
```

#### åœºæ™¯3ï¼šæŸ¥æ‰¾å†å²æ“ä½œè®°å½•

```
ç”¨æˆ·ï¼š"æ‰¾ä¸€ä¸‹æˆ‘ä»¬ä¸Šæ¬¡åˆ›å»ºçš„é‚£ä¸ªç”¨æˆ·æœåŠ¡ç±»"
ç”¨æˆ·ï¼š"ä¹‹å‰ä¿®æ”¹è¿‡å“ªäº›é…ç½®æ–‡ä»¶ï¼Ÿ"
ç”¨æˆ·ï¼š"ä½ å¸®æˆ‘åšè¿‡å“ªäº›é‡æ„ï¼Ÿ"

å…³é”®è¯ï¼š
  - "ä¹‹å‰åšè¿‡"ã€"å†å²æ“ä½œ"
  - æ˜ç¡®è¦æ±‚"æŸ¥æ‰¾å¯¹è¯è®°å½•"
```

---

## âŒ ç»å¯¹ä¸åº”è¯¥ä½¿ç”¨çš„åœºæ™¯

### åœºæ™¯1ï¼šæŸ¥çœ‹å½“å‰é¡¹ç›®æ–‡ä»¶ï¼ˆç”¨ list_files/read_fileï¼‰

```
âŒ é”™è¯¯ï¼š
ç”¨æˆ·ï¼š"æŸ¥çœ‹srcç›®å½•æœ‰ä»€ä¹ˆæ–‡ä»¶"
LLMï¼šquery_history(query="srcç›®å½•æ–‡ä»¶")

âœ… æ­£ç¡®ï¼š
LLMï¼šlist_files(directory="src")
```

### åœºæ™¯2ï¼šæœç´¢ä»£ç å†…å®¹ï¼ˆç”¨ search_codeï¼‰

```
âŒ é”™è¯¯ï¼š
ç”¨æˆ·ï¼š"æœç´¢ä»£ç é‡Œçš„loginå‡½æ•°"
LLMï¼šquery_history(query="loginå‡½æ•°ä»£ç ")

âœ… æ­£ç¡®ï¼š
LLMï¼šsearch_code(query="def login|function login")
```

### åœºæ™¯3ï¼šè¯»å–æ–‡ä»¶å†…å®¹ï¼ˆç”¨ read_fileï¼‰

```
âŒ é”™è¯¯ï¼š
ç”¨æˆ·ï¼š"config.pyé‡Œå†™äº†ä»€ä¹ˆï¼Ÿ"
LLMï¼šquery_history(query="config.pyå†…å®¹")

âœ… æ­£ç¡®ï¼š
LLMï¼šread_file(path="config.py")
```

### åœºæ™¯4ï¼šæ‰§è¡Œå‘½ä»¤ï¼ˆç”¨ run_terminalï¼‰

```
âŒ é”™è¯¯ï¼š
ç”¨æˆ·ï¼š"è¿è¡Œä¸€ä¸‹æµ‹è¯•"
LLMï¼šquery_history(query="æµ‹è¯•å‘½ä»¤")

âœ… æ­£ç¡®ï¼š
LLMï¼šrun_terminal(command="pytest")
```

---

## ğŸ”§ å·¥å…·å®šä¹‰ä¼˜åŒ–

### å½“å‰å¯èƒ½çš„é—®é¢˜å®šä¹‰

```python
# âŒ å¤ªå®½æ³›ï¼Œå®¹æ˜“è¯¯ç”¨
{
    "name": "query_history",
    "description": "æŸ¥è¯¢èŠå¤©è®°å½•",
    "parameters": {
        "query": {"type": "string", "description": "æŸ¥è¯¢å†…å®¹"}
    }
}
```

### âœ… ä¼˜åŒ–åçš„ç²¾ç¡®å®šä¹‰

```python
{
    "name": "query_history",
    "description": """æ£€ç´¢å†å²å¯¹è¯è®°å½•ä¸­çš„ä¿¡æ¯ï¼ˆä»…ç”¨äºå›é¡¾è¿‡å»çš„è®¨è®ºï¼‰ã€‚

âš ï¸ é‡è¦é™åˆ¶ï¼š
æ­¤å·¥å…·ä»…ç”¨äºæ£€ç´¢"ä¹‹å‰å¯¹è¯ä¸­è®¨è®ºè¿‡çš„å†…å®¹"ï¼Œä¸èƒ½ç”¨äºï¼š
- æŸ¥çœ‹é¡¹ç›®æ–‡ä»¶å†…å®¹ï¼ˆåº”ä½¿ç”¨ read_fileï¼‰
- åˆ—å‡ºç›®å½•æ–‡ä»¶ï¼ˆåº”ä½¿ç”¨ list_filesï¼‰
- æœç´¢ä»£ç ï¼ˆåº”ä½¿ç”¨ search_codeï¼‰
- æŸ¥çœ‹å½“å‰çŠ¶æ€ï¼ˆåº”ä½¿ç”¨å¯¹åº”çš„å®æ—¶å·¥å…·ï¼‰

âœ… æ­£ç¡®ä½¿ç”¨åœºæ™¯ï¼š
- ç”¨æˆ·è¯¢é—®"ä¹‹å‰/åˆšæ‰/ä¸Šæ¬¡"çš„å¯¹è¯å†…å®¹
- å›é¡¾å†å²å†³ç­–å’Œè®¨è®ºè¿‡ç¨‹
- æŸ¥æ‰¾"æˆ‘ä»¬è®¨è®ºè¿‡"çš„æŸä¸ªè¯é¢˜
- è¿½æº¯"ä½ ä¹‹å‰è¯´è¿‡"çš„å»ºè®®

å¦‚æœç”¨æˆ·é—®çš„æ˜¯"å½“å‰/ç°åœ¨"çš„ä¿¡æ¯ï¼Œä¸è¦ä½¿ç”¨æ­¤å·¥å…·ï¼""",
    
    "parameters": {
        "type": "object",
        "properties": {
            "query": {
                "type": "string",
                "description": "è¦æ£€ç´¢çš„å†å²å¯¹è¯å…³é”®è¯æˆ–ä¸»é¢˜"
            },
            "time_range": {
                "type": "string",
                "enum": ["recent", "all"],
                "description": "æ£€ç´¢èŒƒå›´ï¼šrecent=æœ€è¿‘5è½®å¯¹è¯ï¼Œall=å…¨éƒ¨å†å²"
            }
        },
        "required": ["query"]
    }
}
```

---

## ğŸ¨ System Promptå¢å¼º

### åœ¨Agentç³»ç»Ÿæç¤ºè¯ä¸­æ·»åŠ å·¥å…·ä½¿ç”¨è§„åˆ™

```python
AGENT_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½ç¼–ç¨‹åŠ©æ‰‹Agent...

# å·¥å…·ä½¿ç”¨è§„åˆ™

## query_historyï¼ˆå†å²å¯¹è¯æ£€ç´¢ï¼‰
âš ï¸ ä¸¥æ ¼é™åˆ¶ï¼šä»…åœ¨ç”¨æˆ·æ˜ç¡®è¯¢é—®"å†å²å¯¹è¯"æ—¶ä½¿ç”¨ï¼

æ­£ç¡®åœºæ™¯ï¼š
  âœ… "æˆ‘ä¹‹å‰é—®äº†ä»€ä¹ˆï¼Ÿ"
  âœ… "ä½ ä¸Šæ¬¡çš„å»ºè®®æ˜¯ä»€ä¹ˆï¼Ÿ"
  âœ… "æˆ‘ä»¬è®¨è®ºè¿‡XXå—ï¼Ÿ"

é”™è¯¯åœºæ™¯ï¼ˆç¦æ­¢ä½¿ç”¨ï¼‰ï¼š
  âŒ "æŸ¥çœ‹config.py" â†’ åº”ç”¨ read_file
  âŒ "åˆ—å‡ºæ–‡ä»¶" â†’ åº”ç”¨ list_files
  âŒ "æœç´¢ä»£ç " â†’ åº”ç”¨ search_code
  âŒ ä»»ä½•å…³äº"å½“å‰/ç°åœ¨"çŠ¶æ€çš„æŸ¥è¯¢

åˆ¤æ–­æ ‡å‡†ï¼š
  - ç”¨æˆ·æåˆ°"ä¹‹å‰/åˆšæ‰/ä¸Šæ¬¡/å†å²" â†’ å¯ä»¥ç”¨ query_history
  - ç”¨æˆ·é—®"å½“å‰/ç°åœ¨/æœ‰ä»€ä¹ˆ" â†’ ä¸èƒ½ç”¨ query_history

## å…¶ä»–å·¥å…·
- read_file: è¯»å–æ–‡ä»¶å†…å®¹ï¼ˆå½“å‰çŠ¶æ€ï¼‰
- list_files: åˆ—å‡ºç›®å½•æ–‡ä»¶ï¼ˆå½“å‰çŠ¶æ€ï¼‰
- search_code: æœç´¢ä»£ç ï¼ˆå½“å‰çŠ¶æ€ï¼‰
- query_history: æ£€ç´¢å¯¹è¯ï¼ˆå†å²çŠ¶æ€ï¼‰

è®°ä½ï¼šå†å² vs å½“å‰ï¼Œä¸¤ç±»å·¥å…·ä¸èƒ½æ··ç”¨ï¼
"""
```

---

## ğŸ” ä½¿ç”¨å‰æ£€æµ‹æœºåˆ¶

### Agentå±‚é¢çš„å·¥å…·è°ƒç”¨æ‹¦æˆª

```python
# core/agent.py

class Agent:
    
    HISTORY_KEYWORDS = [
        "ä¹‹å‰", "åˆšæ‰", "ä¸Šæ¬¡", "ä»¥å‰",
        "å†å²", "è¿‡å»", "æ›¾ç»",
        "æˆ‘ä»¬è®¨è®º", "ä½ è¯´è¿‡", "æˆ‘é—®è¿‡"
    ]
    
    CURRENT_STATE_KEYWORDS = [
        "å½“å‰", "ç°åœ¨", "ç›®å‰",
        "æŸ¥çœ‹", "åˆ—å‡º", "è¯»å–", "æœç´¢"
    ]
    
    def validate_tool_call(
        self, 
        tool_name: str, 
        arguments: dict,
        user_message: str
    ) -> tuple[bool, str]:
        """
        éªŒè¯å·¥å…·è°ƒç”¨æ˜¯å¦åˆç†
        
        Returns:
            (æ˜¯å¦å…è®¸, é”™è¯¯ä¿¡æ¯)
        """
        
        # ç‰¹æ®Šæ£€æŸ¥ï¼šquery_history
        if tool_name == "query_history":
            return self._validate_query_history(arguments, user_message)
        
        return True, ""
    
    def _validate_query_history(
        self, 
        arguments: dict,
        user_message: str
    ) -> tuple[bool, str]:
        """éªŒè¯query_historyè°ƒç”¨æ˜¯å¦åˆç†"""
        
        # æ£€æŸ¥ç”¨æˆ·æ¶ˆæ¯ä¸­æ˜¯å¦æœ‰å†å²ç›¸å…³å…³é”®è¯
        has_history_keyword = any(
            kw in user_message 
            for kw in self.HISTORY_KEYWORDS
        )
        
        # æ£€æŸ¥æ˜¯å¦æ˜æ˜¾æ˜¯å½“å‰çŠ¶æ€æŸ¥è¯¢
        has_current_keyword = any(
            kw in user_message 
            for kw in self.CURRENT_STATE_KEYWORDS
        )
        
        # åˆ¤æ–­
        if has_current_keyword and not has_history_keyword:
            return False, (
                f"æ£€æµ‹åˆ°å½“å‰çŠ¶æ€æŸ¥è¯¢ï¼ˆ'{user_message}'ï¼‰ï¼Œ"
                f"ä¸åº”ä½¿ç”¨query_historyã€‚"
                f"å»ºè®®ä½¿ç”¨ï¼šread_file/list_files/search_code"
            )
        
        if not has_history_keyword:
            # æ²¡æœ‰æ˜ç¡®çš„å†å²å…³é”®è¯ï¼Œå¯èƒ½è¯¯ç”¨
            print(f"[Agent] âš ï¸ query_historyå¯èƒ½è¯¯ç”¨ï¼Œç”¨æˆ·æ¶ˆæ¯æ— å†å²å…³é”®è¯")
            # å…è®¸ä½†è®°å½•è­¦å‘Š
            return True, ""
        
        # åˆç†ä½¿ç”¨
        return True, ""
    
    async def _execute_tool_call(self, tool_call: Dict[str, Any], user_message: str):
        """æ‰§è¡Œå·¥å…·è°ƒç”¨ï¼ˆå¢åŠ éªŒè¯ï¼‰"""
        
        function_name = tool_call["function"]["name"]
        arguments = json.loads(tool_call["function"]["arguments"])
        
        # ========== éªŒè¯å·¥å…·è°ƒç”¨åˆç†æ€§ ==========
        is_valid, error_msg = self.validate_tool_call(
            function_name,
            arguments,
            user_message
        )
        
        if not is_valid:
            print(f"[Agent] âŒ å·¥å…·è°ƒç”¨è¢«æ‹¦æˆª: {error_msg}")
            
            # è¿”å›é”™è¯¯ï¼Œè®©LLMé‡æ–°é€‰æ‹©å·¥å…·
            return {
                "success": False,
                "error": f"å·¥å…·ä½¿ç”¨ä¸å½“ï¼š{error_msg}",
                "suggestion": "è¯·ä½¿ç”¨æ­£ç¡®çš„å·¥å…·"
            }
        
        # æ­£å¸¸æ‰§è¡Œ
        result = self.tool_manager.execute_tool(function_name, arguments)
        return result
```

---

## ğŸ“Š ä½¿ç”¨åœºæ™¯åˆ¤æ–­æ ‘

```
ç”¨æˆ·æ¶ˆæ¯åˆ†æ
   â†“
åŒ…å«"ä¹‹å‰/åˆšæ‰/ä¸Šæ¬¡/å†å²"ï¼Ÿ
   â†“          â†“
  æ˜¯         å¦
   â†“          â†“
âœ… å¯ç”¨     ç»§ç»­åˆ¤æ–­
query_history    â†“
              è¯¢é—®å¯¹è¯å†…å®¹ vs è¯¢é—®ç³»ç»ŸçŠ¶æ€ï¼Ÿ
                â†“              â†“
              å¯¹è¯å†…å®¹       ç³»ç»ŸçŠ¶æ€
                â†“              â†“
            âœ… å¯ç”¨        âŒ ä¸å¯ç”¨
         query_history   (ç”¨å…¶ä»–å·¥å…·)

ç¤ºä¾‹ï¼š
"æˆ‘ä»¬ä¹‹å‰è®¨è®ºè¿‡XXå—ï¼Ÿ" â†’ å¯¹è¯å†…å®¹ â†’ âœ…
"ä¹‹å‰åˆ›å»ºäº†ä»€ä¹ˆæ–‡ä»¶ï¼Ÿ" â†’ å¯¹è¯å†…å®¹ â†’ âœ…
"ç°åœ¨æœ‰ä»€ä¹ˆæ–‡ä»¶ï¼Ÿ" â†’ ç³»ç»ŸçŠ¶æ€ â†’ âŒ ç”¨list_files
"æŸ¥çœ‹æ–‡ä»¶å†…å®¹" â†’ ç³»ç»ŸçŠ¶æ€ â†’ âŒ ç”¨read_file
```

---

## ğŸ”’ å¤šå±‚é˜²æŠ¤æœºåˆ¶

### ç¬¬1å±‚ï¼šTool Descriptionï¼ˆå·¥å…·æè¿°ï¼‰

```python
# åœ¨å·¥å…·æè¿°ä¸­æ˜ç¡®é™åˆ¶
{
    "name": "query_history",
    "description": """æ£€ç´¢å†å²å¯¹è¯è®°å½•ï¼ˆä»…é™å›é¡¾è¿‡å»çš„è®¨è®ºï¼‰

ğŸ¯ é€‚ç”¨åœºæ™¯ï¼ˆONLYè¿™äº›ï¼‰ï¼š
1. ç”¨æˆ·è¯¢é—®"ä¹‹å‰/åˆšæ‰/ä¸Šæ¬¡"çš„å¯¹è¯å†…å®¹
   ç¤ºä¾‹ï¼š"æˆ‘åˆšæ‰é—®äº†ä»€ä¹ˆï¼Ÿ"
2. å›é¡¾å†å²å†³ç­–å’Œè®¨è®º
   ç¤ºä¾‹ï¼š"ä¸ºä»€ä¹ˆæˆ‘ä»¬é€‰æ‹©ç”¨JWTï¼Ÿ"
3. æŸ¥æ‰¾è¿‡å»çš„æ“ä½œè®°å½•
   ç¤ºä¾‹ï¼š"ä¹‹å‰ä¿®æ”¹è¿‡å“ªäº›æ–‡ä»¶ï¼Ÿ"

ğŸš« ç¦æ­¢ä½¿ç”¨åœºæ™¯ï¼š
1. æŸ¥çœ‹å½“å‰æ–‡ä»¶/ç›®å½• â†’ ç”¨ read_file/list_files
2. æœç´¢ä»£ç å†…å®¹ â†’ ç”¨ search_code
3. è·å–ç³»ç»Ÿä¿¡æ¯ â†’ ç”¨ get_project_structure
4. ä»»ä½•ä¸æ¶‰åŠ"å›é¡¾å†å²å¯¹è¯"çš„æ“ä½œ

âš ï¸ å…³é”®åˆ¤æ–­ï¼š
- ç”¨æˆ·é—®"ä¹‹å‰/å†å²" â†’ ç”¨æ­¤å·¥å…· âœ…
- ç”¨æˆ·é—®"å½“å‰/ç°åœ¨" â†’ ä¸ç”¨æ­¤å·¥å…· âŒ

å¦‚æœä¸ç¡®å®šï¼Œä¼˜å…ˆä½¿ç”¨å…¶ä»–å®æ—¶å·¥å…·ï¼""",
    "parameters": {...}
}
```

---

### ç¬¬2å±‚ï¼šSystem Promptï¼ˆç³»ç»Ÿæç¤ºï¼‰

```python
# åœ¨AGENT_SYSTEM_PROMPTä¸­å¼ºè°ƒ
"""
# å·¥å…·é€‰æ‹©æŒ‡å—

query_history æ˜¯ä¸€ä¸ªç‰¹æ®Šå·¥å…·ï¼Œæˆæœ¬è¾ƒé«˜ï¼Œä½¿ç”¨æ—¶å¿…é¡»ä¸¥æ ¼éµå®ˆï¼š

1ï¸âƒ£ ä»…åœ¨ç”¨æˆ·æ˜ç¡®è¯¢é—®"å†å²å¯¹è¯"æ—¶ä½¿ç”¨
   âœ… "æˆ‘ä¹‹å‰é—®è¿‡ä»€ä¹ˆï¼Ÿ"
   âœ… "åˆšæ‰çš„è®¨è®ºç»“æœæ˜¯ï¼Ÿ"
   âŒ "å½“å‰æœ‰ä»€ä¹ˆæ–‡ä»¶ï¼Ÿ" â†’ ç”¨ list_files

2ï¸âƒ£ åˆ¤æ–­å£è¯€ï¼š
   - é—®"è¿‡å»" â†’ query_history
   - é—®"ç°åœ¨" â†’ å®æ—¶å·¥å…·(read_file/list_files/search_code)

3ï¸âƒ£ å¦‚æœä¸ç¡®å®šï¼Œé»˜è®¤ä½¿ç”¨å®æ—¶å·¥å…·
   å®å¯å°‘ç”¨ query_historyï¼Œä¸è¦æ»¥ç”¨
"""
```

---

### ç¬¬3å±‚ï¼šRuntime Validationï¼ˆè¿è¡Œæ—¶éªŒè¯ï¼‰

```python
# core/agent.py

class QueryHistoryValidator:
    """query_historyè°ƒç”¨éªŒè¯å™¨"""
    
    # å†å²æŸ¥è¯¢çš„å…³é”®è¯ï¼ˆå¿…é¡»åŒ…å«å…¶ä¸€ï¼‰
    HISTORY_INDICATORS = [
        "ä¹‹å‰", "åˆšæ‰", "ä¸Šæ¬¡", "ä»¥å‰", "æ›¾ç»",
        "å†å²", "è¿‡å»", "earlier", "before", "previous",
        "æˆ‘ä»¬è®¨è®º", "ä½ è¯´è¿‡", "æˆ‘é—®è¿‡", "ä½ å»ºè®®",
        "ç¬¬ä¸€æ¬¡", "æœ€åˆ", "å¼€å§‹æ—¶"
    ]
    
    # å½“å‰çŠ¶æ€æŸ¥è¯¢çš„å…³é”®è¯ï¼ˆå¦‚æœåŒ…å«åˆ™ç¦ç”¨ï¼‰
    CURRENT_STATE_INDICATORS = [
        "å½“å‰", "ç°åœ¨", "ç›®å‰", "ç°æœ‰",
        "æŸ¥çœ‹", "åˆ—å‡º", "æ˜¾ç¤º", "è¯»å–",
        "æœ‰ä»€ä¹ˆ", "æ˜¯ä»€ä¹ˆ", "åŒ…å«",
        "æ–‡ä»¶å†…å®¹", "ç›®å½•ç»“æ„", "ä»£ç "
    ]
    
    # æ˜ç¡®è¦æ±‚å†å²çš„å¼ºæŒ‡ç¤ºè¯
    EXPLICIT_HISTORY_REQUESTS = [
        "å†å²è®°å½•", "å¯¹è¯è®°å½•", "èŠå¤©è®°å½•",
        "ä¹‹å‰çš„å¯¹è¯", "è¿‡å»çš„è®¨è®º",
        "conversation history", "chat history"
    ]
    
    def validate(self, user_message: str, query: str) -> tuple[bool, str, float]:
        """
        éªŒè¯query_historyè°ƒç”¨æ˜¯å¦åˆç†
        
        Returns:
            (æ˜¯å¦å…è®¸, åŸå› , ç½®ä¿¡åº¦)
        """
        
        msg_lower = user_message.lower()
        
        # 1. æ˜ç¡®è¦æ±‚å†å²è®°å½• â†’ 100%å…è®¸
        if any(exp in msg_lower for exp in self.EXPLICIT_HISTORY_REQUESTS):
            return True, "ç”¨æˆ·æ˜ç¡®è¦æ±‚å†å²è®°å½•", 1.0
        
        # 2. åŒ…å«å†å²å…³é”®è¯ï¼Ÿ
        has_history = any(kw in user_message for kw in self.HISTORY_INDICATORS)
        
        # 3. åŒ…å«å½“å‰çŠ¶æ€å…³é”®è¯ï¼Ÿ
        has_current = any(kw in user_message for kw in self.CURRENT_STATE_INDICATORS)
        
        # 4. å†³ç­–çŸ©é˜µ
        if has_history and not has_current:
            # æ˜ç¡®æ˜¯å†å²æŸ¥è¯¢
            return True, "åŒ…å«å†å²å…³é”®è¯", 0.9
        
        elif has_current and not has_history:
            # æ˜ç¡®æ˜¯å½“å‰çŠ¶æ€æŸ¥è¯¢
            return False, "ç”¨æˆ·è¯¢é—®å½“å‰çŠ¶æ€ï¼Œåº”ä½¿ç”¨å®æ—¶å·¥å…·(read_file/list_files/search_code)", 0.95
        
        elif has_history and has_current:
            # ä¸¤è€…éƒ½æœ‰ï¼Œéœ€è¦è¿›ä¸€æ­¥åˆ¤æ–­
            # ä¼˜å…ˆçº§ï¼šå†å²å…³é”®è¯åœ¨å‰ â†’ å†å²æŸ¥è¯¢
            history_pos = min(
                (user_message.find(kw) for kw in self.HISTORY_INDICATORS if kw in user_message),
                default=999
            )
            current_pos = min(
                (user_message.find(kw) for kw in self.CURRENT_STATE_INDICATORS if kw in user_message),
                default=999
            )
            
            if history_pos < current_pos:
                return True, "å†å²å…³é”®è¯ä¼˜å…ˆ", 0.7
            else:
                return False, "å½“å‰çŠ¶æ€å…³é”®è¯ä¼˜å…ˆï¼Œå»ºè®®ç”¨å®æ—¶å·¥å…·", 0.8
        
        else:
            # éƒ½æ²¡æœ‰ â†’ é»˜è®¤æ‹’ç»ï¼ˆå®ç¼ºå‹¿æ»¥ï¼‰
            return False, "ç”¨æˆ·æœªæ˜ç¡®è¯¢é—®å†å²ï¼Œé»˜è®¤ä½¿ç”¨å®æ—¶å·¥å…·", 0.6


# åœ¨Agentä¸­ä½¿ç”¨
class Agent:
    def __init__(self):
        ...
        self.query_history_validator = QueryHistoryValidator()
    
    async def _execute_tool_call(self, tool_call, user_message):
        """æ‰§è¡Œå·¥å…·ï¼ˆå¸¦éªŒè¯ï¼‰"""
        
        function_name = tool_call["function"]["name"]
        arguments = json.loads(tool_call["function"]["arguments"])
        
        # ========== query_historyç‰¹æ®ŠéªŒè¯ ==========
        if function_name == "query_history":
            is_valid, reason, confidence = self.query_history_validator.validate(
                user_message,
                arguments.get("query", "")
            )
            
            if not is_valid:
                print(f"[Agent] âŒ query_historyè°ƒç”¨è¢«æ‹¦æˆª")
                print(f"  åŸå› : {reason}")
                print(f"  ç½®ä¿¡åº¦: {confidence*100:.0f}%")
                
                # è¿”å›é”™è¯¯ï¼Œè®©LLMé‡æ–°é€‰æ‹©
                return {
                    "success": False,
                    "error": f"å·¥å…·ä½¿ç”¨ä¸å½“ï¼š{reason}",
                    "suggestion": "è¯·ä½¿ç”¨ read_fileã€list_files æˆ– search_code ç­‰å®æ—¶å·¥å…·"
                }
            
            else:
                print(f"[Agent] âœ… query_historyè°ƒç”¨åˆç†")
                print(f"  åŸå› : {reason}")
        
        # æ­£å¸¸æ‰§è¡Œ
        return self.tool_manager.execute_tool(function_name, arguments)
```

---

## ğŸ“Š ä½¿ç”¨ç»Ÿè®¡ä¸ç›‘æ§

### ç»Ÿè®¡query_historyçš„ä½¿ç”¨æ¨¡å¼

```python
class QueryHistoryMonitor:
    """query_historyä½¿ç”¨ç›‘æ§"""
    
    def __init__(self):
        self.usage_stats = {
            "total_calls": 0,
            "valid_calls": 0,
            "invalid_calls": 0,
            "rejected_calls": 0
        }
    
    def record_call(self, user_message: str, is_valid: bool, was_rejected: bool):
        """è®°å½•è°ƒç”¨"""
        self.usage_stats["total_calls"] += 1
        
        if was_rejected:
            self.usage_stats["rejected_calls"] += 1
        elif is_valid:
            self.usage_stats["valid_calls"] += 1
        else:
            self.usage_stats["invalid_calls"] += 1
    
    def get_abuse_rate(self) -> float:
        """è®¡ç®—æ»¥ç”¨ç‡"""
        total = self.usage_stats["total_calls"]
        if total == 0:
            return 0.0
        
        invalid = self.usage_stats["invalid_calls"] + self.usage_stats["rejected_calls"]
        return invalid / total
    
    def should_alert(self) -> bool:
        """æ˜¯å¦åº”è¯¥å‘Šè­¦"""
        # æ»¥ç”¨ç‡è¶…è¿‡30%
        return self.get_abuse_rate() > 0.3
```

---

## ğŸ¨ å‰ç«¯ç”¨æˆ·æç¤º

### è¾“å…¥æ—¶æ™ºèƒ½æç¤º

```javascript
// æ£€æµ‹ç”¨æˆ·è¾“å…¥æ„å›¾
userInput.addEventListener('input', function() {
    const message = this.value;
    
    // æ£€æµ‹æ˜¯å¦è¦æŸ¥è¯¢å†å²
    const historyKeywords = ['ä¹‹å‰', 'åˆšæ‰', 'ä¸Šæ¬¡', 'å†å²'];
    const hasHistoryIntent = historyKeywords.some(kw => message.includes(kw));
    
    // æ£€æµ‹æ˜¯å¦è¦æŸ¥è¯¢å½“å‰çŠ¶æ€
    const currentKeywords = ['æŸ¥çœ‹', 'åˆ—å‡º', 'è¯»å–', 'æœç´¢'];
    const hasCurrentIntent = currentKeywords.some(kw => message.includes(kw));
    
    const hintBox = document.getElementById('input-hint');
    
    if (hasHistoryIntent && hasCurrentIntent) {
        // æ„å›¾æ··æ·†
        hintBox.innerHTML = `
            ğŸ’¡ æç¤ºï¼šæ‚¨çš„é—®é¢˜åŒ…å«"å†å²"å’Œ"å½“å‰"ä¸¤ç§æŸ¥è¯¢ï¼Œè¯·æ˜ç¡®ï¼š
            <br>â€¢ è¯¢é—®å¯¹è¯å†å² â†’ "æˆ‘ä»¬ä¹‹å‰è®¨è®ºè¿‡..."
            <br>â€¢ æŸ¥çœ‹å½“å‰çŠ¶æ€ â†’ "ç°åœ¨é¡¹ç›®é‡Œæœ‰..."
        `;
        hintBox.className = 'input-hint warning';
    }
    else if (hasCurrentIntent) {
        hintBox.innerHTML = `
            ğŸ’¡ Agentä¼šè‡ªåŠ¨è¯»å–å½“å‰æ–‡ä»¶/ç›®å½•ï¼Œæ— éœ€ç²˜è´´å†…å®¹
        `;
        hintBox.className = 'input-hint info';
    }
    else {
        hintBox.style.display = 'none';
    }
});
```

---

## ğŸ¯ Few-shotç¤ºä¾‹ï¼ˆæ•™è‚²LLMï¼‰

### åœ¨é¦–æ¬¡å¯¹è¯æ—¶æ³¨å…¥ç¤ºä¾‹

```python
# åœ¨ç³»ç»Ÿåˆå§‹åŒ–æ—¶æ·»åŠ åˆ°Context
FEW_SHOT_EXAMPLES = [
    {
        "role": "user",
        "content": "æˆ‘ä¹‹å‰é—®çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ"
    },
    {
        "role": "assistant",
        "content": "æˆ‘éœ€è¦æ£€ç´¢å†å²å¯¹è¯",
        "tool_calls": [{
            "function": {
                "name": "query_history",
                "arguments": '{"query": "ç¬¬ä¸€ä¸ªé—®é¢˜"}'
            }
        }]
    },
    {
        "role": "user",
        "content": "æŸ¥çœ‹config.pyçš„å†…å®¹"
    },
    {
        "role": "assistant",
        "content": "æˆ‘éœ€è¦è¯»å–å½“å‰æ–‡ä»¶",
        "tool_calls": [{
            "function": {
                "name": "read_file",
                "arguments": '{"path": "config.py"}'
            }
        }]
    }
]
```

---

## ğŸ’° æˆæœ¬å½±å“åˆ†æ

### æ»¥ç”¨çš„æˆæœ¬

```
å‡è®¾åœºæ™¯ï¼š
  - æ¯å¤©100æ¬¡å¯¹è¯
  - 20%è¯¯ç”¨query_historyï¼ˆåº”è¯¥ç”¨å…è´¹å·¥å…·ï¼‰
  - æ¯æ¬¡query_historyæˆæœ¬ï¼šÂ¥0.003

æ¯å¤©æµªè´¹ï¼š100 Ã— 0.2 Ã— 0.003 = Â¥0.06
æ¯æœˆæµªè´¹ï¼šÂ¥0.06 Ã— 30 = Â¥1.8
æ¯å¹´æµªè´¹ï¼šÂ¥1.8 Ã— 12 = Â¥21.6

å®æ–½é˜²æŠ¤åï¼š
  è¯¯ç”¨ç‡ï¼š20% â†’ 2%
  æ¯å¹´èŠ‚çœï¼šÂ¥21.6 Ã— 0.9 = Â¥19.44 ğŸ’°
```

---

## ğŸ“ˆ ç›‘æ§ä¸å‘Šè­¦

### å®šæœŸæ£€æŸ¥æ»¥ç”¨ç‡

```python
# æ¯å¤©è‡ªåŠ¨æ£€æŸ¥
def daily_tool_usage_check():
    monitor = QueryHistoryMonitor()
    
    abuse_rate = monitor.get_abuse_rate()
    
    if abuse_rate > 0.3:
        # å‘é€å‘Šè­¦
        alert = f"""
        âš ï¸ query_historyæ»¥ç”¨ç‡å‘Šè­¦
        
        æ»¥ç”¨ç‡ï¼š{abuse_rate*100:.1f}%
        æ€»è°ƒç”¨ï¼š{monitor.usage_stats['total_calls']}æ¬¡
        æ— æ•ˆè°ƒç”¨ï¼š{monitor.usage_stats['invalid_calls']}æ¬¡
        è¢«æ‹¦æˆªï¼š{monitor.usage_stats['rejected_calls']}æ¬¡
        
        å»ºè®®ï¼š
        1. æ£€æŸ¥Tool Descriptionæ˜¯å¦å¤Ÿæ¸…æ™°
        2. å¢å¼ºSystem Promptçº¦æŸ
        3. æŸ¥çœ‹å…·ä½“çš„è¯¯ç”¨case
        """
        
        send_admin_alert(alert)
```

---

## ğŸ¯ å®æ–½æ¸…å•

### Day 1: å·¥å…·å®šä¹‰ä¼˜åŒ–
- [ ] é‡å†™query_historyçš„description
- [ ] æ·»åŠ è¯¦ç»†çš„ä½¿ç”¨/ç¦æ­¢åœºæ™¯è¯´æ˜
- [ ] å¢åŠ å‚æ•°time_rangeé™åˆ¶

### Day 2: éªŒè¯æœºåˆ¶
- [ ] å®ç°QueryHistoryValidator
- [ ] Agentå±‚é¢æ‹¦æˆªé€»è¾‘
- [ ] é”™è¯¯æç¤ºä¼˜åŒ–

### Day 3: Promptå¢å¼º
- [ ] System Promptæ·»åŠ å·¥å…·ä½¿ç”¨è§„åˆ™
- [ ] Few-shotç¤ºä¾‹æ³¨å…¥
- [ ] æµ‹è¯•LLMç†è§£æ•ˆæœ

### Day 4: ç›‘æ§ä¸ä¼˜åŒ–
- [ ] ä½¿ç”¨ç»Ÿè®¡æ”¶é›†
- [ ] æ»¥ç”¨ç‡è®¡ç®—
- [ ] å‘Šè­¦æœºåˆ¶

---

## ğŸ“Š æ•ˆæœé¢„æœŸ

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| query_historyæ»¥ç”¨ç‡ | 25% | <5% | â¬‡ï¸ 80% |
| å·¥å…·é€‰æ‹©å‡†ç¡®ç‡ | 75% | >92% | â¬†ï¸ 23% |
| æˆæœ¬èŠ‚çœ | - | Â¥19/å¹´ | - |
| ç”¨æˆ·ä½“éªŒ | ä¸­ | é«˜ | â¬†ï¸ |

---

## ğŸ’¡ æ‰©å±•ï¼šé€šç”¨å·¥å…·ä½¿ç”¨è§„èŒƒ

### å»ºç«‹å®Œæ•´çš„å·¥å…·ä½¿ç”¨å†³ç­–æ ‘

```
ç”¨æˆ·è¯¢é—®
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ„å›¾åˆ†ç±»                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. å›é¡¾å†å²ï¼Ÿ                        â”‚
â”‚    â†’ query_history                  â”‚
â”‚                                     â”‚
â”‚ 2. æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼Ÿ                    â”‚
â”‚    â†’ read_file                      â”‚
â”‚                                     â”‚
â”‚ 3. åˆ—å‡ºæ–‡ä»¶ï¼Ÿ                        â”‚
â”‚    â†’ list_files                     â”‚
â”‚                                     â”‚
â”‚ 4. æœç´¢ä»£ç ï¼Ÿ                        â”‚
â”‚    â†’ search_code                    â”‚
â”‚                                     â”‚
â”‚ 5. ä¿®æ”¹æ–‡ä»¶ï¼Ÿ                        â”‚
â”‚    â†’ edit_file                      â”‚
â”‚                                     â”‚
â”‚ 6. æ‰§è¡Œå‘½ä»¤ï¼Ÿ                        â”‚
â”‚    â†’ run_terminal                   â”‚
â”‚                                     â”‚
â”‚ 7. é¡¹ç›®ç»“æ„ï¼Ÿ                        â”‚
â”‚    â†’ get_project_structure          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·¥å…·äº’æ–¥è§„åˆ™

```python
TOOL_EXCLUSION_RULES = {
    "query_history": {
        "conflicts_with": ["read_file", "list_files", "search_code"],
        "reason": "å†å²æŸ¥è¯¢ vs å½“å‰çŠ¶æ€æŸ¥è¯¢",
        "decision": "ä¼˜å…ˆä½¿ç”¨å®æ—¶å·¥å…·"
    },
    "read_file": {
        "conflicts_with": ["query_history"],
        "when": "ç”¨æˆ·é—®å½“å‰æ–‡ä»¶å†…å®¹"
    },
    "search_code": {
        "conflicts_with": ["query_history"],
        "when": "ç”¨æˆ·è¦æœç´¢ä»£ç "
    }
}
```

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒåŸåˆ™

**query_history ä¸‰åŸåˆ™**ï¼š
1. âœ… åªç”¨äº"å›é¡¾å†å²å¯¹è¯"
2. âœ… å¦‚æœä¸ç¡®å®šï¼Œä¸è¦ç”¨
3. âœ… æœ‰å…¶ä»–å·¥å…·èƒ½å®ç°ï¼Œä¼˜å…ˆç”¨å…¶ä»–

### åˆ¤æ–­å£è¯€

```
ç”¨æˆ·é—®"è¿‡å»" â†’ query_history âœ…
ç”¨æˆ·é—®"ç°åœ¨" â†’ å®æ—¶å·¥å…· âœ…
ç”¨æˆ·æ²¡æ˜è¯´ â†’ å®æ—¶å·¥å…· âœ…ï¼ˆå®ç¼ºå‹¿æ»¥ï¼‰
```

### é˜²æŠ¤æœºåˆ¶

- ğŸ›¡ï¸ **ä¸‰å±‚é˜²æŠ¤**ï¼šDescription + System Prompt + Runtime Validation
- ğŸ›¡ï¸ **æˆæœ¬æ§åˆ¶**ï¼šå‡å°‘80%æ»¥ç”¨
- ğŸ›¡ï¸ **ç”¨æˆ·å¼•å¯¼**ï¼šå‰ç«¯æ™ºèƒ½æç¤º

### å®æ–½æ”¶ç›Š

- âœ… èŠ‚çœæˆæœ¬ï¼šÂ¥19/å¹´
- âœ… æå‡å‡†ç¡®ç‡ï¼š+23%
- âœ… ä¼˜åŒ–ä½“éªŒï¼šå‡å°‘è¯¯è°ƒç”¨
- âœ… ç³»ç»Ÿå¥å£®æ€§ï¼šæ˜ç¡®å·¥å…·è¾¹ç•Œ

**æŠ•å…¥1å¤©ï¼Œå»ºç«‹æ¸…æ™°çš„å·¥å…·ä½¿ç”¨è§„èŒƒï¼Œé•¿æœŸæ”¶ç›Šï¼** ğŸ’°âœ…

