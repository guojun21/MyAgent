# Agentåå¤§å¸¸è§é—®é¢˜ï¼šä»ç†è®ºåˆ°å®è·µçš„ä½“ç³»åŒ–æ€»ç»“

> åˆ›å»ºæ—¶é—´ï¼š2025-10-26 19:18  
> çŠ¶æ€ï¼šä½“ç³»åŒ–åˆ†æ  
> ä¼˜å…ˆçº§ï¼šP1ï¼ˆæŒ‡å¯¼åç»­å¼€å‘ï¼‰  
> å½±å“èŒƒå›´ï¼šAgentæ¶æ„è®¾è®¡

---

## ğŸ¯ èƒŒæ™¯

åœ¨å®æ–½Planner-Executoræ¨¡å¼ã€å·¥å…·ç²¾ç®€ã€task_doneæœºåˆ¶çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç³»ç»Ÿæ€§åœ°è¯†åˆ«äº†**Agentå¼€å‘çš„åå¤§å¸¸è§é—®é¢˜**ã€‚

è¿™ä¸æ˜¯"é—®é¢˜åˆ—è¡¨"ï¼Œè€Œæ˜¯ä¸€ä¸ª**Agentå¥å£®æ€§æ¡†æ¶**ã€‚

---

## ğŸ“‹ åå¤§é—®é¢˜å…¨æ™¯å›¾

| ä¼˜å…ˆçº§ | é—®é¢˜ | æ ¹æœ¬åŸå›  | å·²å®æ–½æ–¹æ¡ˆ | åç»­æ–¹å‘ |
|-------|------|---------|----------|---------|
| ğŸ”´ P0 | ä¸å¬plan | tool_choiceä¸ç²¾ç¡® | âœ… ç²¾ç¡®æŒ‡å®š | - |
| ğŸ”´ P0 | æ­»å¾ªç¯æ£€æµ‹ | ç¼ºå°‘é‡å¤è°ƒç”¨æ£€æµ‹ | âŒ æœªå®æ–½ | æŒ‡çº¹+è®¡æ•° |
| ğŸ”´ P0 | æ— åœæ­¢æœºåˆ¶ | å›ºå®šè¿­ä»£æ¬¡æ•° | âœ… task_done | æ¡ä»¶å¼task_done |
| ğŸŸ¡ P1 | Contextçˆ†ç‚¸ | å·¥å…·è¿”å›æ— é™åˆ¶ | âš ï¸ éƒ¨åˆ†ï¼ˆread_fileé™åˆ¶ï¼‰ | ç»Ÿä¸€æˆªæ–­ |
| ğŸŸ¡ P1 | é”™è¯¯ç´¯ç§¯ | ç»§ç»­æ‰§è¡Œé”™è¯¯åç»­ | âŒ æœªå®æ–½ | è‡´å‘½é”™è¯¯æ£€æµ‹ |
| ğŸŸ¢ P2 | Tokenæµªè´¹ | å†å²æ¶ˆæ¯å…¨ä¼  | âŒ æœªå®æ–½ | æ»‘åŠ¨çª—å£ |
| ğŸŸ¢ P2 | å·¥å…·ä¾èµ–é”™è¯¯ | æ— ä¾èµ–æ£€æŸ¥ | âŒ æœªå®æ–½ | ä¾èµ–å›¾ |
| ğŸŸ¢ P2 | ä¸çŸ¥ä½•æ—¶åœ | LLMæ— è‡ªæˆ‘æ„è¯† | âœ… task_done | Plannerå¤šé˜¶æ®µ |
| ğŸŸ¢ P2 | å¹¶å‘å†²çª | ä¸²è¡Œæ‰§è¡Œæ— é” | âŒ æœªå®æ–½ | æ–‡ä»¶é” |
| ğŸŸ¢ P2 | ç³»ç»Ÿæç¤ºè¯è¿‡é•¿ | å›ºå®šæç¤ºè¯ | âŒ æœªå®æ–½ | åˆ†åœºæ™¯æç¤º |

---

## ğŸ”´ P0çº§åˆ«ï¼šç”Ÿæ­»çº¿é—®é¢˜

### 1. ä¸å¬planï¼ˆå·²è§£å†³âœ…ï¼‰

**é—®é¢˜æè¿°**ï¼š
```
Planneré˜¶æ®µï¼šåªæä¾›plan_tool_call
LLMï¼š"æˆ‘è®°å¾—è¿˜æœ‰read_fileï¼Œæˆ‘å°±è°ƒå®ƒ"
ç»“æœï¼šPlanneræ¨¡å¼å½»åº•å¤±è´¥
```

**æ ¹æœ¬åŸå› **ï¼š
- `tool_choice="required"`åªè¦æ±‚"è°ƒç”¨å·¥å…·"ï¼Œä¸é™å®šæ˜¯å“ªä¸ª
- LLMä»å†å²æ¶ˆæ¯é‡Œ"è®°ä½"äº†å…¶ä»–å·¥å…·
- OpenAI APIå…è®¸è°ƒç”¨å†å²å·¥å…·

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# âœ… ç²¾ç¡®æŒ‡å®štool_choice
llm.chat(
    tools=[plan_tool_call],
    tool_choice={
        "type": "function",
        "function": {"name": "plan_tool_call"}
    }
)
```

**æ•ˆæœ**ï¼š
- æˆåŠŸç‡ä»10% â†’ 100%
- Planner-Executoræ¨¡å¼å¯è¿è¡Œ

**ç›¸å…³æ–‡æ¡£**ï¼š[tool_choiceç²¾ç¡®æŒ‡å®š](./20251026_1916_tool_choiceç²¾ç¡®æŒ‡å®š-ä»recommendedåˆ°functionçº§æ§åˆ¶.md)

---

### 2. æ­»å¾ªç¯æ£€æµ‹ï¼ˆå¾…å®æ–½âŒï¼‰

**é—®é¢˜æè¿°**ï¼š
```
read_file(ui/index.html)
â†’ think("éœ€è¦å†çœ‹ä¸€é")
â†’ read_file(ui/index.html)  # ç¬¬2æ¬¡
â†’ think("è¿˜æ˜¯ä¸è¡Œ")
â†’ read_file(ui/index.html)  # ç¬¬3æ¬¡
â†’ ...æ— é™å¾ªç¯
```

**æ ¹æœ¬åŸå› **ï¼š
- Agentä¸è®°å¾—"æˆ‘åˆšæ‰å·²ç»è°ƒç”¨è¿‡è¿™ä¸ªå·¥å…·äº†"
- LLMæ²¡æœ‰"çŸ­æœŸè®°å¿†"æœºåˆ¶
- é™·å…¥"å¼ºè¿«ç—‡"å¾ªç¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# å·¥å…·è°ƒç”¨æŒ‡çº¹
def get_tool_fingerprint(tool_name, arguments):
    """ç”Ÿæˆå·¥å…·è°ƒç”¨çš„å”¯ä¸€æŒ‡çº¹"""
    args_str = json.dumps(arguments, sort_keys=True)
    return f"{tool_name}:{hashlib.md5(args_str.encode()).hexdigest()}"

# æ£€æµ‹é‡å¤è°ƒç”¨
recent_calls = []  # æœ€è¿‘Næ¬¡è°ƒç”¨çš„æŒ‡çº¹

def detect_loop(tool_name, arguments):
    fingerprint = get_tool_fingerprint(tool_name, arguments)
    
    # æ£€æŸ¥æœ€è¿‘10æ¬¡è°ƒç”¨
    recent_10 = recent_calls[-10:]
    count = recent_10.count(fingerprint)
    
    if count >= 3:
        # åŒä¸€å·¥å…·ï¼ˆç›¸åŒå‚æ•°ï¼‰è¢«è°ƒç”¨3æ¬¡ä»¥ä¸Š
        raise LoopDetectedException(
            f"æ£€æµ‹åˆ°å¾ªç¯ï¼š{tool_name}è¢«é‡å¤è°ƒç”¨{count}æ¬¡"
        )
    
    recent_calls.append(fingerprint)
    if len(recent_calls) > 100:
        recent_calls.pop(0)  # ä¿æŒåˆ—è¡¨å¤§å°

# åœ¨execute_toolä¸­ä½¿ç”¨
def execute_tool(tool_name, arguments):
    detect_loop(tool_name, arguments)  # â† æ£€æµ‹
    result = tool_manager.execute(tool_name, arguments)
    return result
```

**æ•ˆæœé¢„æœŸ**ï¼š
- é¿å…99%çš„æ­»å¾ªç¯
- èŠ‚çœå¤§é‡Tokenå’Œæ—¶é—´
- ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡

---

### 3. æ— åœæ­¢æœºåˆ¶ï¼ˆå·²è§£å†³âœ…ï¼‰

**é—®é¢˜æè¿°**ï¼š
```
ä»»åŠ¡åœ¨ç¬¬3æ­¥å®Œæˆ
Agentç»§ç»­æ‰§è¡Œåˆ°ç¬¬30æ­¥
æµªè´¹90%çš„èµ„æº
```

**æ ¹æœ¬åŸå› **ï¼š
- å›ºå®šè¿­ä»£æ¬¡æ•°ï¼ˆmax_iterations=30ï¼‰
- LLMä¸ä¸»åŠ¨è¯´"å®Œæˆ"
- ç¼ºå°‘"ä»»åŠ¡å®Œæˆ"ä¿¡å·

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# âœ… task_doneå·¥å…·
{
    "name": "task_done",
    "description": "ä»»åŠ¡å®Œæˆæ—¶è°ƒç”¨",
    "parameters": {
        "summary": {"type": "string"}
    }
}

# Agentæ£€æµ‹
if tool_name == "task_done":
    return {"success": True, "message": summary}
```

**æ•ˆæœ**ï¼š
- å¹³å‡è¿­ä»£ä»30æ¬¡ â†’ 8.7æ¬¡ï¼ˆ-71%ï¼‰
- Tokenæ¶ˆè€—é™ä½71%
- ç”¨æˆ·100%æ”¶åˆ°æ€»ç»“

**ç›¸å…³æ–‡æ¡£**ï¼š[task_doneåœæ­¢æœºåˆ¶](./20251026_1915_task_doneåœæ­¢æœºåˆ¶-é˜²æ­¢Agentæ— é™å¾ªç¯çš„æœ€åé˜²çº¿.md)

---

## ğŸŸ¡ P1çº§åˆ«ï¼šä½“éªŒå½±å“é—®é¢˜

### 4. Contextçˆ†ç‚¸ï¼ˆéƒ¨åˆ†è§£å†³âš ï¸ï¼‰

**é—®é¢˜æè¿°**ï¼š
```
get_project_structure("huge_repo")
â†’ è¿”å›100ä¸‡å­—ç¬¦çš„ç›®å½•æ ‘
â†’ Contextç¬é—´å¡«æ»¡
â†’ åç»­å¯¹è¯æ— æ³•è¿›è¡Œ
```

**æ ¹æœ¬åŸå› **ï¼š
- å·¥å…·è¿”å›å€¼æ— é™åˆ¶
- æŸäº›å·¥å…·ï¼ˆ`list_files`, `search_code`ï¼‰å¯èƒ½è¿”å›å·¨é‡æ•°æ®
- æ²¡æœ‰ç»Ÿä¸€çš„æˆªæ–­æœºåˆ¶

**å·²å®æ–½æ–¹æ¡ˆ**ï¼š
```python
# read_fileæœ‰start_line/end_lineé™åˆ¶
read_file("large_file.py", start_line=1, end_line=100)
```

**åç»­æ–¹æ¡ˆ**ï¼š
```python
# å·¥å…·å±‚ç»Ÿä¸€æˆªæ–­
def execute_tool(tool_name, arguments):
    result = raw_execute(tool_name, arguments)
    
    # ç»Ÿä¸€æˆªæ–­
    if isinstance(result, dict) and "content" in result:
        content = result["content"]
        if len(content) > MAX_TOOL_OUTPUT:
            result["content"] = content[:MAX_TOOL_OUTPUT] + f"\n\n[æˆªæ–­ï¼ŒåŸé•¿åº¦{len(content)}å­—ç¬¦]"
            result["truncated"] = True
    
    return result

# æˆ–è‡ªåŠ¨æ‘˜è¦
def summarize_large_output(content):
    if len(content) > 10000:
        # è°ƒç”¨LLMç”Ÿæˆæ‘˜è¦
        summary = llm.chat([{
            "role": "user",
            "content": f"è¯·æ€»ç»“ä»¥ä¸‹å†…å®¹ï¼ˆä¸è¶…è¿‡500å­—ï¼‰ï¼š\n{content[:5000]}"
        }], tools=None)
        return summary["content"]
    return content
```

**æ•ˆæœé¢„æœŸ**ï¼š
- å•ä¸ªå·¥å…·è¾“å‡ºæœ€å¤š2000å­—ç¬¦
- é¿å…Contextçˆ†ç‚¸
- éœ€è¦è¯¦ç»†ä¿¡æ¯æ—¶ï¼ŒAgentå¯åˆ†æ‰¹è¯»å–

---

### 5. é”™è¯¯ç´¯ç§¯/é›ªå´©ï¼ˆå¾…å®æ–½âŒï¼‰

**é—®é¢˜æè¿°**ï¼š
```
read_file(not_exist.py) â†’ å¤±è´¥
LLM: edit_file(not_exist.py, ...)  # åŸºäº"å·²è¯»åˆ°å†…å®¹"çš„å¹»è§‰ç»§ç»­æ”¹ï¼
LLM: run_terminal("python not_exist.py")  # ç»§ç»­åŸºäºé”™è¯¯å‡è®¾
```

**æ ¹æœ¬åŸå› **ï¼š
- Agentä¸æ£€æŸ¥å·¥å…·æ‰§è¡Œç»“æœ
- ç»§ç»­åŸºäºé”™è¯¯å‡è®¾æ‰§è¡Œ
- é”™è¯¯ç´¯ç§¯ï¼Œæœ€ç»ˆä»»åŠ¡å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# è‡´å‘½é”™è¯¯æ£€æµ‹
FATAL_ERRORS = [
    "æ–‡ä»¶ä¸å­˜åœ¨",
    "æƒé™ä¸è¶³",
    "è¯­æ³•é”™è¯¯"
]

def is_fatal_error(result):
    if not result.get("success"):
        error_msg = result.get("error", "")
        return any(fatal in error_msg for fatal in FATAL_ERRORS)
    return False

# è¿ç»­å¤±è´¥æ£€æµ‹
consecutive_failures = 0

def execute_tool_with_check(tool_name, arguments):
    result = execute_tool(tool_name, arguments)
    
    if not result.get("success"):
        consecutive_failures += 1
        
        # è‡´å‘½é”™è¯¯ï¼šç«‹å³åœæ­¢
        if is_fatal_error(result):
            raise FatalErrorException(f"è‡´å‘½é”™è¯¯ï¼š{result['error']}")
        
        # è¿ç»­å¤±è´¥3æ¬¡ï¼šåœæ­¢
        if consecutive_failures >= 3:
            raise TooManyFailuresException("è¿ç»­3æ¬¡å·¥å…·è°ƒç”¨å¤±è´¥")
    else:
        consecutive_failures = 0
    
    return result
```

**æ•ˆæœé¢„æœŸ**ï¼š
- é¿å…åŸºäºé”™è¯¯å‡è®¾ç»§ç»­æ‰§è¡Œ
- èŠ‚çœTokenï¼ˆä¸æµªè´¹åœ¨æ³¨å®šå¤±è´¥çš„ä»»åŠ¡ä¸Šï¼‰
- æ›´æ—©åœ°ç»™ç”¨æˆ·åé¦ˆ

---

## ğŸŸ¢ P2çº§åˆ«ï¼šä¼˜åŒ–æå‡é—®é¢˜

### 6. Tokenæµªè´¹ï¼ˆå¾…å®æ–½âŒï¼‰

**é—®é¢˜æè¿°**ï¼š
```
ç¬¬1æ¬¡è¿­ä»£ï¼š64æ¡æ¶ˆæ¯
ç¬¬2æ¬¡è¿­ä»£ï¼š66æ¡æ¶ˆæ¯ï¼ˆåŒ…å«å‰64æ¡ï¼‰
ç¬¬30æ¬¡è¿­ä»£ï¼š122æ¡æ¶ˆæ¯ï¼ˆåŒ…å«å‰120æ¡ï¼‰
â†’ å¤§é‡é‡å¤ä¼ è¾“
```

**æ ¹æœ¬åŸå› **ï¼š
- æ¯æ¬¡è°ƒç”¨LLMéƒ½ä¼ å®Œæ•´å†å²
- æ—©æœŸå¯¹è¯å¯¹å½“å‰ä»»åŠ¡æ— ç”¨
- Context Managementç¼ºå¤±

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# æ»‘åŠ¨çª—å£ç­–ç•¥
def get_recent_messages(all_messages, window_size=10):
    """ä¿ç•™æœ€è¿‘Nè½®å¯¹è¯"""
    # 1. ä¿ç•™system message
    system_msg = [m for m in all_messages if m["role"] == "system"]
    
    # 2. ä¿ç•™æœ€è¿‘Nè½®ï¼ˆuser-assistantå¯¹ï¼‰
    recent_pairs = []
    for i in range(len(all_messages) - 1, -1, -1):
        if all_messages[i]["role"] == "user":
            # æ‰¾åˆ°ä¸€ä¸ªuseræ¶ˆæ¯ï¼Œæ”¶é›†åˆ°ä¸‹ä¸€ä¸ªuserå‰çš„æ‰€æœ‰æ¶ˆæ¯
            pair = []
            j = i
            while j < len(all_messages) and (
                all_messages[j]["role"] != "user" or j == i
            ):
                pair.append(all_messages[j])
                j += 1
            recent_pairs.insert(0, pair)
            
            if len(recent_pairs) >= window_size:
                break
    
    # 3. ç»„åˆ
    result = system_msg + [msg for pair in recent_pairs for msg in pair]
    return result

# åœ¨agent.runä¸­ä½¿ç”¨
messages = get_recent_messages(all_messages, window_size=10)
llm_response = llm.chat(messages, ...)
```

**æ•ˆæœé¢„æœŸ**ï¼š
- Tokenæ¶ˆè€—å‡å°‘40-60%
- å“åº”é€Ÿåº¦æå‡ï¼ˆmessagesæ›´çŸ­ï¼‰
- Contextèšç„¦åœ¨ç›¸å…³ä¿¡æ¯

---

### 7. å·¥å…·ä¾èµ–é¡ºåºé”™è¯¯ï¼ˆå¾…å®æ–½âŒï¼‰

**é—®é¢˜æè¿°**ï¼š
```
ç”¨æˆ·ï¼š"æŠŠæ‰€æœ‰pyæ–‡ä»¶é‡Œçš„printæ”¹æˆlogging"
LLM: edit_file(main.py)  # æ²¡è¯»è¿‡main.pyï¼Œå‡­ç©ºä¿®æ”¹ï¼
```

**æ ¹æœ¬åŸå› **ï¼š
- Agentä¸æ£€æŸ¥å·¥å…·ä¾èµ–
- `edit_file`åº”è¯¥åœ¨`read_file`ä¹‹å
- æ²¡æœ‰"å…ˆè¯»åå†™"çš„çº¦æŸ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# å·¥å…·ä¾èµ–å›¾
TOOL_DEPENDENCIES = {
    "edit_file": ["read_file"],  # editå‰å¿…é¡»read
    "run_terminal": [],          # æ— ä¾èµ–
    "search_code": []
}

# æ£€æŸ¥ä¾èµ–
executed_tools = set()

def check_dependencies(tool_name, arguments):
    deps = TOOL_DEPENDENCIES.get(tool_name, [])
    
    for dep in deps:
        if dep == "read_file" and tool_name == "edit_file":
            # æ£€æŸ¥æ˜¯å¦è¯»è¿‡è¿™ä¸ªæ–‡ä»¶
            file_path = arguments.get("path")
            if not has_read_file(file_path):
                raise DependencyException(
                    f"edit_file({file_path})å‰å¿…é¡»å…ˆread_file({file_path})"
                )
    
    executed_tools.add(tool_name)

def has_read_file(path):
    # æ£€æŸ¥executed_toolsé‡Œæ˜¯å¦æœ‰read_file(path)
    # å®é™…å®ç°éœ€è¦æ›´å¤æ‚çš„é€»è¾‘
    return f"read_file:{path}" in executed_tools
```

**æ•ˆæœé¢„æœŸ**ï¼š
- é¿å…"ç›²ç›®ä¿®æ”¹"
- æå‡å·¥å…·è°ƒç”¨è´¨é‡
- å‡å°‘é”™è¯¯ç‡

---

### 8. ä¸çŸ¥ä½•æ—¶åœï¼ˆå·²è§£å†³âœ…ï¼‰

**å·²é€šè¿‡task_doneè§£å†³**ï¼Œè§é—®é¢˜3ã€‚

---

### 9. å¹¶å‘å†²çªï¼ˆå¾…å®æ–½âŒï¼‰

**é—®é¢˜æè¿°**ï¼š
```
åŒä¸€æ–‡ä»¶è¢«å¤šæ¬¡ç¼–è¾‘ï¼š
edit_file(main.py, line 10)
edit_file(main.py, line 20)  # å¦‚æœåŸºäºæ—§å†…å®¹ï¼Œline 20ä½ç½®å¯èƒ½å·²å˜ï¼
```

**æ ¹æœ¬åŸå› **ï¼š
- ä¸²è¡Œæ‰§è¡Œï¼Œä½†æ— æ–‡ä»¶é”
- `edit_file_batch`å¯èƒ½æœ‰å†…éƒ¨å†²çª
- ç¼ºå°‘"è¯»-æ”¹-å†™"åŸå­æ€§

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# æ–‡ä»¶é”æœºåˆ¶
import threading

file_locks = {}

def get_file_lock(file_path):
    if file_path not in file_locks:
        file_locks[file_path] = threading.Lock()
    return file_locks[file_path]

def edit_file_with_lock(path, edits):
    lock = get_file_lock(path)
    
    with lock:
        # 1. è¯»å–æœ€æ–°å†…å®¹
        content = read_file(path)
        
        # 2. åº”ç”¨ç¼–è¾‘
        for edit in edits:
            content = content.replace(edit["old"], edit["new"])
        
        # 3. å†™å›
        write_file(path, content)
    
    return {"success": True}
```

**æ•ˆæœé¢„æœŸ**ï¼š
- é¿å…æ–‡ä»¶ä¿®æ”¹å†²çª
- æ”¯æŒæœªæ¥çš„å¹¶è¡Œæ‰§è¡Œ
- æå‡ç¨³å®šæ€§

---

### 10. ç³»ç»Ÿæç¤ºè¯è¿‡é•¿ï¼ˆå¾…å®æ–½âŒï¼‰

**é—®é¢˜æè¿°**ï¼š
```
AGENT_SYSTEM_PROMPT = 6500 tokens
æ¯æ¬¡è°ƒç”¨éƒ½å ç”¨
å¤§é‡Contextæµªè´¹åœ¨å›ºå®šå†…å®¹ä¸Š
```

**æ ¹æœ¬åŸå› **ï¼š
- ç³»ç»Ÿæç¤ºè¯åŒ…å«æ‰€æœ‰åœºæ™¯çš„æŒ‡ä»¤
- Planneré˜¶æ®µå’ŒExecuteé˜¶æ®µå…¶å®éœ€è¦ä¸åŒçš„æç¤ºè¯
- æ²¡æœ‰åˆ†åœºæ™¯ä¼˜åŒ–

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# åˆ†åœºæ™¯æç¤ºè¯
PLANNER_PROMPT = """
ä½ ç°åœ¨å¤„äºè§„åˆ’é˜¶æ®µã€‚ä½ çš„ä»»åŠ¡æ˜¯ï¼š
1. åˆ†æç”¨æˆ·è¯·æ±‚
2. è§„åˆ’1-8ä¸ªæ‰§è¡Œæ­¥éª¤
3. è°ƒç”¨plan_tool_callå·¥å…·

ä¸è¦ç›´æ¥æ‰§è¡Œå·¥å…·ï¼Œåªè§„åˆ’ï¼
"""

EXECUTOR_PROMPT = """
ä½ ç°åœ¨å¤„äºæ‰§è¡Œé˜¶æ®µã€‚ä½ çš„ä»»åŠ¡æ˜¯ï¼š
1. æ‰§è¡Œå·²è§„åˆ’çš„æ­¥éª¤
2. æ ¹æ®ç»“æœè°ƒæ•´åç»­æ­¥éª¤
3. ä»»åŠ¡å®Œæˆæ—¶è°ƒç”¨task_done

æ³¨æ„"å…ˆè¯»åå†™"çš„åŸåˆ™ï¼
"""

# åŠ¨æ€é€‰æ‹©
def get_system_prompt(phase):
    if phase == "planner":
        return PLANNER_PROMPT
    elif phase == "executor":
        return EXECUTOR_PROMPT
    else:
        return DEFAULT_PROMPT
```

**æ•ˆæœé¢„æœŸ**ï¼š
- System Messageä»6500 tokens â†’ 2000 tokensï¼ˆ-69%ï¼‰
- Contextæ›´èšç„¦
- æ¯æ¬¡è°ƒç”¨èŠ‚çœ4500 tokens

---

## ğŸ“Š é—®é¢˜ä¼˜å…ˆçº§çŸ©é˜µ

### å½±å“-ç´§æ€¥åº¦åˆ†æ

```
é«˜å½±å“ â”ƒ â‘  ä¸å¬plan        â‘¢ æ— åœæ­¢æœºåˆ¶
      â”ƒ (å·²è§£å†³)         (å·²è§£å†³)
      â”ƒ
      â”ƒ â‘¡ æ­»å¾ªç¯æ£€æµ‹      â‘£ Contextçˆ†ç‚¸
      â”ƒ (å¾…å®æ–½)         (éƒ¨åˆ†è§£å†³)
      â”ƒ
      â”ƒ â‘¤ é”™è¯¯ç´¯ç§¯
      â”ƒ (å¾…å®æ–½)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä½å½±å“ â”ƒ â‘¥ Tokenæµªè´¹      â‘¦ ä¾èµ–é”™è¯¯
      â”ƒ (å¾…å®æ–½)         (å¾…å®æ–½)
      â”ƒ
      â”ƒ â‘¨ å¹¶å‘å†²çª       â‘© æç¤ºè¯é•¿
      â”ƒ (å¾…å®æ–½)         (å¾…å®æ–½)
      â”ƒ
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
         ä½ç´§æ€¥åº¦           é«˜ç´§æ€¥åº¦
```

---

## ğŸ—ºï¸ å®æ–½Roadmap

### Phase 1ï¼šP0çº§åˆ«ï¼ˆ1-2å‘¨ï¼‰
- [x] ä¸å¬plan â†’ ç²¾ç¡®æŒ‡å®štool_choice âœ…
- [ ] æ­»å¾ªç¯æ£€æµ‹ â†’ å·¥å…·æŒ‡çº¹+è®¡æ•°å™¨
- [x] æ— åœæ­¢æœºåˆ¶ â†’ task_done âœ…

---

### Phase 2ï¼šP1çº§åˆ«ï¼ˆ2-3å‘¨ï¼‰
- [ ] Contextçˆ†ç‚¸ â†’ ç»Ÿä¸€æˆªæ–­+è‡ªåŠ¨æ‘˜è¦
- [ ] é”™è¯¯ç´¯ç§¯ â†’ è‡´å‘½é”™è¯¯æ£€æµ‹+è¿ç»­å¤±è´¥é˜ˆå€¼

---

### Phase 3ï¼šP2çº§åˆ«ï¼ˆ3-4å‘¨ï¼‰
- [ ] Tokenæµªè´¹ â†’ æ»‘åŠ¨çª—å£ç­–ç•¥
- [ ] å·¥å…·ä¾èµ– â†’ ä¾èµ–å›¾éªŒè¯
- [ ] å¹¶å‘å†²çª â†’ æ–‡ä»¶é”
- [ ] æç¤ºè¯é•¿ â†’ åˆ†åœºæ™¯æç¤ºè¯

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### é‡åŒ–æŒ‡æ ‡

| æŒ‡æ ‡ | Before | After (Phase 1) | After (Phase 3) | æ”¹å–„ |
|------|--------|----------------|----------------|------|
| PlanneræˆåŠŸç‡ | 10% | 100% | 100% | +900% |
| å¹³å‡è¿­ä»£æ¬¡æ•° | 30 | 8.7 | 6 | -80% |
| Tokenæ¶ˆè€— | 28K | 8K | 4.5K | -84% |
| å“åº”æ—¶é—´ | 120ç§’ | 35ç§’ | 20ç§’ | -83% |
| ä»»åŠ¡æˆåŠŸç‡ | 45% | 85% | 95% | +111% |
| æ­»å¾ªç¯å‘ç”Ÿç‡ | 15% | 15% | <1% | -93% |

---

### è´¨åŒ–æŒ‡æ ‡

**Phase 1ï¼ˆå·²å®Œæˆï¼‰**ï¼š
- âœ… Planner-Executoræ¨¡å¼å¯è¿è¡Œ
- âœ… ç”¨æˆ·100%æ”¶åˆ°ä»»åŠ¡æ€»ç»“
- âœ… èµ„æºæ¶ˆè€—å¯æ§

**Phase 2ï¼ˆå¾…å®æ–½ï¼‰**ï¼š
- âœ… é¿å…Contextçˆ†ç‚¸å¯¼è‡´çš„æœåŠ¡ä¸­æ–­
- âœ… æ›´æ—©åœ°å‘ç°è‡´å‘½é”™è¯¯å¹¶åé¦ˆ
- âœ… å‡å°‘åŸºäºé”™è¯¯å‡è®¾çš„æ— æ•ˆæ“ä½œ

**Phase 3ï¼ˆå¾…å®æ–½ï¼‰**ï¼š
- âœ… Tokenæˆæœ¬é™ä½åˆ°æœ€ä¼˜
- âœ… å·¥å…·è°ƒç”¨è´¨é‡æ¥è¿‘ä¸“å®¶çº§
- âœ… ç³»ç»Ÿå¯æ‰©å±•æ€§å¤§å¹…æå‡

---

## ğŸ’¡ è®¾è®¡åŸåˆ™æ€»ç»“

ä»è¿™10ä¸ªé—®é¢˜ä¸­ï¼Œæˆ‘ä»¬æç‚¼å‡º**Agentè®¾è®¡çš„5å¤§åŸåˆ™**ï¼š

### 1. æ˜ç¡®æ€§åŸåˆ™
- **é—®é¢˜**ï¼šä¸å¬planã€å·¥å…·ä¾èµ–é”™è¯¯
- **åŸåˆ™**ï¼šæ˜ç¡®æŒ‡å®šLLMçš„è¡Œä¸ºï¼ˆtool_choiceç²¾ç¡®æŒ‡å®šã€ä¾èµ–æ£€æŸ¥ï¼‰
- **æ•™è®­**ï¼šä¸è¦ä¾èµ–LLM"è‡ªè§‰"

---

### 2. ç»ˆæ­¢æ€§åŸåˆ™
- **é—®é¢˜**ï¼šæ— åœæ­¢æœºåˆ¶ã€æ­»å¾ªç¯æ£€æµ‹
- **åŸåˆ™**ï¼šAgentå¿…é¡»æœ‰å¤šå±‚åœæ­¢æœºåˆ¶ï¼ˆtask_doneã€é‡å¤æ£€æµ‹ã€max_iterationsï¼‰
- **æ•™è®­**ï¼šå¿…é¡»ä¿è¯Agentèƒ½åœä¸‹æ¥

---

### 3. å®¹é”™æ€§åŸåˆ™
- **é—®é¢˜**ï¼šé”™è¯¯ç´¯ç§¯ã€å¹¶å‘å†²çª
- **åŸåˆ™**ï¼šæ£€æµ‹é”™è¯¯ã€åŠæ—©åœæ­¢ã€éš”ç¦»å½±å“
- **æ•™è®­**ï¼šé”™è¯¯æ˜¯å¸¸æ€ï¼Œç³»ç»Ÿå¿…é¡»å¥å£®

---

### 4. ç»æµæ€§åŸåˆ™
- **é—®é¢˜**ï¼šTokenæµªè´¹ã€Contextçˆ†ç‚¸
- **åŸåˆ™**ï¼šæœ€å°åŒ–èµ„æºæ¶ˆè€—ã€ç²¾å‡†ä½¿ç”¨Context
- **æ•™è®­**ï¼šTokenæ˜¯ç¨€ç¼ºèµ„æºï¼Œå¿…é¡»ä¼˜åŒ–

---

### 5. å¯è§‚æµ‹æ€§åŸåˆ™
- **é—®é¢˜**ï¼šæ‰€æœ‰é—®é¢˜çš„è°ƒè¯•
- **åŸåˆ™**ï¼šè¯¦ç»†æ—¥å¿—ã€åˆ†é˜¶æ®µåé¦ˆã€å‰ç«¯å¯è§†åŒ–
- **æ•™è®­**ï¼šçœ‹ä¸è§çš„ç³»ç»Ÿæ— æ³•ä¼˜åŒ–

---

## ğŸ”¬ ç†è®ºæ”¯æ’‘

### æ§åˆ¶ç†è®ºè§†è§’

**Agentæ˜¯ä¸€ä¸ªæ§åˆ¶ç³»ç»Ÿ**ï¼š
```
è¾“å…¥ï¼ˆç”¨æˆ·è¯·æ±‚ï¼‰â†’ æ§åˆ¶å™¨ï¼ˆLLMï¼‰ â†’ æ‰§è¡Œå™¨ï¼ˆå·¥å…·ï¼‰ â†’ è¾“å‡ºï¼ˆç»“æœï¼‰
                    â†‘                               â†“
                    â””â”€â”€â”€â”€â”€â”€â”€â”€ åé¦ˆå›è·¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**10å¤§é—®é¢˜çš„æœ¬è´¨**ï¼š
1. â‘  â‘¦ **æ§åˆ¶ç²¾åº¦**ï¼šæ§åˆ¶å™¨æ— æ³•ç²¾ç¡®æ§åˆ¶æ‰§è¡Œå™¨
2. â‘¡ â‘§ **åé¦ˆå¤±æ•ˆ**ï¼šåé¦ˆå›è·¯æ²¡æœ‰"åœæ­¢"ä¿¡å·
3. â‘£ â‘¤ **çŠ¶æ€çˆ†ç‚¸**ï¼šç³»ç»ŸçŠ¶æ€æ— ç•Œå¢é•¿
4. â‘¢ **èµ„æºè€—å°½**ï¼šæ— åœæ­¢æ¡ä»¶ï¼Œèµ„æºè€—å°½
5. â‘¥ â‘© **æ•ˆç‡ä½ä¸‹**ï¼šå†—ä½™ä¿¡æ¯å ç”¨å¸¦å®½

**è§£å†³æ–¹å‘**ï¼š
- å¢å¼ºæ§åˆ¶ç²¾åº¦ï¼ˆtool_choiceç²¾ç¡®æŒ‡å®šï¼‰
- å®Œå–„åé¦ˆå›è·¯ï¼ˆtask_doneã€æ­»å¾ªç¯æ£€æµ‹ï¼‰
- é™åˆ¶çŠ¶æ€ç©ºé—´ï¼ˆContextæˆªæ–­ã€æ»‘åŠ¨çª—å£ï¼‰
- ä¼˜åŒ–ä¿¡æ¯æµï¼ˆåˆ†åœºæ™¯æç¤ºè¯ã€Tokenä¼˜åŒ–ï¼‰

---

### è½¯ä»¶å·¥ç¨‹è§†è§’

**Agentæ˜¯ä¸€ä¸ªå¼‚æ­¥ç³»ç»Ÿ**ï¼š
```
é—®é¢˜ç±»å‹ï¼š
- â‘  â‘¡ â‘¨ å¹¶å‘/ç«æ€é—®é¢˜
- â‘¢ â‘§ ç”Ÿå‘½å‘¨æœŸç®¡ç†é—®é¢˜
- â‘£ â‘¤ é”™è¯¯å¤„ç†é—®é¢˜
- â‘¥ â‘© æ€§èƒ½ä¼˜åŒ–é—®é¢˜
- â‘¦ ä¾èµ–ç®¡ç†é—®é¢˜
```

**é€šç”¨è§£å†³æ–¹æ¡ˆ**ï¼š
- **å¹¶å‘**ï¼šé”ã€åŸå­æ“ä½œ
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šæ˜ç¡®çš„init/run/stop
- **é”™è¯¯å¤„ç†**ï¼šåˆ†çº§ï¼ˆinfo/warn/error/fatalï¼‰
- **æ€§èƒ½**ï¼šç¼“å­˜ã€çª—å£ã€æ‰¹å¤„ç†
- **ä¾èµ–**ï¼šDAGå›¾ã€æ‹“æ‰‘æ’åº

---

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

### Phase 1ï¼ˆå·²å®Œæˆï¼‰
- [x] PlanneræˆåŠŸç‡ 100%
- [x] å¹³å‡è¿­ä»£æ¬¡æ•° < 10
- [x] ç”¨æˆ·å¿…å®šæ”¶åˆ°æ€»ç»“

### Phase 2ï¼ˆå¾…éªŒè¯ï¼‰
- [ ] æ­»å¾ªç¯å‘ç”Ÿç‡ < 1%
- [ ] Contextçˆ†ç‚¸æ¬¡æ•° 0
- [ ] è‡´å‘½é”™è¯¯æ—©æœŸè¯†åˆ«ç‡ > 90%

### Phase 3ï¼ˆå¾…éªŒè¯ï¼‰
- [ ] Tokenæ¶ˆè€—é™ä½ > 80%
- [ ] å·¥å…·è°ƒç”¨é”™è¯¯ç‡ < 5%
- [ ] ç³»ç»Ÿç¨³å®šè¿è¡Œ > 99.9%

---

## ğŸ’¬ æ€»ç»“

**è¿™10ä¸ªé—®é¢˜ä¸æ˜¯å­¤ç«‹çš„ï¼Œå®ƒä»¬æ˜¯Agentå¥å£®æ€§çš„ä¸åŒä¾§é¢ã€‚**

é€šè¿‡**ç³»ç»ŸåŒ–åœ°è¯†åˆ«å’Œè§£å†³**è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬ï¼š
1. âœ… å»ºç«‹äº†Agentè®¾è®¡çš„5å¤§åŸåˆ™
2. âœ… å®Œæˆäº†P0çº§åˆ«çš„å…³é”®ä¿®å¤ï¼ˆ3/3ï¼‰
3. âš ï¸ è§„åˆ’äº†P1/P2çº§åˆ«çš„ä¼˜åŒ–è·¯å¾„ï¼ˆ0/7ï¼‰
4. ğŸ“Š é¢„æœŸæœ€ç»ˆæ•ˆæœï¼šTokené™ä½84%ï¼ŒæˆåŠŸç‡æå‡111%

**è¿™æ˜¯ä»"èƒ½ç”¨"åˆ°"å¥½ç”¨"å†åˆ°"å¯é "çš„æ¼”è¿›ä¹‹è·¯ã€‚**

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å·¥å…·ç²¾ç®€çš„è®¤çŸ¥è´Ÿè·ç†è®º](./20251026_1914_å·¥å…·ç²¾ç®€çš„è®¤çŸ¥è´Ÿè·ç†è®º.md)
- [task_doneåœæ­¢æœºåˆ¶](./20251026_1915_task_doneåœæ­¢æœºåˆ¶-é˜²æ­¢Agentæ— é™å¾ªç¯çš„æœ€åé˜²çº¿.md)
- [tool_choiceç²¾ç¡®æŒ‡å®š](./20251026_1916_tool_choiceç²¾ç¡®æŒ‡å®š-ä»recommendedåˆ°functionçº§æ§åˆ¶.md)
- [Messagesåè®®é”™è¯¯](./20251026_1917_Messagesåè®®é”™è¯¯-toolè§’è‰²æ¶ˆæ¯çš„å‰ç½®æ¡ä»¶.md)
- [Plan-Execute-Thinkå¾ªç¯æ–¹æ¡ˆ](./20251026_1900_Plan-Execute-Thinkå¾ªç¯æ–¹æ¡ˆ.md)

---

## ğŸ“ é™„å½•ï¼šé—®é¢˜æ£€æŸ¥æ¸…å•

**æ–°Agentå¼€å‘æ—¶ï¼Œè¯·é€é¡¹æ£€æŸ¥**ï¼š

```
â–¡ tool_choiceæ˜¯å¦ç²¾ç¡®æŒ‡å®šï¼ˆå¦‚æœéœ€è¦å¼ºåˆ¶å·¥å…·ï¼‰ï¼Ÿ
â–¡ æ˜¯å¦æœ‰task_doneæˆ–ç±»ä¼¼çš„åœæ­¢æœºåˆ¶ï¼Ÿ
â–¡ æ˜¯å¦æœ‰æ­»å¾ªç¯æ£€æµ‹ï¼ˆå·¥å…·é‡å¤è°ƒç”¨ï¼‰ï¼Ÿ
â–¡ å·¥å…·è¾“å‡ºæ˜¯å¦æœ‰é•¿åº¦é™åˆ¶ï¼Ÿ
â–¡ æ˜¯å¦æ£€æµ‹è‡´å‘½é”™è¯¯å¹¶åŠæ—©åœæ­¢ï¼Ÿ
â–¡ æ˜¯å¦ä½¿ç”¨æ»‘åŠ¨çª—å£å‡å°‘Tokenæ¶ˆè€—ï¼Ÿ
â–¡ edit_fileå‰æ˜¯å¦æ£€æŸ¥read_fileä¾èµ–ï¼Ÿ
â–¡ æ˜¯å¦æœ‰æ–‡ä»¶é”é˜²æ­¢å¹¶å‘å†²çªï¼Ÿ
â–¡ ç³»ç»Ÿæç¤ºè¯æ˜¯å¦åˆ†åœºæ™¯ä¼˜åŒ–ï¼Ÿ
â–¡ æ˜¯å¦æœ‰è¯¦ç»†çš„æ—¥å¿—å’Œå‰ç«¯å¯è§†åŒ–ï¼Ÿ
```

**å¦‚æœ10é¡¹å…¨éƒ¨âˆšï¼Œæ­å–œï¼Œä½ çš„Agentå°†éå¸¸å¥å£®ï¼**

