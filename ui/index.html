<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AIç¼–ç¨‹åŠ©æ‰‹</title>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #f5f5f5; height: 100vh; }
        .container { width: 100%; height: 100vh; background: #fff; display: flex; flex-direction: column; }

        /* å·¥ä½œç©ºé—´Tabæ  */
        .workspace-tabs { background: #1a1a1a; padding: 0 20px; display: flex; gap: 3px; overflow-x: auto; border-bottom: 2px solid #000; }
        .workspace-tab { padding: 10px 20px; background: transparent; border: none; color: #999; font-size: 12px; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; }
        .workspace-tab:hover { color: #fff; }
        .workspace-tab.active { color: #fff; border-bottom-color: #4caf50; background: rgba(255,255,255,0.05); }
        .workspace-tab-new { background: #2c2c2c; color: #4caf50; }
        .workspace-path { font-size: 10px; color: #666; margin-top: 2px; }
        
        /* æ¨¡å—Tab */
        .module-tabs { background: #2c2c2c; padding: 0 30px; display: flex; border-bottom: 1px solid #1a1a1a; }
        .module-tab { padding: 12px 24px; background: transparent; border: none; color: #999; font-size: 13px; cursor: pointer; border-bottom: 2px solid transparent; }
        .module-tab:hover { color: #fff; }
        .module-tab.active { color: #fff; border-bottom-color: #fff; }
        
        /* å¯¹è¯Tab */
        .conversation-tabs { background: #f5f5f5; padding: 8px 20px; display: flex; gap: 8px; overflow-x: auto; border-bottom: 1px solid #ddd; }
        .conversation-tab { padding: 8px 16px; background: #fff; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; cursor: pointer; }
        .conversation-tab:hover { background: #f8f8f8; }
        .conversation-tab.active { background: #2c2c2c; color: #fff; border-color: #2c2c2c; }
        .conversation-tab.new { background: #4caf50; color: #fff; border-color: #4caf50; }
        
        /* å†…å®¹Tab */
        .content-tabs { background: #fafafa; padding: 0 20px; display: flex; border-bottom: 1px solid #e0e0e0; }
        .content-tab { padding: 10px 20px; background: transparent; border: none; color: #666; font-size: 12px; cursor: pointer; border-bottom: 2px solid transparent; }
        .content-tab:hover { color: #2c2c2c; }
        .content-tab.active { color: #2c2c2c; border-bottom-color: #2c2c2c; font-weight: 500; }
        
        /* èŠå¤©åŒºåŸŸ */
        .chat-area { flex: 1; overflow-y: auto; padding: 30px 40px; background: #fafafa; }
        .message { margin-bottom: 20px; }
        .message.user { display: flex; justify-content: flex-end; }
        .message.assistant { display: flex; justify-content: flex-start; }
        .message-content { max-width: 75%; padding: 12px 18px; border-radius: 4px; line-height: 1.3; font-size: 14px; }
        .message.user .message-content { background: #2c2c2c; color: #fff; border-left: 3px solid #666; }
        .message.assistant .message-content { background: #fff; color: #2c2c2c; border-left: 3px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        
        .input-area { padding: 20px 30px; background: #fff; border-top: 1px solid #e0e0e0; }
        .input-container { display: flex; gap: 12px; align-items: center; }
        .input-field { flex: 1; padding: 12px 18px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px; background: #fafafa; }
        .input-field:focus { outline: none; border-color: #666; background: #fff; }
        .btn-send { padding: 12px 30px; background: #2c2c2c; color: #fff; border: none; border-radius: 3px; cursor: pointer; }
        .btn-send:hover { background: #1a1a1a; }
        .btn-send:disabled { opacity: 0.5; }
        
        .context-usage { display: flex; align-items: center; gap: 8px; margin-left: 15px; }
        .circle-progress { position: relative; width: 40px; height: 40px; }
        .circle-progress svg { transform: rotate(-90deg); }
        .circle-bg { fill: none; stroke: #e0e0e0; stroke-width: 3; }
        .circle-fill { fill: none; stroke: #2c2c2c; stroke-width: 3; stroke-linecap: round; transition: stroke-dashoffset 0.3s; }
        .circle-fill.warning { stroke: #ff9800; }
        .circle-fill.danger { stroke: #f44336; }
        .circle-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; font-weight: 600; }
        
        .thinking { text-align: center; padding: 15px; color: #666; font-style: italic; font-size: 13px; }
        .empty-state { text-align: center; padding: 80px 20px; color: #999; }
        .empty-state h2 { font-size: 48px; margin-bottom: 15px; font-weight: 300; }
        
        .panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { padding: 20px 30px; background: #fafafa; border-bottom: 1px solid #e0e0e0; }
        .panel-header h3 { font-size: 16px; font-weight: 500; color: #2c2c2c; margin-bottom: 5px; }
        .panel-header p { font-size: 12px; color: #666; }
        .panel-content { flex: 1; overflow-y: auto; padding: 20px 30px; }
        
        .stat-box { background: #fff; border: 1px solid #ddd; border-radius: 3px; padding: 15px; margin-bottom: 15px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 13px; }
        .stat-label { color: #666; }
        .stat-value { font-weight: 500; color: #2c2c2c; }
        
        .message-list { background: #fff; border: 1px solid #ddd; border-radius: 3px; padding: 15px; max-height: 500px; overflow-y: auto; }
        .message-item { padding: 12px; margin-bottom: 12px; border-left: 3px solid #ddd; border-radius: 3px; }
        .message-item.user { background: #2c2c2c; color: #fff; border-left-color: #666; }
        .message-item.assistant { background: #fff; border: 1px solid #e0e0e0; }
        .message-header { font-size: 11px; opacity: 0.7; margin-bottom: 8px; }
        .message-text { font-size: 13px; line-height: 1.3; white-space: pre-wrap; font-family: Consolas, monospace; }
        
        .btn-action { padding: 8px 16px; background: #2c2c2c; color: #fff; border: none; border-radius: 3px; font-size: 12px; cursor: pointer; }
        .btn-action:hover { background: #1a1a1a; }
        .btn-secondary { background: #fff; color: #2c2c2c; border: 1px solid #ddd; }
        .btn-secondary:hover { background: #f5f5f5; }
        
        .footer-controls { padding: 10px 30px; background: #f5f5f5; border-top: 1px solid #e0e0e0; display: flex; justify-content: center; gap: 15px; }
        .btn-zoom { padding: 4px 12px; background: #fff; border: 1px solid #ddd; color: #333; border-radius: 2px; font-size: 11px; cursor: pointer; }
        .btn-zoom:hover { background: #2c2c2c; color: #fff; }
        
        .editable-name { cursor: pointer; display: inline-block; padding: 2px 6px; border-radius: 2px; }
        .editable-name:hover { background: rgba(255,255,255,0.1); }
        
        /* æµå¼æ¸²æŸ“åŠ¨ç”» */
        @keyframes fadeInPulse {
            0% { opacity: 0; transform: scale(0.95); }
            50% { opacity: 0.5; transform: scale(1.02); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* æ‰§è¡Œä¸­æŒ‡ç¤ºå™¨ */
        .executing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 12px;
            font-size: 11px;
            color: #856404;
            font-weight: 500;
            animation: slideInUp 0.3s ease;
        }
        
        .executing-indicator .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid #ffc107;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Level 1: å·¥ä½œç©ºé—´Tab -->
        <div class="workspace-tabs" id="workspaceTabs">
            <button class="workspace-tab active">
                <div class="editable-name" ondblclick="editWorkspaceName(this)" data-id="">å·¥ä½œç©ºé—´ 1</div>
                <div class="workspace-path">C:\Projects\MyAgent</div>
            </button>
            <button class="workspace-tab workspace-tab-new" onclick="addWorkspace()">+ æ·»åŠ å·¥ä½œç©ºé—´</button>
        </div>

        <!-- Level 2: æ¨¡å—Tab -->
        <div class="module-tabs">
            <button class="module-tab active" onclick="switchModule('conversation')">å¯¹è¯ç®¡ç†</button>
            <button class="module-tab" onclick="switchModule('history')">èŠå¤©è®°å½•ç®¡ç†</button>
        </div>

        <!-- å¯¹è¯ç®¡ç†æ¨¡å— -->
        <div id="conversationModule" style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
            <!-- Level 3: å¯¹è¯Tab -->
            <div class="conversation-tabs" id="conversationTabs">
                <button class="conversation-tab active">
                    <span class="editable-name" ondblclick="editConversationName(this)" data-id="">å¯¹è¯ 1</span>
                </button>
                <button class="conversation-tab new" onclick="createConversation()">+ æ–°å»ºå¯¹è¯</button>
            </div>

            <!-- Level 4: å†…å®¹Tab -->
            <div class="content-tabs">
                <button class="content-tab active" onclick="switchContent('chat')">å¯¹è¯è¯¦æƒ…</button>
                <button class="content-tab" onclick="switchContent('context')">Contexté¢„è§ˆ</button>
                <button class="content-tab" onclick="switchContent('test')">æµ‹è¯•</button>
            </div>

            <!-- å¯¹è¯è¯¦æƒ… -->
            <div id="chatPanel" class="panel">
                <div class="chat-area" id="chatArea">
                    <div class="empty-state"><h2>ğŸ“–</h2><p>å¼€å§‹å¯¹è¯</p></div>
                </div>
                <div class="input-area">
                    <div class="input-container">
                        <input class="input-field" id="messageInput" placeholder="æè¿°ä½ çš„éœ€æ±‚..." onkeypress="if(event.key==='Enter')sendMessage()">
                        <button class="btn-send" onclick="sendMessage()" id="sendBtn">å‘é€</button>
                        <div class="context-usage">
                            <div class="circle-progress">
                                <svg width="40" height="40">
                                    <circle class="circle-bg" cx="20" cy="20" r="16"></circle>
                                    <circle class="circle-fill" id="contextCircle" cx="20" cy="20" r="16" stroke-dasharray="100.48" stroke-dashoffset="100.48"></circle>
                                </svg>
                                <div class="circle-text" id="contextPercent">0%</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #999;">Context</div>
                                <div style="font-size: 12px; font-weight: 500;" id="contextTokens">0K/131K</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contexté¢„è§ˆ -->
            <div id="contextPanel" class="panel" style="display: none;">
                <div class="panel-header">
                    <h3>Context é¢„è§ˆ</h3>
                    <p>å½“å‰å¯¹è¯çš„Context</p>
                </div>
                <div class="panel-content">
                    <div class="stat-box">
                        <div class="stat-row"><span class="stat-label">æç¤ºTokens</span><span class="stat-value"><span id="promptTokens">0</span>K</span></div>
                        <div class="stat-row"><span class="stat-label">å®ŒæˆTokens</span><span class="stat-value"><span id="completionTokens">0</span>K</span></div>
                        <div class="stat-row"><span class="stat-label">æ€»è®¡Tokens</span><span class="stat-value"><span id="totalTokens">0</span>K</span></div>
                        <div class="stat-row"><span class="stat-label">æ¶ˆæ¯æ•°</span><span class="stat-value"><span id="messageCount">0</span></span></div>
                        <div style="margin-top: 15px; text-align: right;">
                            <button class="btn-action btn-secondary" onclick="compact()">ğŸ—œï¸ Compact</button>
                        </div>
                    </div>
                    <div class="message-list" id="contextList"></div>
                </div>
            </div>

            <!-- æµ‹è¯• -->
            <div id="testPanel" class="panel" style="display: none;">
                <div class="panel-header"><h3>è‡ªåŠ¨åŒ–æµ‹è¯•</h3></div>
                <div class="panel-content">
                    <button class="btn-action" onclick="runTests()">è¿è¡Œæµ‹è¯•</button>
                    <div class="stat-box" id="testStatus" style="margin-top: 15px;">å°±ç»ª</div>
                </div>
            </div>
        </div>

        <!-- èŠå¤©è®°å½•ç®¡ç†æ¨¡å— -->
        <div id="historyModule" style="display: none; flex-direction: column; flex: 1; overflow: hidden;">
            <div class="conversation-tabs" id="historyConversationTabs"></div>
            <div class="panel">
                <div class="panel-header"><h3>æ¶ˆæ¯å†å²</h3><p>å®Œæ•´è®°å½•</p></div>
                <div class="panel-content">
                    <div class="stat-box">
                        <div class="stat-row"><span class="stat-label">æ€»å­—ç¬¦</span><span class="stat-value"><span id="historyTotalChars">0</span></span></div>
                        <div class="stat-row"><span class="stat-label">ä¸­æ–‡</span><span class="stat-value"><span id="historyChineseChars">0</span></span></div>
                        <div class="stat-row"><span class="stat-label">è‹±æ–‡</span><span class="stat-value"><span id="historyEnglishChars">0</span></span></div>
                        <div class="stat-row"><span class="stat-label">æ¶ˆæ¯æ•°</span><span class="stat-value"><span id="historyCount">0</span></span></div>
                    </div>
                    <div class="message-list" id="historyList"></div>
                </div>
            </div>
        </div>

        <div class="footer-controls">
            <span style="font-size: 11px; color: #666;">ç¼©æ”¾</span>
            <button class="btn-zoom" onclick="zoomOut()">-5%</button>
            <span style="font-size: 11px; color: #999;" id="zoomDisplay">100%</span>
            <button class="btn-zoom" onclick="zoomIn()">+5%</button>
            <button class="btn-zoom" onclick="resetZoom()">é‡ç½®</button>
        </div>
    </div>

    <script>
        let bridge = null;
        let isProcessing = false;
        let currentZoom = 100;
        let workspaces = [];
        let conversations = [];
        let currentWorkspaceId = null;
        let currentConversationId = null;
        let isQtMode = false;  // Qtæ¨¡å¼ or Webæ¨¡å¼
        let enableStreaming = true;  // æ˜¯å¦å¯ç”¨æµå¼æ¸²æŸ“ï¼ˆåŠ è½½å†å²æ—¶ç¦ç”¨ï¼‰

        // æ£€æµ‹ç¯å¢ƒå¹¶åˆå§‹åŒ–
        if (typeof qt !== 'undefined' && qt.webChannelTransport) {
            // Qtç¯å¢ƒ - ä½¿ç”¨WebChannel
            isQtMode = true;
            console.log('âœ… Qtç¯å¢ƒ - ä½¿ç”¨WebChannel');
            
            new QWebChannel(qt.webChannelTransport, function(channel) {
                console.log('âœ… QWebChannelå·²è¿æ¥');
                
                bridge = channel.objects.bridge;
                
                console.log('âœ… bridgeå¯¹è±¡è·å–æˆåŠŸ');
                
                // è¿æ¥ä¿¡å·ï¼ˆåŠ LOGï¼‰
                bridge.messageReceived.connect(msg => {
                    console.log('ğŸ”” æ”¶åˆ°messageReceivedä¿¡å·');
                    handleMessage(JSON.parse(msg));
                });
                
                bridge.contextUpdated.connect(data => {
                    console.log('ğŸ”” æ”¶åˆ°contextUpdatedä¿¡å·');
                    updateContext(JSON.parse(data));
                });
                
                bridge.messageHistoryUpdated.connect(data => {
                    console.log('ğŸ”” æ”¶åˆ°messageHistoryUpdatedä¿¡å·');
                    updateHistory(JSON.parse(data));
                });
                
                bridge.conversationsUpdated.connect(data => {
                    console.log('ğŸ”” æ”¶åˆ°conversationsUpdatedä¿¡å·');
                    updateConversations(JSON.parse(data));
                });
                
                bridge.workspaceListUpdated.connect(data => {
                    console.log('ğŸ”” æ”¶åˆ°workspaceListUpdatedä¿¡å·');
                    updateWorkspaces(JSON.parse(data));
                });
                
                bridge.workspaceChanged.connect(path => {
                    console.log('ğŸ”” æ”¶åˆ°workspaceChangedä¿¡å·:', path);
                });
                
                console.log('âœ… æ‰€æœ‰ä¿¡å·å·²è¿æ¥');
                console.log('å¼€å§‹åˆå§‹åŒ–...');
                
                init();
            });
        } else {
            // Webç¯å¢ƒ - ä½¿ç”¨RESTful API
            isQtMode = false;
            console.log('Webç¯å¢ƒ - ä½¿ç”¨RESTful API');
            
            // åˆ›å»ºAPIé€‚é…å™¨
            bridge = createAPIAdapter();
            init();
        }
        
        // ç»Ÿä¸€åˆå§‹åŒ–
        function init() {
            console.log('ğŸš€ åˆå§‹åŒ–å‰ç«¯...');
            
            isLoadingHistory = true;  // åˆå§‹åŒ–æ—¶ä¹Ÿè¦åŠ è½½å†å²
            
            // åªåŠ è½½ä¸€æ¬¡ï¼Œç­‰ä¿¡å·è§¦å‘
            loadWorkspaces();
            loadConversations();
            
            // ä¸å†å»¶è¿Ÿåˆ·æ–°ï¼ˆé¿å…é‡å¤æ¸²æŸ“ï¼‰
        }
        
        // RESTful APIé€‚é…å™¨ï¼ˆæ¨¡æ‹ŸQt bridgeæ¥å£ï¼‰
        function createAPIAdapter() {
            const API_BASE = '/api';
            
            return {
                getWorkspaceList: async function() {
                    const res = await fetch(`${API_BASE}/workspaces`);
                    const json = await res.json();
                    return JSON.stringify(json.data);
                },
                
                switchWorkspace: async function(wsId) {
                    await fetch(`${API_BASE}/workspaces/${wsId}/switch`, {method: 'POST'});
                    setTimeout(() => {
                        this.emit_workspace_list();
                        this.emit_conversations();
                    }, 50);
                },
                
                getConversationList: async function() {
                    const res = await fetch(`${API_BASE}/conversations`);
                    const json = await res.json();
                    return JSON.stringify(json.data);
                },
                
                createConversation: async function() {
                    const res = await fetch(`${API_BASE}/conversations`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({workspace_id: currentWorkspaceId})
                    });
                    const json = await res.json();
                    setTimeout(() => this.emit_conversations(), 50);
                    return json.conversation_id;
                },
                
                switchConversation: async function(convId) {
                    await fetch(`${API_BASE}/conversations/${convId}/switch`, {method: 'POST'});
                    setTimeout(() => this.emit_context(), 50);
                },
                
                sendMessage: async function(message) {
                    const res = await fetch(`${API_BASE}/agent/chat`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({message, conversation_id: currentConversationId})
                    });
                    const json = await res.json();
                    
                    if (json.success && json.data.message) {
                        handleMessage({
                            type: 'response',
                            success: true,
                            message: json.data.message
                        });
                    }
                    
                    setTimeout(() => this.emit_context(), 50);
                },
                
                manualCompact: async function() {
                    await fetch(`${API_BASE}/context/${currentConversationId}/compact`, {method: 'POST'});
                    setTimeout(() => this.emit_context(), 50);
                },
                
                renameWorkspace: async function(wsId, newName) {
                    await fetch(`${API_BASE}/workspaces/${wsId}/rename`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({new_name: newName})
                    });
                },
                
                renameConversation: async function(convId, newName) {
                    await fetch(`${API_BASE}/conversations/${convId}/rename`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({new_name: newName})
                    });
                },
                
                selectWorkspace: function() {
                    alert('Webç‰ˆæš‚ä¸æ”¯æŒæ–‡ä»¶å¤¹é€‰æ‹©ï¼Œè¯·ä½¿ç”¨Qtç‰ˆ');
                },
                
                // æ¨¡æ‹Ÿemitæ–¹æ³•
                emit_workspace_list: function() {
                    this.getWorkspaceList().then(data => updateWorkspaces(JSON.parse(data)));
                },
                
                emit_conversations: function() {
                    this.getConversationList().then(data => updateConversations(JSON.parse(data)));
                },
                
                emit_context: async function() {
                    if (!currentConversationId) return;
                    const res = await fetch(`${API_BASE}/context/${currentConversationId}`);
                    const json = await res.json();
                    updateContext(json.data);
                }
            };
        }

        function loadWorkspaces() {
            if (!bridge) {
                console.log('âŒ loadWorkspaces: bridgeæœªå‡†å¤‡å¥½');
                return;
            }
            
            console.log('ğŸ“ è°ƒç”¨bridge.getWorkspaceList()');
            
            try {
                const result = bridge.getWorkspaceList();
                console.log('ğŸ“ getWorkspaceListè¿”å›:', typeof result);
                
                // å¤„ç†Promiseæˆ–ç›´æ¥å­—ç¬¦ä¸²
                if (result && typeof result.then === 'function') {
                    // å¼‚æ­¥Promise
                    result.then(data => {
                        console.log('âœ… Promise resolved, æ•°æ®é•¿åº¦:', data.length);
                        workspaces = JSON.parse(data);
                        console.log('âœ… è§£ææˆåŠŸ:', workspaces.length, 'ä¸ªå·¥ä½œç©ºé—´');
                        renderWorkspaceTabs();
                    });
                } else if (typeof result === 'string') {
                    // åŒæ­¥å­—ç¬¦ä¸²
                    console.log('âœ… åŒæ­¥è¿”å›, æ•°æ®é•¿åº¦:', result.length);
                    workspaces = JSON.parse(result);
                    console.log('âœ… è§£ææˆåŠŸ:', workspaces.length, 'ä¸ªå·¥ä½œç©ºé—´');
                    renderWorkspaceTabs();
                } else {
                    console.log('âŒ æœªçŸ¥è¿”å›ç±»å‹:', typeof result, result);
                }
            } catch (e) {
                console.error('âŒ loadWorkspacesé”™è¯¯:', e);
            }
        }

        function updateWorkspaces(data) {
            console.log('updateWorkspaces:', data.length, 'ä¸ªå·¥ä½œç©ºé—´');
            workspaces = data;
            renderWorkspaceTabs();
        }

        function renderWorkspaceTabs() {
            const bar = document.getElementById('workspaceTabs');
            let html = '';
            workspaces.forEach(ws => {
                const active = ws.active ? 'active' : '';
                html += `
                    <button class="workspace-tab ${active}" onclick="selectWorkspace('${ws.id}')">
                        <div class="editable-name" ondblclick="editWorkspaceName(this)" data-id="${ws.id}">${ws.name}</div>
                        <div class="workspace-path">${ws.path}</div>
                    </button>
                `;
            });
            html += '<button class="workspace-tab workspace-tab-new" onclick="addWorkspace()">+ æ·»åŠ å·¥ä½œç©ºé—´</button>';
            bar.innerHTML = html;
        }

        function selectWorkspace(wsId) {
            if (!bridge) return;
            
            console.log('åˆ‡æ¢å·¥ä½œç©ºé—´:', wsId);
            
            bridge.switchWorkspace(wsId);
            currentWorkspaceId = wsId;
            currentConversationId = null;  // é‡ç½®å¯¹è¯ID
            
            // æ¸…ç©ºèŠå¤©åŒºåŸŸ
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '<div class="empty-state"><h2>ğŸ“–</h2><p>å·²åˆ‡æ¢å·¥ä½œç©ºé—´ï¼Œå¼€å§‹æ–°å¯¹è¯</p></div>';
            
            // é‡ç½®Contextæ˜¾ç¤º
            document.getElementById('totalTokens').textContent = '0';
            document.getElementById('messageCount').textContent = '0';
            document.getElementById('contextPercent').textContent = '0%';
            document.getElementById('contextTokens').textContent = '0K/131K';
            document.getElementById('contextList').innerHTML = '';
            
            // åˆ·æ–°å·¥ä½œç©ºé—´å’Œå¯¹è¯åˆ—è¡¨
            setTimeout(() => {
                loadWorkspaces();
                loadConversations();
            }, 100);
        }

        function addWorkspace() {
            if (!bridge) return;
            bridge.selectWorkspace();
        }

        function editWorkspaceName(el) {
            const wsId = el.dataset.id;
            const oldName = el.textContent;
            const newName = prompt('é‡å‘½åå·¥ä½œç©ºé—´:', oldName);
            if (newName && newName !== oldName && bridge) {
                bridge.renameWorkspace(wsId, newName);
                el.textContent = newName;
            }
        }

        function loadConversations() {
            if (!bridge) {
                console.log('âŒ loadConversations: bridgeæœªå‡†å¤‡å¥½');
                return;
            }
            
            console.log('ğŸ“ è°ƒç”¨bridge.getConversationList()');
            
            try {
                const result = bridge.getConversationList();
                console.log('ğŸ“ getConversationListè¿”å›:', typeof result);
                
                if (result && typeof result.then === 'function') {
                    result.then(data => {
                        console.log('âœ… Promise resolved, æ•°æ®:', data.substring(0, 100));
                        conversations = JSON.parse(data);
                        console.log('âœ… è§£ææˆåŠŸ:', conversations.length, 'ä¸ªå¯¹è¯');
                        renderConversationTabs();
                    });
                } else if (typeof result === 'string') {
                    console.log('âœ… åŒæ­¥è¿”å›:', result.substring(0, 100));
                    conversations = JSON.parse(result);
                    console.log('âœ… è§£ææˆåŠŸ:', conversations.length, 'ä¸ªå¯¹è¯');
                    renderConversationTabs();
                } else {
                    console.log('âŒ æœªçŸ¥è¿”å›ç±»å‹:', typeof result);
                }
            } catch (e) {
                console.error('âŒ loadConversationsé”™è¯¯:', e);
            }
        }

        function renderConversationTabs() {
            console.log('ğŸ“ renderConversationTabs, å¯¹è¯æ•°:', conversations.length);
            
            const convBar = document.getElementById('conversationTabs');
            const histBar = document.getElementById('historyConversationTabs');
            
            let html = '';
            conversations.forEach((conv, idx) => {
                const active = conv.active ? 'active' : '';
                console.log(`  - å¯¹è¯${idx+1}: ${conv.name}, active=${conv.active}, æ¶ˆæ¯=${conv.message_count}`);
                
                html += `
                    <button class="conversation-tab ${active}" onclick="selectConversation('${conv.id}')">
                        <span class="editable-name" ondblclick="editConversationName(this)" data-id="${conv.id}">${conv.name}</span>
                    </button>
                `;
            });
            
            console.log('ğŸ“ å¯¹è¯Tab HTMLé•¿åº¦:', html.length);
            
            convBar.innerHTML = html + '<button class="conversation-tab new" onclick="createConversation()">+ æ–°å»ºå¯¹è¯</button>';
            histBar.innerHTML = html;
            
            console.log('âœ… å¯¹è¯Tabæ¸²æŸ“å®Œæˆ');
        }

        function createConversation() {
            if (!bridge) return;
            const result = bridge.createConversation();
            
            // ç­‰å¾…å®Œæˆååˆ·æ–°
            if (result && typeof result.then === 'function') {
                result.then(() => {
                    setTimeout(loadConversations, 100);
                });
            } else {
                setTimeout(loadConversations, 100);
            }
        }

        let isLoadingHistory = false;  // æ ‡è®°æ˜¯å¦æ­£åœ¨åŠ è½½å†å²

        function selectConversation(convId) {
            if (!bridge) return;
            
            console.log('ğŸ”„ åˆ‡æ¢å¯¹è¯:', convId);
            
            isLoadingHistory = true;  // æ ‡è®°å¼€å§‹åŠ è½½å†å²
            
            bridge.switchConversation(convId);
            currentConversationId = convId;
            
            // æ˜¾ç¤ºåŠ è½½ä¸­
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '<div class="thinking">åŠ è½½å¯¹è¯å†å²...</div>';
            
            // åˆ·æ–°å¯¹è¯åˆ—è¡¨å’ŒContext
            setTimeout(() => {
                loadConversations();
            }, 100);
        }

        function editConversationName(el) {
            const convId = el.dataset.id;
            const oldName = el.textContent;
            const newName = prompt('é‡å‘½åå¯¹è¯:', oldName);
            if (newName && newName !== oldName && bridge) {
                bridge.renameConversation(convId, newName);
                el.textContent = newName;
            }
        }

        function switchModule(module) {
            document.querySelectorAll('.module-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('conversationModule').style.display = module === 'conversation' ? 'flex' : 'none';
            document.getElementById('historyModule').style.display = module === 'history' ? 'flex' : 'none';
        }

        function switchContent(tab) {
            document.querySelectorAll('.content-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('chatPanel').style.display = tab === 'chat' ? 'flex' : 'none';
            document.getElementById('contextPanel').style.display = tab === 'context' ? 'flex' : 'none';
            document.getElementById('testPanel').style.display = tab === 'test' ? 'flex' : 'none';
        }

        async function handleMessage(data) {
            console.log('ğŸ“¬ handleMessage:', data.type);
            
            if (data.type === 'thinking') {
                showThinking();
            }
            else if (data.type === 'compressing') {
                showCompressing();
            }
            else if (data.type === 'response') {
                hideThinking();
                
                // æµå¼æ¸²æŸ“æ¶ˆæ¯
                if (data.message?.trim() || (data.tool_calls && data.tool_calls.length > 0)) {
                    await addAssistantMessage(data);
                }
                
                isProcessing = false;
                updateSendButton();
            }
            else if (data.type === 'error') {
                hideThinking();
                alert(data.message);
                isProcessing = false;
                updateSendButton();
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const msg = input.value.trim();
            if (!msg || !bridge || isProcessing) return;
            
            addUserMessage(msg);
            input.value = '';
            isProcessing = true;
            updateSendButton();
            bridge.sendMessage(msg);
        }

        function addUserMessage(text) {
            const area = document.getElementById('chatArea');
            area.querySelector('.empty-state')?.remove();
            const div = document.createElement('div');
            div.className = 'message user';
            div.innerHTML = `<div class="message-content">${escapeHtml(text)}</div>`;
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        // æµå¼æ¸²æŸ“åŠ©æ‰‹æ¶ˆæ¯
        async function addAssistantMessage(data, streaming = null) {
            // å¦‚æœæœªæŒ‡å®šï¼Œä½¿ç”¨å…¨å±€è®¾ç½®
            const useStreaming = streaming !== null ? streaming : enableStreaming;
            
            console.log('â• æ¸²æŸ“åŠ©æ‰‹æ¶ˆæ¯ (æµå¼:', useStreaming, ')');
            console.log('  - å·¥å…·è°ƒç”¨æ•°:', data.tool_calls?.length || 0);
            
            const area = document.getElementById('chatArea');
            
            // 1. åˆ›å»ºæ¶ˆæ¯å®¹å™¨
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.innerHTML = '<div class="message-content" id="streaming-message"></div>';
            area.appendChild(messageDiv);
            
            const contentDiv = document.getElementById('streaming-message');
            
            // 2. å¦‚æœæœ‰å·¥å…·è°ƒç”¨ï¼Œæ¸²æŸ“å·¥å…·
            if (data.tool_calls && data.tool_calls.length > 0) {
                // åˆ›å»ºå·¥å…·å®¹å™¨
                const toolsContainer = document.createElement('div');
                toolsContainer.style.cssText = 'margin-bottom: 12px; padding: 12px; background: #f5f5f5; border-radius: 3px; font-size: 12px; border-left: 3px solid #666;';
                
                // æ·»åŠ æ ‡é¢˜ï¼ˆå¸¦è„‰å†²åŠ¨ç”»ï¼‰
                const headerDiv = document.createElement('div');
                headerDiv.style.cssText = 'font-weight: 600; margin-bottom: 10px; color: #666;';
                headerDiv.innerHTML = `ğŸ”§ æ‰§è¡Œäº† ${data.tool_calls.length} ä¸ªå·¥å…·`;
                
                if (useStreaming) {
                    headerDiv.style.cssText += ' opacity: 0; animation: fadeInPulse 0.5s ease forwards;';
                }
                
                toolsContainer.appendChild(headerDiv);
                contentDiv.appendChild(toolsContainer);
                
                // é€ä¸ªæ¸²æŸ“å·¥å…·è°ƒç”¨
                for (let i = 0; i < data.tool_calls.length; i++) {
                    const call = data.tool_calls[i];
                    
                    // æµå¼æ¨¡å¼ï¼šå…ˆæ˜¾ç¤º"æ­£åœ¨æ‰§è¡Œ"æŒ‡ç¤ºå™¨
                    let executingIndicator = null;
                    if (useStreaming) {
                        executingIndicator = document.createElement('div');
                        executingIndicator.className = 'executing-indicator';
                        executingIndicator.style.margin = '8px 0';
                        executingIndicator.innerHTML = `
                            <div class="spinner"></div>
                            <span>æ­£åœ¨æ‰§è¡Œ ${call.tool}...</span>
                        `;
                        toolsContainer.appendChild(executingIndicator);
                        area.scrollTop = area.scrollHeight;
                        await sleep(300);
                    }
                    
                    // åˆ›å»ºå·¥å…·å¡ç‰‡
                    const toolCard = document.createElement('div');
                    const baseStyle = 'padding: 10px; margin: 8px 0; background: #fff; border-radius: 3px; border: 1px solid #ddd;';
                    
                    if (useStreaming) {
                        toolCard.style.cssText = baseStyle + ' opacity: 0; transform: translateY(10px); transition: all 0.3s ease;';
                    } else {
                        toolCard.style.cssText = baseStyle;
                    }
                    
                    // å·¥å…·åï¼ˆå¸¦å›¾æ ‡ï¼‰
                    toolCard.innerHTML = `<div style="font-weight: 600; color: #2c2c2c; margin-bottom: 8px; font-size: 13px; font-family: Consolas, monospace;">âš¡ ${i+1}. ${call.tool}</div>`;
                    
                    // å…¥å‚
                    toolCard.innerHTML += `
                        <div style="margin-bottom: 6px;">
                            <div style="font-size: 10px; color: #999; margin-bottom: 3px; font-weight: 500;">ğŸ“¥ å…¥å‚:</div>
                            <div style="font-size: 11px; color: #2c2c2c; font-family: Consolas, monospace; background: #fafafa; padding: 6px 8px; border-radius: 2px; border: 1px solid #e0e0e0; white-space: pre-wrap;">${JSON.stringify(call.arguments, null, 2)}</div>
                        </div>
                    `;
                    
                    // å‡ºå‚
                    if (call.result) {
                        const success = call.result.success;
                        const statusColor = success ? '#4caf50' : '#f44336';
                        const statusText = success ? 'âœ… æˆåŠŸ' : 'âš ï¸ å¤±è´¥ï¼ˆAIå°†è‡ªåŠ¨ä¿®æ­£ï¼‰';
                        
                        toolCard.innerHTML += `
                            <div>
                                <div style="font-size: 10px; color: #999; margin-bottom: 3px; font-weight: 500;">ğŸ“¤ å‡ºå‚:</div>
                                <div style="font-size: 11px; font-family: Consolas, monospace; background: #fafafa; padding: 6px 8px; border-radius: 2px; border: 1px solid #e0e0e0;">
                                    <div style="color: ${statusColor}; font-weight: 600; margin-bottom: 4px;">${statusText}</div>
                                    <div style="color: #666; white-space: pre-wrap;">${JSON.stringify(call.result, null, 2)}</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // ç§»é™¤"æ­£åœ¨æ‰§è¡Œ"æŒ‡ç¤ºå™¨ï¼Œæ˜¾ç¤ºå®é™…ç»“æœ
                    if (useStreaming && executingIndicator) {
                        executingIndicator.remove();
                    }
                    
                    toolsContainer.appendChild(toolCard);
                    
                    // æµå¼æ¸²æŸ“ï¼šå»¶è¿Ÿåæ˜¾ç¤º
                    if (useStreaming) {
                        await sleep(100);
                        toolCard.style.opacity = '1';
                        toolCard.style.transform = 'translateY(0)';
                        area.scrollTop = area.scrollHeight;
                    }
                }
                
                // å·¥å…·æ¸²æŸ“å®Œæˆåç¨ä½œåœé¡¿
                if (useStreaming) {
                    await sleep(200);
                }
            }
            
            // 3. æ¸²æŸ“æ–‡æœ¬æ¶ˆæ¯
            if (data.message && data.message.trim()) {
                const textDiv = document.createElement('div');
                
                if (useStreaming) {
                    textDiv.style.cssText = 'opacity: 0; transform: translateY(5px); transition: all 0.4s ease;';
                }
                
                contentDiv.appendChild(textDiv);
                
                if (useStreaming) {
                    await sleep(100);
                }
                
                textDiv.innerHTML = formatMarkdown(data.message);
                
                if (useStreaming) {
                    textDiv.style.opacity = '1';
                    textDiv.style.transform = 'translateY(0)';
                }
                
                area.scrollTop = area.scrollHeight;
            }
            
            // ç§»é™¤ä¸´æ—¶ID
            contentDiv.removeAttribute('id');
            
            console.log('âœ… æ¶ˆæ¯æ¸²æŸ“å®Œæˆ');
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šå»¶è¿Ÿ
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showThinking() {
            const area = document.getElementById('chatArea');
            const div = document.createElement('div');
            div.className = 'thinking';
            div.id = 'thinking';
            div.textContent = 'æ€è€ƒä¸­...';
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function showCompressing() {
            hideThinking();
            const area = document.getElementById('chatArea');
            const div = document.createElement('div');
            div.className = 'thinking';
            div.id = 'thinking';
            div.textContent = 'ğŸ—œï¸ æ­£åœ¨æ•´ç†å¯¹è¯...';
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function hideThinking() {
            document.getElementById('thinking')?.remove();
        }

        function updateSendButton() {
            const btn = document.getElementById('sendBtn');
            btn.disabled = isProcessing;
            btn.textContent = isProcessing ? 'å¤„ç†ä¸­...' : 'å‘é€';
        }

        function updateContext(data) {
            console.log('updateContext:', data.message_count, 'æ¡æ¶ˆæ¯', data.token_usage.total_tokens, 'tokens');
            
            document.getElementById('promptTokens').textContent = (data.token_usage.prompt_tokens / 1000).toFixed(1);
            document.getElementById('completionTokens').textContent = (data.token_usage.completion_tokens / 1000).toFixed(1);
            document.getElementById('totalTokens').textContent = (data.token_usage.total_tokens / 1000).toFixed(1);
            document.getElementById('messageCount').textContent = data.message_count;
            updateContextCircle(data.token_usage.total_tokens);
            
            const list = document.getElementById('contextList');
            if (data.messages.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Contextä¸ºç©º</div>';
            } else {
                let html = '';
                data.messages.forEach((msg, idx) => {
                    const role = msg.role === 'user' ? 'user' : 'assistant';
                    const name = msg.role === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹';
                    const display = msg.content.length > 300 ? msg.content.substring(0, 300) + '...' : msg.content;
                    
                    html += `<div class="message-item ${role}">`;
                    html += `<div class="message-header">[${idx+1}] ${name}</div>`;
                    html += `<div class="message-text">${escapeHtml(display)}</div>`;
                    
                    // Contexté¢„è§ˆ - å·¥å…·è°ƒç”¨ï¼ˆç»¿è‰²ä¸»é¢˜ï¼Œç»Ÿä¸€ä½¿ç”¨renderToolResultï¼‰
                    if (msg.tool_calls && msg.tool_calls.length > 0) {
                        html += `<div style="margin-top: 10px; padding: 10px; background: rgba(76,175,80,0.08); border: 1px solid rgba(76,175,80,0.3); border-radius: 3px;">`;
                        html += `<div style="font-size: 11px; color: #4caf50; font-weight: 600; margin-bottom: 8px;">ğŸ”§ æ‰§è¡Œäº† ${msg.tool_calls.length} ä¸ªå·¥å…·</div>`;
                        
                        msg.tool_calls.forEach((call, i) => {
                            html += `<div style="padding: 10px; margin: 8px 0; background: #fff; border-radius: 3px; border: 1px solid #e0e0e0;">`;
                            
                            // å·¥å…·å
                            html += `<div style="font-weight: 600; color: #2c2c2c; margin-bottom: 8px; font-size: 12px; font-family: Consolas, monospace;">${i+1}. ${call.tool}</div>`;
                            
                            // å…¥å‚
                            html += `<div style="margin-bottom: 6px;">`;
                            html += `<div style="font-size: 10px; color: #999; margin-bottom: 3px; font-weight: 500;">ğŸ“¥ å…¥å‚:</div>`;
                            html += `<div style="font-size: 10px; color: #2c2c2c; font-family: Consolas, monospace; background: #fafafa; padding: 6px 8px; border-radius: 2px; border: 1px solid #e0e0e0; white-space: pre-wrap;">${JSON.stringify(call.arguments, null, 2)}</div>`;
                            html += `</div>`;
                            
                            // å‡ºå‚ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„renderToolResultå‡½æ•°ï¼‰
                            if (call.result) {
                                html += `<div>`;
                                html += `<div style="font-size: 10px; color: #999; margin-bottom: 3px; font-weight: 500;">ğŸ“¤ å‡ºå‚:</div>`;
                                
                                const success = call.result.success;
                                const statusColor = success ? '#4caf50' : '#f44336';
                                const statusText = success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥';
                                
                                html += `<div style="font-size: 11px; font-family: Consolas, monospace; background: #fafafa; padding: 6px 8px; border-radius: 2px; border: 1px solid #e0e0e0;">`;
                                html += `<div style="color: ${statusColor}; font-weight: 600; margin-bottom: 6px;">${statusText}</div>`;
                                html += renderToolResult(call.tool, call.result);  // ç»Ÿä¸€è°ƒç”¨ï¼
                                html += `</div>`;
                                html += `</div>`;
                            }
                            
                            html += `</div>`;
                        });
                        
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                });
                list.innerHTML = html;
            }
        }

        function updateHistory(data) {
            const msgs = data.messages || [];
            console.log('ğŸ“¨ updateHistoryè¢«è°ƒç”¨, æ¶ˆæ¯æ•°:', msgs.length);
            console.log('  - conversation_id:', data.conversation_id);
            console.log('  - isLoadingHistory:', isLoadingHistory);
            
            // ç»Ÿè®¡å­—ç¬¦ï¼ˆèŠå¤©è®°å½•ç®¡ç†æ¨¡å—ç”¨ï¼‰
            let total = 0, chinese = 0, english = 0;
            msgs.forEach(m => {
                const c = m.content || '';
                total += c.length;
                chinese += (c.match(/[\u4e00-\u9fa5]/g) || []).length;
                english += (c.match(/[a-zA-Z]/g) || []).length;
            });
            
            document.getElementById('historyTotalChars').textContent = total.toLocaleString();
            document.getElementById('historyChineseChars').textContent = chinese.toLocaleString();
            document.getElementById('historyEnglishChars').textContent = english.toLocaleString();
            document.getElementById('historyCount').textContent = msgs.length;
            
            // æ¸²æŸ“åˆ°èŠå¤©è®°å½•ç®¡ç†æ¨¡å—ï¼ˆå’ŒContexté¢„è§ˆä¸€æ ·è¯¦ç»†ï¼‰
            const list = document.getElementById('historyList');
            if (msgs.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">æš‚æ— æ¶ˆæ¯</div>';
            } else {
                let html = '';
                msgs.forEach((msg, idx) => {
                    const role = msg.role === 'user' ? 'user' : 'assistant';
                    const name = msg.role === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹';
                    const display = msg.content.length > 300 ? msg.content.substring(0, 300) + '...' : msg.content;
                    
                    html += `<div class="message-item ${role}">`;
                    html += `<div class="message-header">[${idx+1}] ${name}</div>`;
                    html += `<div class="message-text">${escapeHtml(display)}</div>`;
                    
                    // è¯¦ç»†æ˜¾ç¤ºå·¥å…·è°ƒç”¨ï¼ˆå’ŒContexté¢„è§ˆä¸€æ ·ï¼‰
                    if (msg.tool_calls && msg.tool_calls.length > 0) {
                        html += `<div style="margin-top: 10px; padding: 10px; background: rgba(76,175,80,0.08); border: 1px solid rgba(76,175,80,0.3); border-radius: 3px;">`;
                        html += `<div style="font-size: 11px; color: #4caf50; font-weight: 600; margin-bottom: 8px;">ğŸ”§ æ‰§è¡Œäº† ${msg.tool_calls.length} ä¸ªå·¥å…·</div>`;
                        
                        msg.tool_calls.forEach((call, i) => {
                            html += `<div style="padding: 10px; margin: 8px 0; background: #fff; border-radius: 3px; border: 1px solid #e0e0e0;">`;
                            
                            // å·¥å…·å
                            html += `<div style="font-weight: 600; color: #2c2c2c; margin-bottom: 8px; font-size: 12px; font-family: Consolas, monospace;">${i+1}. ${call.tool}</div>`;
                            
                            // å…¥å‚
                            html += `<div style="margin-bottom: 6px;">`;
                            html += `<div style="font-size: 10px; color: #999; margin-bottom: 3px; font-weight: 500;">ğŸ“¥ å…¥å‚:</div>`;
                            html += `<div style="font-size: 10px; color: #2c2c2c; font-family: Consolas, monospace; background: #fafafa; padding: 6px 8px; border-radius: 2px; border: 1px solid #e0e0e0; white-space: pre-wrap;">${JSON.stringify(call.arguments, null, 2)}</div>`;
                            html += `</div>`;
                            
                            // å‡ºå‚ï¼ˆä½¿ç”¨renderToolResultï¼‰
                            if (call.result) {
                                html += `<div>`;
                                html += `<div style="font-size: 10px; color: #999; margin-bottom: 3px; font-weight: 500;">ğŸ“¤ å‡ºå‚:</div>`;
                                
                                const success = call.result.success;
                                const statusColor = success ? '#4caf50' : '#f44336';
                                const statusText = success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥';
                                
                                html += `<div style="font-size: 11px; font-family: Consolas, monospace; background: #fafafa; padding: 6px 8px; border-radius: 2px; border: 1px solid #e0e0e0;">`;
                                html += `<div style="color: ${statusColor}; font-weight: 600; margin-bottom: 6px;">${statusText}</div>`;
                                html += renderToolResult(call.tool, call.result);
                                html += `</div>`;
                                html += `</div>`;
                            }
                            
                            html += `</div>`;
                        });
                        
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                });
                list.innerHTML = html;
            }
            
            // ========== åªåœ¨åˆ‡æ¢å¯¹è¯/å¯åŠ¨æ—¶æ¸²æŸ“å†å² ==========
            if (isLoadingHistory) {
                if (msgs.length > 0) {
                    console.log('ğŸ”„ isLoadingHistory=trueï¼Œæ¸²æŸ“å†å²åˆ°èŠå¤©ç•Œé¢');
                    renderChatHistory(msgs);
                } else {
                    console.log('âš ï¸ å†å²ä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
            const chatArea = document.getElementById('chatArea');
                    if (chatArea) {
                        chatArea.innerHTML = '<div class="empty-state"><h2>ğŸ“–</h2><p>å¼€å§‹å¯¹è¯</p></div>';
                    }
                }
                isLoadingHistory = false;  // é‡ç½®æ ‡è®°ï¼ˆåªæ¸²æŸ“ä¸€æ¬¡ï¼‰
            } else {
                console.log('â­ï¸ isLoadingHistory=falseï¼Œè·³è¿‡èŠå¤©ç•Œé¢æ¸²æŸ“');
            }
        }
        
        function renderChatHistory(msgs) {
            console.log('ğŸ¨ renderChatHistoryè¢«è°ƒç”¨, æ¶ˆæ¯æ•°:', msgs.length);
            
            const chatArea = document.getElementById('chatArea');
            
            if (!chatArea) {
                console.error('âŒ chatAreaå…ƒç´ ä¸å­˜åœ¨ï¼');
                return;
            }
            
            if (msgs.length === 0) {
                console.log('âš ï¸ æ¶ˆæ¯ä¸º0ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                chatArea.innerHTML = '<div class="empty-state"><h2>ğŸ“–</h2><p>å¼€å§‹å¯¹è¯</p></div>';
                return;
            }
            
            console.log('ğŸ¨ æ¸…ç©ºchatAreaï¼Œé‡æ–°æ¸²æŸ“å†å²');
            
            // æ¸…ç©º
            chatArea.innerHTML = '';
            
            // æ¸²æŸ“æ‰€æœ‰å†å²æ¶ˆæ¯ï¼ˆåŒ…å«å·¥å…·è°ƒç”¨ï¼‰
            msgs.forEach((msg, idx) => {
                console.log(`  æ¸²æŸ“æ¶ˆæ¯${idx+1}: ${msg.role}, å·¥å…·=${msg.tool_calls?.length || 0}`);
                
                const div = document.createElement('div');
                div.className = 'message ' + (msg.role === 'user' ? 'user' : 'assistant');
                
                let content = `<div class="message-content">${formatMarkdown(msg.content)}`;
                
                // è¯¦ç»†æ¸²æŸ“å·¥å…·è°ƒç”¨ï¼ˆå…¥å‚+å‡ºå‚ï¼‰
                if (msg.tool_calls && msg.tool_calls.length > 0) {
                    content += `<div style="margin-top: 12px; padding: 12px; background: #f5f5f5; border-radius: 3px; border-left: 3px solid #666;">`;
                    content += `<div style="font-weight: 600; margin-bottom: 10px; color: #666; font-size: 12px;">ğŸ”§ æ‰§è¡Œäº† ${msg.tool_calls.length} ä¸ªå·¥å…·</div>`;
                    
                    msg.tool_calls.forEach((call, i) => {
                        content += `<div style="padding: 10px; margin: 8px 0; background: #fff; border-radius: 3px; border: 1px solid #ddd;">`;
                        
                        // å·¥å…·å
                        content += `<div style="font-weight: 600; color: #2c2c2c; margin-bottom: 8px; font-size: 13px; font-family: Consolas, monospace;">${i+1}. ${call.tool}</div>`;
                        
                        // å…¥å‚
                        content += `<div style="margin-bottom: 6px;">`;
                        content += `<div style="font-size: 10px; color: #999; margin-bottom: 3px; font-weight: 500;">ğŸ“¥ å…¥å‚:</div>`;
                        content += `<div style="font-size: 11px; color: #2c2c2c; font-family: Consolas, monospace; background: #fafafa; padding: 6px 8px; border-radius: 2px; border: 1px solid #e0e0e0; white-space: pre-wrap;">${JSON.stringify(call.arguments, null, 2)}</div>`;
                        content += `</div>`;
                        
                        // å‡ºå‚ï¼ˆæ ¹æ®å·¥å…·ç±»å‹å®šåˆ¶æ¸²æŸ“ï¼‰
                        if (call.result) {
                            content += `<div>`;
                            content += `<div style="font-size: 10px; color: #999; margin-bottom: 3px; font-weight: 500;">ğŸ“¤ å‡ºå‚:</div>`;
                            
                            const success = call.result.success;
                            const statusColor = success ? '#4caf50' : '#f44336';
                            const statusText = success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥';
                            
                        content += `<div style="font-size: 11px; font-family: Consolas, monospace; background: #fafafa; padding: 6px 8px; border-radius: 2px; border: 1px solid #e0e0e0;">`;
                        content += `<div style="color: ${statusColor}; font-weight: 600; margin-bottom: 6px;">${statusText}</div>`;
                        
                        // å¦‚æœå¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
                        if (!success && call.result.error) {
                            const errorPreview = (call.result.error || '').substring(0, 150);
                            content += `<div style="color: #f44336; margin-bottom: 6px; font-size: 10px; background: #ffebee; padding: 4px 6px; border-radius: 2px;">`;
                            content += `<div style="font-weight: 600; margin-bottom: 2px;">é”™è¯¯è¯¦æƒ…:</div>`;
                            content += `<div>${escapeHtml(errorPreview)}</div>`;
                            content += `</div>`;
                            content += `<div style="color: #999; font-size: 9px; font-style: italic; margin-top: 4px;">ğŸ’¡ AIå·²æ”¶åˆ°é”™è¯¯ä¿¡æ¯ï¼Œå°†åœ¨ä¸‹ä¸€è½®è‡ªåŠ¨ä¿®æ­£</div>`;
                        } else {
                            // æˆåŠŸåˆ™æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                            content += renderToolResult(call.tool, call.result);
                        }
                            
                            content += `</div>`;
                            content += `</div>`;
                        }
                        
                        content += `</div>`;
                    });
                    
                    content += `</div>`;
                }
                
                content += `</div>`;
                div.innerHTML = content;
                chatArea.appendChild(div);
            });
            
            console.log('âœ… å†å²æ¶ˆæ¯æ¸²æŸ“å®Œæˆï¼ˆå«å·¥å…·è°ƒç”¨ï¼‰ï¼Œå­å…ƒç´ æ•°:', chatArea.children.length);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function updateConversations(data) {
            console.log('updateConversations:', data.length, 'ä¸ªå¯¹è¯');
            conversations = data;
            renderConversationTabs();
        }

        function updateContextCircle(totalTokens) {
            const maxTokens = 131072;
            const percentage = (totalTokens / maxTokens) * 100;
            const circumference = 100.48;
            const offset = circumference - (percentage / 100) * circumference;
            
            const circle = document.getElementById('contextCircle');
            circle.style.strokeDashoffset = offset;
            
            if (percentage >= 90) {
                circle.classList.add('danger');
                circle.classList.remove('warning');
            } else if (percentage >= 70) {
                circle.classList.add('warning');
                circle.classList.remove('danger');
            } else {
                circle.classList.remove('warning', 'danger');
            }
            
            document.getElementById('contextPercent').textContent = percentage.toFixed(0) + '%';
            document.getElementById('contextTokens').textContent = (totalTokens / 1000).toFixed(1) + 'K/131K';
        }

        function compact() {
            if (!bridge) return;
            if (confirm('ç¡®å®šå‹ç¼©Contextï¼Ÿ')) bridge.manualCompact();
        }

        function formatMarkdown(text) {
            let html = escapeHtml(text);
            
            // ä»£ç å— ```code```
            html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, function(match, lang, code) {
                return `<pre style="background:#2c2c2c;color:#e0e0e0;padding:8px;border-radius:3px;overflow-x:auto;margin:6px 0;line-height:1.3;"><code>${code.trim()}</code></pre>`;
            });
            
            // è¡Œå†…ä»£ç  `code`
            html = html.replace(/`([^`]+)`/g, '<code style="background:#f0f0f0;padding:2px 6px;border-radius:2px;font-family:Consolas,monospace;font-size:13px;color:#2c2c2c;">$1</code>');
            
            // ç²—ä½“ **text**
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong style="color:#1a1a1a;font-weight:600;">$1</strong>');
            
            // æ–œä½“ *text*
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
            
            // åˆ—è¡¨ - item (ç´§å‡‘æ ·å¼)
            html = html.replace(/^- (.+)$/gm, '<li style="margin-left:25px;color:#333;line-height:1.3;margin-bottom:3px;">$1</li>');
            
            // æ ‡é¢˜ (æŒ‰ä»å¤šåˆ°å°‘çš„é¡ºåºï¼Œé¿å…åŒ¹é…å†²çª)
            html = html.replace(/^#### (.+)$/gm, '<h5 style="margin:6px 0 4px 0;color:#2c2c2c;font-weight:500;font-size:14px;line-height:1.3;">$1</h5>');
            html = html.replace(/^### (.+)$/gm, '<h4 style="margin:6px 0 4px 0;color:#2c2c2c;font-weight:500;font-size:15px;line-height:1.3;">$1</h4>');
            html = html.replace(/^## (.+)$/gm, '<h3 style="margin:8px 0 5px 0;color:#2c2c2c;font-weight:500;font-size:16px;line-height:1.3;">$1</h3>');
            html = html.replace(/^# (.+)$/gm, '<h2 style="margin:8px 0 5px 0;color:#2c2c2c;font-weight:500;font-size:18px;line-height:1.3;">$1</h2>');
            
            // æ¢è¡Œ (ä½¿ç”¨æ›´ç´§å‡‘çš„è¡Œé«˜)
            html = html.replace(/\n/g, '<br style="line-height:1.3;">');
            
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // æ ¹æ®å·¥å…·ç±»å‹å®šåˆ¶ç»“æœæ¸²æŸ“
        function renderToolResult(toolName, result) {
            let html = '';
            
            // list_files - æ–‡ä»¶åˆ—è¡¨
            if (toolName === 'list_files') {
                const files = result.files || [];
                const dirs = result.directories || [];
                
                html += `<div style="color: #666;">`;
                html += `<div>æ–‡ä»¶æ•°: ${result.total_files || files.length}</div>`;
                html += `<div>ç›®å½•æ•°: ${result.total_directories || dirs.length}</div>`;
                
                if (files.length > 0) {
                    html += `<div style="margin-top: 6px; font-weight: 500;">ğŸ“„ æ–‡ä»¶:</div>`;
                    files.slice(0, 10).forEach(f => {
                        html += `<div style="padding-left: 10px; font-size: 10px;">- ${f.name || f.path}</div>`;
                    });
                    if (files.length > 10) {
                        html += `<div style="padding-left: 10px; font-size: 10px; color: #999;">... è¿˜æœ‰ ${files.length - 10} ä¸ªæ–‡ä»¶</div>`;
                    }
                }
                
                if (dirs.length > 0) {
                    html += `<div style="margin-top: 6px; font-weight: 500;">ğŸ“ ç›®å½•:</div>`;
                    dirs.slice(0, 5).forEach(d => {
                        html += `<div style="padding-left: 10px; font-size: 10px;">- ${d.name || d.path}</div>`;
                    });
                    if (dirs.length > 5) {
                        html += `<div style="padding-left: 10px; font-size: 10px; color: #999;">... è¿˜æœ‰ ${dirs.length - 5} ä¸ªç›®å½•</div>`;
                    }
                }
                
                html += `</div>`;
            }
            // read_file - æ–‡ä»¶å†…å®¹
            else if (toolName === 'read_file') {
                html += `<div style="color: #666;">`;
                html += `<div>è·¯å¾„: ${result.path || ''}</div>`;
                html += `<div>è¡Œæ•°: ${result.lines || 0}</div>`;
                const content = result.content || '';
                const preview = content.substring(0, 200);
                html += `<div style="margin-top: 6px;">å†…å®¹é¢„è§ˆ:</div>`;
                html += `<div style="background: #f5f5f5; padding: 6px; border-radius: 2px; font-size: 10px; white-space: pre-wrap; max-height: 100px; overflow-y: auto;">${escapeHtml(preview)}${content.length > 200 ? '\n...' : ''}</div>`;
                html += `</div>`;
            }
            // write_file - å†™å…¥ç»“æœ
            else if (toolName === 'write_file') {
                html += `<div style="color: #666;">`;
                html += `<div>è·¯å¾„: ${result.path || ''}</div>`;
                html += `<div>å†™å…¥: ${result.bytes_written || 0} å­—èŠ‚</div>`;
                html += `</div>`;
            }
            // edit_file - ç¼–è¾‘ç»“æœï¼ˆæ‰¹é‡ï¼‰
            else if (toolName === 'edit_file') {
                html += `<div style="color: #666;">`;
                html += `<div>è·¯å¾„: ${result.path || ''}</div>`;
                html += `<div>æ€»ç¼–è¾‘æ•°: ${result.total_edits || 0}</div>`;
                html += `<div style="color: #4caf50;">æˆåŠŸ: ${result.successful_edits || 0}</div>`;
                if (result.failed_edits > 0) {
                    html += `<div style="color: #ff9800;">å¤±è´¥: ${result.failed_edits}</div>`;
                }
                html += `</div>`;
            }
            // search_code - æœç´¢ç»“æœ
            else if (toolName === 'search_code') {
                const results = result.results || [];
                html += `<div style="color: #666;">`;
                html += `<div>æ‰¾åˆ°: ${result.total || results.length} å¤„</div>`;
                
                if (results.length > 0) {
                    html += `<div style="margin-top: 6px;">åŒ¹é…:</div>`;
                    results.slice(0, 5).forEach(r => {
                        html += `<div style="padding-left: 10px; font-size: 10px;">- ${r.file}:${r.line}</div>`;
                    });
                    if (results.length > 5) {
                        html += `<div style="padding-left: 10px; font-size: 10px; color: #999;">... è¿˜æœ‰ ${results.length - 5} å¤„</div>`;
                    }
                }
                html += `</div>`;
            }
            // get_project_structure - é¡¹ç›®ç»“æ„
            else if (toolName === 'get_project_structure') {
                html += `<div style="color: #666;">`;
                html += `<div>è·¯å¾„: ${result.path || ''}</div>`;
                if (result.tree) {
                    html += `<div style="margin-top: 6px;">ç»“æ„: (å·²ç”Ÿæˆ)</div>`;
                }
                html += `</div>`;
            }
            // run_terminal - ç»ˆç«¯è¾“å‡º
            else if (toolName === 'run_terminal') {
                const output = result.output || '';
                html += `<div style="color: #666;">`;
                html += `<div>è¿”å›ç : ${result.return_code || 0}</div>`;
                if (output) {
                    const preview = output.substring(0, 150);
                    html += `<div style="margin-top: 6px;">è¾“å‡º:</div>`;
                    html += `<div style="background: #2c2c2c; color: #e0e0e0; padding: 6px; border-radius: 2px; font-size: 10px; white-space: pre-wrap; max-height: 80px; overflow-y: auto;">${escapeHtml(preview)}${output.length > 150 ? '\n...' : ''}</div>`;
                }
                html += `</div>`;
            }
            // query_history - èŠå¤©è®°å½•æŸ¥è¯¢
            else if (toolName === 'query_history') {
                const results = result.results || [];
                html += `<div style="color: #666;">`;
                html += `<div>æœç´¢: "${result.query}"</div>`;
                html += `<div>åŒ¹é…: ${result.total || 0} æ¡</div>`;
                html += `<div>æœç´¢èŒƒå›´: ${result.searched_messages || 0} æ¡æ¶ˆæ¯</div>`;
                
                if (results.length > 0) {
                    html += `<div style="margin-top: 8px; font-weight: 500;">ğŸ” æŸ¥è¯¢ç»“æœ:</div>`;
                    results.forEach((r, i) => {
                        const content = r.content || '';
                        const preview = content.length > 100 ? content.substring(0, 100) + '...' : content;
                        html += `<div style="margin: 6px 0; padding: 6px; background: #f9f9f9; border-left: 2px solid #4caf50; border-radius: 2px;">`;
                        html += `<div style="font-size: 10px; color: #4caf50; font-weight: 600;">[${r.index}] ${r.role}</div>`;
                        html += `<div style="font-size: 10px; color: #666; margin-top: 2px;">${escapeHtml(preview)}</div>`;
                        if (r.relevance) {
                            html += `<div style="font-size: 9px; color: #999; margin-top: 2px; font-style: italic;">ç›¸å…³åº¦: ${r.relevance}</div>`;
                        }
                        html += `</div>`;
                    });
                }
                html += `</div>`;
            }
            // é»˜è®¤ - å®Œæ•´JSON
            else {
                html += `<div style="color: #666; white-space: pre-wrap;">${JSON.stringify(result, null, 2)}</div>`;
            }
            
            return html;
        }

        function zoomIn() { currentZoom = Math.min(currentZoom + 5, 200); applyZoom(); }
        function zoomOut() { currentZoom = Math.max(currentZoom - 5, 50); applyZoom(); }
        function resetZoom() { currentZoom = 100; applyZoom(); }
        function applyZoom() {
            document.body.style.zoom = currentZoom + '%';
            document.getElementById('zoomDisplay').textContent = currentZoom + '%';
        }

        function runTests() { alert('æµ‹è¯•åŠŸèƒ½'); }
    </script>
</body>
</html>
