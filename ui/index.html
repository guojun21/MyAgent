<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AIç¼–ç¨‹åŠ©æ‰‹</title>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #f5f5f5; height: 100vh; }
        .container { width: 100%; height: 100vh; background: #fff; display: flex; flex-direction: column; }

        /* å·¥ä½œç©ºé—´Tabæ  */
        .workspace-tabs { background: #1a1a1a; padding: 0 20px; display: flex; gap: 3px; overflow-x: auto; border-bottom: 2px solid #000; }
        .workspace-tab { padding: 10px 20px; background: transparent; border: none; color: #999; font-size: 12px; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; }
        .workspace-tab:hover { color: #fff; }
        .workspace-tab.active { color: #fff; border-bottom-color: #4caf50; background: rgba(255,255,255,0.05); }
        .workspace-tab-new { background: #2c2c2c; color: #4caf50; }
        .workspace-path { font-size: 10px; color: #666; margin-top: 2px; }
        
        /* æ¨¡å—Tab */
        .module-tabs { background: #2c2c2c; padding: 0 30px; display: flex; border-bottom: 1px solid #1a1a1a; }
        .module-tab { padding: 12px 24px; background: transparent; border: none; color: #999; font-size: 13px; cursor: pointer; border-bottom: 2px solid transparent; }
        .module-tab:hover { color: #fff; }
        .module-tab.active { color: #fff; border-bottom-color: #fff; }
        
        /* å¯¹è¯Tab */
        .conversation-tabs { background: #f5f5f5; padding: 8px 20px; display: flex; gap: 8px; overflow-x: auto; border-bottom: 1px solid #ddd; }
        .conversation-tab { padding: 8px 16px; background: #fff; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; cursor: pointer; }
        .conversation-tab:hover { background: #f8f8f8; }
        .conversation-tab.active { background: #2c2c2c; color: #fff; border-color: #2c2c2c; }
        .conversation-tab.new { background: #4caf50; color: #fff; border-color: #4caf50; }
        
        /* å†…å®¹Tab */
        .content-tabs { background: #fafafa; padding: 0 20px; display: flex; border-bottom: 1px solid #e0e0e0; }
        .content-tab { padding: 10px 20px; background: transparent; border: none; color: #666; font-size: 12px; cursor: pointer; border-bottom: 2px solid transparent; }
        .content-tab:hover { color: #2c2c2c; }
        .content-tab.active { color: #2c2c2c; border-bottom-color: #2c2c2c; font-weight: 500; }
        
        /* èŠå¤©åŒºåŸŸ */
        .chat-area { flex: 1; overflow-y: auto; padding: 30px 40px; background: #fafafa; }
        .message { margin-bottom: 25px; }
        .message.user { display: flex; justify-content: flex-end; }
        .message.assistant { display: flex; justify-content: flex-start; }
        .message-content { max-width: 75%; padding: 15px 20px; border-radius: 4px; line-height: 1.8; font-size: 14px; }
        .message.user .message-content { background: #2c2c2c; color: #fff; border-left: 3px solid #666; }
        .message.assistant .message-content { background: #fff; color: #2c2c2c; border-left: 3px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        
        .input-area { padding: 20px 30px; background: #fff; border-top: 1px solid #e0e0e0; }
        .input-container { display: flex; gap: 12px; align-items: center; }
        .input-field { flex: 1; padding: 12px 18px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px; background: #fafafa; }
        .input-field:focus { outline: none; border-color: #666; background: #fff; }
        .btn-send { padding: 12px 30px; background: #2c2c2c; color: #fff; border: none; border-radius: 3px; cursor: pointer; }
        .btn-send:hover { background: #1a1a1a; }
        .btn-send:disabled { opacity: 0.5; }
        
        .context-usage { display: flex; align-items: center; gap: 8px; margin-left: 15px; }
        .circle-progress { position: relative; width: 40px; height: 40px; }
        .circle-progress svg { transform: rotate(-90deg); }
        .circle-bg { fill: none; stroke: #e0e0e0; stroke-width: 3; }
        .circle-fill { fill: none; stroke: #2c2c2c; stroke-width: 3; stroke-linecap: round; transition: stroke-dashoffset 0.3s; }
        .circle-fill.warning { stroke: #ff9800; }
        .circle-fill.danger { stroke: #f44336; }
        .circle-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; font-weight: 600; }
        
        .thinking { text-align: center; padding: 15px; color: #666; font-style: italic; font-size: 13px; }
        .empty-state { text-align: center; padding: 80px 20px; color: #999; }
        .empty-state h2 { font-size: 48px; margin-bottom: 15px; font-weight: 300; }
        
        .panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { padding: 20px 30px; background: #fafafa; border-bottom: 1px solid #e0e0e0; }
        .panel-header h3 { font-size: 16px; font-weight: 500; color: #2c2c2c; margin-bottom: 5px; }
        .panel-header p { font-size: 12px; color: #666; }
        .panel-content { flex: 1; overflow-y: auto; padding: 20px 30px; }
        
        .stat-box { background: #fff; border: 1px solid #ddd; border-radius: 3px; padding: 15px; margin-bottom: 15px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 13px; }
        .stat-label { color: #666; }
        .stat-value { font-weight: 500; color: #2c2c2c; }
        
        .message-list { background: #fff; border: 1px solid #ddd; border-radius: 3px; padding: 15px; max-height: 500px; overflow-y: auto; }
        .message-item { padding: 12px; margin-bottom: 12px; border-left: 3px solid #ddd; border-radius: 3px; }
        .message-item.user { background: #2c2c2c; color: #fff; border-left-color: #666; }
        .message-item.assistant { background: #fff; border: 1px solid #e0e0e0; }
        .message-header { font-size: 11px; opacity: 0.7; margin-bottom: 8px; }
        .message-text { font-size: 13px; line-height: 1.6; white-space: pre-wrap; font-family: Consolas, monospace; }
        
        .btn-action { padding: 8px 16px; background: #2c2c2c; color: #fff; border: none; border-radius: 3px; font-size: 12px; cursor: pointer; }
        .btn-action:hover { background: #1a1a1a; }
        .btn-secondary { background: #fff; color: #2c2c2c; border: 1px solid #ddd; }
        .btn-secondary:hover { background: #f5f5f5; }
        
        .footer-controls { padding: 10px 30px; background: #f5f5f5; border-top: 1px solid #e0e0e0; display: flex; justify-content: center; gap: 15px; }
        .btn-zoom { padding: 4px 12px; background: #fff; border: 1px solid #ddd; color: #333; border-radius: 2px; font-size: 11px; cursor: pointer; }
        .btn-zoom:hover { background: #2c2c2c; color: #fff; }
        
        .editable-name { cursor: pointer; display: inline-block; padding: 2px 6px; border-radius: 2px; }
        .editable-name:hover { background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>
    <div class="container">
        <!-- Level 1: å·¥ä½œç©ºé—´Tab -->
        <div class="workspace-tabs" id="workspaceTabs">
            <button class="workspace-tab active">
                <div class="editable-name" ondblclick="editWorkspaceName(this)" data-id="">å·¥ä½œç©ºé—´ 1</div>
                <div class="workspace-path">C:\Projects\MyAgent</div>
            </button>
            <button class="workspace-tab workspace-tab-new" onclick="addWorkspace()">+ æ·»åŠ å·¥ä½œç©ºé—´</button>
        </div>

        <!-- Level 2: æ¨¡å—Tab -->
        <div class="module-tabs">
            <button class="module-tab active" onclick="switchModule('conversation')">å¯¹è¯ç®¡ç†</button>
            <button class="module-tab" onclick="switchModule('history')">èŠå¤©è®°å½•ç®¡ç†</button>
        </div>

        <!-- å¯¹è¯ç®¡ç†æ¨¡å— -->
        <div id="conversationModule" style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
            <!-- Level 3: å¯¹è¯Tab -->
            <div class="conversation-tabs" id="conversationTabs">
                <button class="conversation-tab active">
                    <span class="editable-name" ondblclick="editConversationName(this)" data-id="">å¯¹è¯ 1</span>
                </button>
                <button class="conversation-tab new" onclick="createConversation()">+ æ–°å»ºå¯¹è¯</button>
            </div>

            <!-- Level 4: å†…å®¹Tab -->
            <div class="content-tabs">
                <button class="content-tab active" onclick="switchContent('chat')">å¯¹è¯è¯¦æƒ…</button>
                <button class="content-tab" onclick="switchContent('context')">Contexté¢„è§ˆ</button>
                <button class="content-tab" onclick="switchContent('test')">æµ‹è¯•</button>
            </div>

            <!-- å¯¹è¯è¯¦æƒ… -->
            <div id="chatPanel" class="panel">
                <div class="chat-area" id="chatArea">
                    <div class="empty-state"><h2>ğŸ“–</h2><p>å¼€å§‹å¯¹è¯</p></div>
                </div>
                <div class="input-area">
                    <div class="input-container">
                        <input class="input-field" id="messageInput" placeholder="æè¿°ä½ çš„éœ€æ±‚..." onkeypress="if(event.key==='Enter')sendMessage()">
                        <button class="btn-send" onclick="sendMessage()" id="sendBtn">å‘é€</button>
                        <div class="context-usage">
                            <div class="circle-progress">
                                <svg width="40" height="40">
                                    <circle class="circle-bg" cx="20" cy="20" r="16"></circle>
                                    <circle class="circle-fill" id="contextCircle" cx="20" cy="20" r="16" stroke-dasharray="100.48" stroke-dashoffset="100.48"></circle>
                                </svg>
                                <div class="circle-text" id="contextPercent">0%</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #999;">Context</div>
                                <div style="font-size: 12px; font-weight: 500;" id="contextTokens">0K/131K</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contexté¢„è§ˆ -->
            <div id="contextPanel" class="panel" style="display: none;">
                <div class="panel-header">
                    <h3>Context é¢„è§ˆ</h3>
                    <p>å½“å‰å¯¹è¯çš„Context</p>
                </div>
                <div class="panel-content">
                    <div class="stat-box">
                        <div class="stat-row"><span class="stat-label">æç¤ºTokens</span><span class="stat-value"><span id="promptTokens">0</span>K</span></div>
                        <div class="stat-row"><span class="stat-label">å®ŒæˆTokens</span><span class="stat-value"><span id="completionTokens">0</span>K</span></div>
                        <div class="stat-row"><span class="stat-label">æ€»è®¡Tokens</span><span class="stat-value"><span id="totalTokens">0</span>K</span></div>
                        <div class="stat-row"><span class="stat-label">æ¶ˆæ¯æ•°</span><span class="stat-value"><span id="messageCount">0</span></span></div>
                        <div style="margin-top: 15px; text-align: right;">
                            <button class="btn-action btn-secondary" onclick="compact()">ğŸ—œï¸ Compact</button>
                        </div>
                    </div>
                    <div class="message-list" id="contextList"></div>
                </div>
            </div>

            <!-- æµ‹è¯• -->
            <div id="testPanel" class="panel" style="display: none;">
                <div class="panel-header"><h3>è‡ªåŠ¨åŒ–æµ‹è¯•</h3></div>
                <div class="panel-content">
                    <button class="btn-action" onclick="runTests()">è¿è¡Œæµ‹è¯•</button>
                    <div class="stat-box" id="testStatus" style="margin-top: 15px;">å°±ç»ª</div>
                </div>
            </div>
        </div>

        <!-- èŠå¤©è®°å½•ç®¡ç†æ¨¡å— -->
        <div id="historyModule" style="display: none; flex-direction: column; flex: 1; overflow: hidden;">
            <div class="conversation-tabs" id="historyConversationTabs"></div>
            <div class="panel">
                <div class="panel-header"><h3>æ¶ˆæ¯å†å²</h3><p>å®Œæ•´è®°å½•</p></div>
                <div class="panel-content">
                    <div class="stat-box">
                        <div class="stat-row"><span class="stat-label">æ€»å­—ç¬¦</span><span class="stat-value"><span id="historyTotalChars">0</span></span></div>
                        <div class="stat-row"><span class="stat-label">ä¸­æ–‡</span><span class="stat-value"><span id="historyChineseChars">0</span></span></div>
                        <div class="stat-row"><span class="stat-label">è‹±æ–‡</span><span class="stat-value"><span id="historyEnglishChars">0</span></span></div>
                        <div class="stat-row"><span class="stat-label">æ¶ˆæ¯æ•°</span><span class="stat-value"><span id="historyCount">0</span></span></div>
                    </div>
                    <div class="message-list" id="historyList"></div>
                </div>
            </div>
        </div>

        <div class="footer-controls">
            <span style="font-size: 11px; color: #666;">ç¼©æ”¾</span>
            <button class="btn-zoom" onclick="zoomOut()">-5%</button>
            <span style="font-size: 11px; color: #999;" id="zoomDisplay">100%</span>
            <button class="btn-zoom" onclick="zoomIn()">+5%</button>
            <button class="btn-zoom" onclick="resetZoom()">é‡ç½®</button>
        </div>
    </div>

    <script>
        let bridge = null;
        let isProcessing = false;
        let currentZoom = 100;
        let workspaces = [];
        let conversations = [];
        let currentWorkspaceId = null;
        let currentConversationId = null;
        let isQtMode = false;  // Qtæ¨¡å¼ or Webæ¨¡å¼

        // æ£€æµ‹ç¯å¢ƒå¹¶åˆå§‹åŒ–
        if (typeof qt !== 'undefined' && qt.webChannelTransport) {
            // Qtç¯å¢ƒ - ä½¿ç”¨WebChannel
            isQtMode = true;
            console.log('âœ… Qtç¯å¢ƒ - ä½¿ç”¨WebChannel');
            
            new QWebChannel(qt.webChannelTransport, function(channel) {
                console.log('âœ… QWebChannelå·²è¿æ¥');
                
                bridge = channel.objects.bridge;
                
                console.log('âœ… bridgeå¯¹è±¡è·å–æˆåŠŸ');
                
                // è¿æ¥ä¿¡å·ï¼ˆåŠ LOGï¼‰
                bridge.messageReceived.connect(msg => {
                    console.log('ğŸ”” æ”¶åˆ°messageReceivedä¿¡å·');
                    handleMessage(JSON.parse(msg));
                });
                
                bridge.contextUpdated.connect(data => {
                    console.log('ğŸ”” æ”¶åˆ°contextUpdatedä¿¡å·');
                    updateContext(JSON.parse(data));
                });
                
                bridge.messageHistoryUpdated.connect(data => {
                    console.log('ğŸ”” æ”¶åˆ°messageHistoryUpdatedä¿¡å·');
                    updateHistory(JSON.parse(data));
                });
                
                bridge.conversationsUpdated.connect(data => {
                    console.log('ğŸ”” æ”¶åˆ°conversationsUpdatedä¿¡å·');
                    updateConversations(JSON.parse(data));
                });
                
                bridge.workspaceListUpdated.connect(data => {
                    console.log('ğŸ”” æ”¶åˆ°workspaceListUpdatedä¿¡å·');
                    updateWorkspaces(JSON.parse(data));
                });
                
                bridge.workspaceChanged.connect(path => {
                    console.log('ğŸ”” æ”¶åˆ°workspaceChangedä¿¡å·:', path);
                });
                
                console.log('âœ… æ‰€æœ‰ä¿¡å·å·²è¿æ¥');
                console.log('å¼€å§‹åˆå§‹åŒ–...');
                
                init();
            });
        } else {
            // Webç¯å¢ƒ - ä½¿ç”¨RESTful API
            isQtMode = false;
            console.log('Webç¯å¢ƒ - ä½¿ç”¨RESTful API');
            
            // åˆ›å»ºAPIé€‚é…å™¨
            bridge = createAPIAdapter();
            init();
        }
        
        // ç»Ÿä¸€åˆå§‹åŒ–
        function init() {
            console.log('åˆå§‹åŒ–å‰ç«¯...');
            
            // ç«‹å³åŠ è½½
            loadWorkspaces();
            loadConversations();
            
            // å»¶è¿Ÿå†åŠ è½½ä¸€æ¬¡ï¼ˆç¡®ä¿æ•°æ®åŒæ­¥ï¼‰
            setTimeout(() => {
                console.log('å»¶è¿Ÿåˆ·æ–°...');
                loadWorkspaces();
                loadConversations();
            }, 600);
        }
        
        // RESTful APIé€‚é…å™¨ï¼ˆæ¨¡æ‹ŸQt bridgeæ¥å£ï¼‰
        function createAPIAdapter() {
            const API_BASE = '/api';
            
            return {
                getWorkspaceList: async function() {
                    const res = await fetch(`${API_BASE}/workspaces`);
                    const json = await res.json();
                    return JSON.stringify(json.data);
                },
                
                switchWorkspace: async function(wsId) {
                    await fetch(`${API_BASE}/workspaces/${wsId}/switch`, {method: 'POST'});
                    setTimeout(() => {
                        this.emit_workspace_list();
                        this.emit_conversations();
                    }, 50);
                },
                
                getConversationList: async function() {
                    const res = await fetch(`${API_BASE}/conversations`);
                    const json = await res.json();
                    return JSON.stringify(json.data);
                },
                
                createConversation: async function() {
                    const res = await fetch(`${API_BASE}/conversations`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({workspace_id: currentWorkspaceId})
                    });
                    const json = await res.json();
                    setTimeout(() => this.emit_conversations(), 50);
                    return json.conversation_id;
                },
                
                switchConversation: async function(convId) {
                    await fetch(`${API_BASE}/conversations/${convId}/switch`, {method: 'POST'});
                    setTimeout(() => this.emit_context(), 50);
                },
                
                sendMessage: async function(message) {
                    const res = await fetch(`${API_BASE}/agent/chat`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({message, conversation_id: currentConversationId})
                    });
                    const json = await res.json();
                    
                    if (json.success && json.data.message) {
                        handleMessage({
                            type: 'response',
                            success: true,
                            message: json.data.message
                        });
                    }
                    
                    setTimeout(() => this.emit_context(), 50);
                },
                
                manualCompact: async function() {
                    await fetch(`${API_BASE}/context/${currentConversationId}/compact`, {method: 'POST'});
                    setTimeout(() => this.emit_context(), 50);
                },
                
                renameWorkspace: async function(wsId, newName) {
                    await fetch(`${API_BASE}/workspaces/${wsId}/rename`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({new_name: newName})
                    });
                },
                
                renameConversation: async function(convId, newName) {
                    await fetch(`${API_BASE}/conversations/${convId}/rename`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({new_name: newName})
                    });
                },
                
                selectWorkspace: function() {
                    alert('Webç‰ˆæš‚ä¸æ”¯æŒæ–‡ä»¶å¤¹é€‰æ‹©ï¼Œè¯·ä½¿ç”¨Qtç‰ˆ');
                },
                
                // æ¨¡æ‹Ÿemitæ–¹æ³•
                emit_workspace_list: function() {
                    this.getWorkspaceList().then(data => updateWorkspaces(JSON.parse(data)));
                },
                
                emit_conversations: function() {
                    this.getConversationList().then(data => updateConversations(JSON.parse(data)));
                },
                
                emit_context: async function() {
                    if (!currentConversationId) return;
                    const res = await fetch(`${API_BASE}/context/${currentConversationId}`);
                    const json = await res.json();
                    updateContext(json.data);
                }
            };
        }

        function loadWorkspaces() {
            if (!bridge) {
                console.log('âŒ loadWorkspaces: bridgeæœªå‡†å¤‡å¥½');
                return;
            }
            
            console.log('ğŸ“ è°ƒç”¨bridge.getWorkspaceList()');
            
            try {
                const result = bridge.getWorkspaceList();
                console.log('ğŸ“ getWorkspaceListè¿”å›:', typeof result);
                
                // å¤„ç†Promiseæˆ–ç›´æ¥å­—ç¬¦ä¸²
                if (result && typeof result.then === 'function') {
                    // å¼‚æ­¥Promise
                    result.then(data => {
                        console.log('âœ… Promise resolved, æ•°æ®é•¿åº¦:', data.length);
                        workspaces = JSON.parse(data);
                        console.log('âœ… è§£ææˆåŠŸ:', workspaces.length, 'ä¸ªå·¥ä½œç©ºé—´');
                        renderWorkspaceTabs();
                    });
                } else if (typeof result === 'string') {
                    // åŒæ­¥å­—ç¬¦ä¸²
                    console.log('âœ… åŒæ­¥è¿”å›, æ•°æ®é•¿åº¦:', result.length);
                    workspaces = JSON.parse(result);
                    console.log('âœ… è§£ææˆåŠŸ:', workspaces.length, 'ä¸ªå·¥ä½œç©ºé—´');
                    renderWorkspaceTabs();
                } else {
                    console.log('âŒ æœªçŸ¥è¿”å›ç±»å‹:', typeof result, result);
                }
            } catch (e) {
                console.error('âŒ loadWorkspacesé”™è¯¯:', e);
            }
        }

        function updateWorkspaces(data) {
            console.log('updateWorkspaces:', data.length, 'ä¸ªå·¥ä½œç©ºé—´');
            workspaces = data;
            renderWorkspaceTabs();
        }

        function renderWorkspaceTabs() {
            const bar = document.getElementById('workspaceTabs');
            let html = '';
            workspaces.forEach(ws => {
                const active = ws.active ? 'active' : '';
                html += `
                    <button class="workspace-tab ${active}" onclick="selectWorkspace('${ws.id}')">
                        <div class="editable-name" ondblclick="editWorkspaceName(this)" data-id="${ws.id}">${ws.name}</div>
                        <div class="workspace-path">${ws.path}</div>
                    </button>
                `;
            });
            html += '<button class="workspace-tab workspace-tab-new" onclick="addWorkspace()">+ æ·»åŠ å·¥ä½œç©ºé—´</button>';
            bar.innerHTML = html;
        }

        function selectWorkspace(wsId) {
            if (!bridge) return;
            
            console.log('åˆ‡æ¢å·¥ä½œç©ºé—´:', wsId);
            
            bridge.switchWorkspace(wsId);
            currentWorkspaceId = wsId;
            currentConversationId = null;  // é‡ç½®å¯¹è¯ID
            
            // æ¸…ç©ºèŠå¤©åŒºåŸŸ
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '<div class="empty-state"><h2>ğŸ“–</h2><p>å·²åˆ‡æ¢å·¥ä½œç©ºé—´ï¼Œå¼€å§‹æ–°å¯¹è¯</p></div>';
            
            // é‡ç½®Contextæ˜¾ç¤º
            document.getElementById('totalTokens').textContent = '0';
            document.getElementById('messageCount').textContent = '0';
            document.getElementById('contextPercent').textContent = '0%';
            document.getElementById('contextTokens').textContent = '0K/131K';
            document.getElementById('contextList').innerHTML = '';
            
            // åˆ·æ–°å·¥ä½œç©ºé—´å’Œå¯¹è¯åˆ—è¡¨
            setTimeout(() => {
                loadWorkspaces();
                loadConversations();
            }, 100);
        }

        function addWorkspace() {
            if (!bridge) return;
            bridge.selectWorkspace();
        }

        function editWorkspaceName(el) {
            const wsId = el.dataset.id;
            const oldName = el.textContent;
            const newName = prompt('é‡å‘½åå·¥ä½œç©ºé—´:', oldName);
            if (newName && newName !== oldName && bridge) {
                bridge.renameWorkspace(wsId, newName);
                el.textContent = newName;
            }
        }

        function loadConversations() {
            if (!bridge) {
                console.log('âŒ loadConversations: bridgeæœªå‡†å¤‡å¥½');
                return;
            }
            
            console.log('ğŸ“ è°ƒç”¨bridge.getConversationList()');
            
            try {
                const result = bridge.getConversationList();
                console.log('ğŸ“ getConversationListè¿”å›:', typeof result);
                
                if (result && typeof result.then === 'function') {
                    result.then(data => {
                        console.log('âœ… Promise resolved, æ•°æ®:', data.substring(0, 100));
                        conversations = JSON.parse(data);
                        console.log('âœ… è§£ææˆåŠŸ:', conversations.length, 'ä¸ªå¯¹è¯');
                        renderConversationTabs();
                    });
                } else if (typeof result === 'string') {
                    console.log('âœ… åŒæ­¥è¿”å›:', result.substring(0, 100));
                    conversations = JSON.parse(result);
                    console.log('âœ… è§£ææˆåŠŸ:', conversations.length, 'ä¸ªå¯¹è¯');
                    renderConversationTabs();
                } else {
                    console.log('âŒ æœªçŸ¥è¿”å›ç±»å‹:', typeof result);
                }
            } catch (e) {
                console.error('âŒ loadConversationsé”™è¯¯:', e);
            }
        }

        function renderConversationTabs() {
            console.log('ğŸ“ renderConversationTabs, å¯¹è¯æ•°:', conversations.length);
            
            const convBar = document.getElementById('conversationTabs');
            const histBar = document.getElementById('historyConversationTabs');
            
            let html = '';
            conversations.forEach((conv, idx) => {
                const active = conv.active ? 'active' : '';
                console.log(`  - å¯¹è¯${idx+1}: ${conv.name}, active=${conv.active}, æ¶ˆæ¯=${conv.message_count}`);
                
                html += `
                    <button class="conversation-tab ${active}" onclick="selectConversation('${conv.id}')">
                        <span class="editable-name" ondblclick="editConversationName(this)" data-id="${conv.id}">${conv.name}</span>
                    </button>
                `;
            });
            
            console.log('ğŸ“ å¯¹è¯Tab HTMLé•¿åº¦:', html.length);
            
            convBar.innerHTML = html + '<button class="conversation-tab new" onclick="createConversation()">+ æ–°å»ºå¯¹è¯</button>';
            histBar.innerHTML = html;
            
            console.log('âœ… å¯¹è¯Tabæ¸²æŸ“å®Œæˆ');
        }

        function createConversation() {
            if (!bridge) return;
            const result = bridge.createConversation();
            
            // ç­‰å¾…å®Œæˆååˆ·æ–°
            if (result && typeof result.then === 'function') {
                result.then(() => {
                    setTimeout(loadConversations, 100);
                });
            } else {
                setTimeout(loadConversations, 100);
            }
        }

        function selectConversation(convId) {
            if (!bridge) return;
            
            console.log('åˆ‡æ¢å¯¹è¯:', convId);
            
            bridge.switchConversation(convId);
            currentConversationId = convId;
            
            // æ˜¾ç¤ºåŠ è½½ä¸­
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '<div class="thinking">åŠ è½½å¯¹è¯å†å²...</div>';
            
            // åˆ·æ–°å¯¹è¯åˆ—è¡¨å’ŒContextï¼ˆContextæ›´æ–°ä¼šè§¦å‘MessageHistoryæ›´æ–°ï¼‰
            setTimeout(() => {
                loadConversations();
            }, 100);
        }

        function editConversationName(el) {
            const convId = el.dataset.id;
            const oldName = el.textContent;
            const newName = prompt('é‡å‘½åå¯¹è¯:', oldName);
            if (newName && newName !== oldName && bridge) {
                bridge.renameConversation(convId, newName);
                el.textContent = newName;
            }
        }

        function switchModule(module) {
            document.querySelectorAll('.module-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('conversationModule').style.display = module === 'conversation' ? 'flex' : 'none';
            document.getElementById('historyModule').style.display = module === 'history' ? 'flex' : 'none';
        }

        function switchContent(tab) {
            document.querySelectorAll('.content-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('chatPanel').style.display = tab === 'chat' ? 'flex' : 'none';
            document.getElementById('contextPanel').style.display = tab === 'context' ? 'flex' : 'none';
            document.getElementById('testPanel').style.display = tab === 'test' ? 'flex' : 'none';
        }

        function handleMessage(data) {
            if (data.type === 'thinking') showThinking();
            else if (data.type === 'compressing') showCompressing();
            else if (data.type === 'response') {
                hideThinking();
                if (data.message?.trim()) addAssistantMessage(data);
                isProcessing = false;
                updateSendButton();
            }
            else if (data.type === 'error') {
                hideThinking();
                alert(data.message);
                isProcessing = false;
                updateSendButton();
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const msg = input.value.trim();
            if (!msg || !bridge || isProcessing) return;
            
            addUserMessage(msg);
            input.value = '';
            isProcessing = true;
            updateSendButton();
            bridge.sendMessage(msg);
        }

        function addUserMessage(text) {
            const area = document.getElementById('chatArea');
            area.querySelector('.empty-state')?.remove();
            const div = document.createElement('div');
            div.className = 'message user';
            div.innerHTML = `<div class="message-content">${escapeHtml(text)}</div>`;
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function addAssistantMessage(data) {
            const area = document.getElementById('chatArea');
            const div = document.createElement('div');
            div.className = 'message assistant';
            div.innerHTML = `<div class="message-content">${formatMarkdown(data.message)}</div>`;
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function showThinking() {
            const area = document.getElementById('chatArea');
            const div = document.createElement('div');
            div.className = 'thinking';
            div.id = 'thinking';
            div.textContent = 'æ€è€ƒä¸­...';
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function showCompressing() {
            hideThinking();
            const area = document.getElementById('chatArea');
            const div = document.createElement('div');
            div.className = 'thinking';
            div.id = 'thinking';
            div.textContent = 'ğŸ—œï¸ æ­£åœ¨æ•´ç†å¯¹è¯...';
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function hideThinking() {
            document.getElementById('thinking')?.remove();
        }

        function updateSendButton() {
            const btn = document.getElementById('sendBtn');
            btn.disabled = isProcessing;
            btn.textContent = isProcessing ? 'å¤„ç†ä¸­...' : 'å‘é€';
        }

        function updateContext(data) {
            console.log('updateContext:', data.message_count, 'æ¡æ¶ˆæ¯', data.token_usage.total_tokens, 'tokens');
            
            document.getElementById('promptTokens').textContent = (data.token_usage.prompt_tokens / 1000).toFixed(1);
            document.getElementById('completionTokens').textContent = (data.token_usage.completion_tokens / 1000).toFixed(1);
            document.getElementById('totalTokens').textContent = (data.token_usage.total_tokens / 1000).toFixed(1);
            document.getElementById('messageCount').textContent = data.message_count;
            updateContextCircle(data.token_usage.total_tokens);
            
            const list = document.getElementById('contextList');
            if (data.messages.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Contextä¸ºç©º</div>';
            } else {
                let html = '';
                data.messages.forEach((msg, idx) => {
                    const role = msg.role === 'user' ? 'user' : 'assistant';
                    const name = msg.role === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹';
                    const display = msg.content.length > 300 ? msg.content.substring(0, 300) + '...' : msg.content;
                    html += `<div class="message-item ${role}"><div class="message-header">[${idx+1}] ${name}</div><div class="message-text">${escapeHtml(display)}</div></div>`;
                });
                list.innerHTML = html;
            }
        }

        function updateHistory(data) {
            const msgs = data.messages || [];
            console.log('updateHistory:', msgs.length, 'æ¡æ¶ˆæ¯');
            
            // ç»Ÿè®¡å­—ç¬¦ï¼ˆèŠå¤©è®°å½•ç®¡ç†æ¨¡å—ç”¨ï¼‰
            let total = 0, chinese = 0, english = 0;
            msgs.forEach(m => {
                const c = m.content || '';
                total += c.length;
                chinese += (c.match(/[\u4e00-\u9fa5]/g) || []).length;
                english += (c.match(/[a-zA-Z]/g) || []).length;
            });
            
            document.getElementById('historyTotalChars').textContent = total.toLocaleString();
            document.getElementById('historyChineseChars').textContent = chinese.toLocaleString();
            document.getElementById('historyEnglishChars').textContent = english.toLocaleString();
            document.getElementById('historyCount').textContent = msgs.length;
            
            // æ¸²æŸ“åˆ°èŠå¤©è®°å½•ç®¡ç†æ¨¡å—
            const list = document.getElementById('historyList');
            if (msgs.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">æš‚æ— æ¶ˆæ¯</div>';
            } else {
                let html = '';
                msgs.forEach((msg, idx) => {
                    const role = msg.role === 'user' ? 'user' : 'assistant';
                    const name = msg.role === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹';
                    const display = msg.content.length > 300 ? msg.content.substring(0, 300) + '...' : msg.content;
                    html += `<div class="message-item ${role}"><div class="message-header">[${idx+1}] ${name}</div><div class="message-text">${escapeHtml(display)}</div></div>`;
                });
                list.innerHTML = html;
            }
            
            // ========== å…³é”®ï¼šåŒæ—¶æ¸²æŸ“åˆ°å¯¹è¯è¯¦æƒ…ï¼ˆèŠå¤©ç•Œé¢ï¼‰==========
            renderChatHistory(msgs);
        }
        
        function renderChatHistory(msgs) {
            const chatArea = document.getElementById('chatArea');
            
            if (msgs.length === 0) {
                chatArea.innerHTML = '<div class="empty-state"><h2>ğŸ“–</h2><p>å¼€å§‹å¯¹è¯</p></div>';
                return;
            }
            
            // æ¸…ç©º
            chatArea.innerHTML = '';
            
            // æ¸²æŸ“æ‰€æœ‰å†å²æ¶ˆæ¯
            msgs.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'message ' + (msg.role === 'user' ? 'user' : 'assistant');
                div.innerHTML = `<div class="message-content">${formatMarkdown(msg.content)}</div>`;
                chatArea.appendChild(div);
            });
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function updateConversations(data) {
            console.log('updateConversations:', data.length, 'ä¸ªå¯¹è¯');
            conversations = data;
            renderConversationTabs();
        }

        function updateContextCircle(totalTokens) {
            const maxTokens = 131072;
            const percentage = (totalTokens / maxTokens) * 100;
            const circumference = 100.48;
            const offset = circumference - (percentage / 100) * circumference;
            
            const circle = document.getElementById('contextCircle');
            circle.style.strokeDashoffset = offset;
            
            if (percentage >= 90) {
                circle.classList.add('danger');
                circle.classList.remove('warning');
            } else if (percentage >= 70) {
                circle.classList.add('warning');
                circle.classList.remove('danger');
            } else {
                circle.classList.remove('warning', 'danger');
            }
            
            document.getElementById('contextPercent').textContent = percentage.toFixed(0) + '%';
            document.getElementById('contextTokens').textContent = (totalTokens / 1000).toFixed(1) + 'K/131K';
        }

        function compact() {
            if (!bridge) return;
            if (confirm('ç¡®å®šå‹ç¼©Contextï¼Ÿ')) bridge.manualCompact();
        }

        function formatMarkdown(text) {
            let html = escapeHtml(text);
            html = html.replace(/```[\s\S]*?```/g, m => '<pre>' + m + '</pre>');
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function zoomIn() { currentZoom = Math.min(currentZoom + 5, 200); applyZoom(); }
        function zoomOut() { currentZoom = Math.max(currentZoom - 5, 50); applyZoom(); }
        function resetZoom() { currentZoom = 100; applyZoom(); }
        function applyZoom() {
            document.body.style.zoom = currentZoom + '%';
            document.getElementById('zoomDisplay').textContent = currentZoom + '%';
        }

        function runTests() { alert('æµ‹è¯•åŠŸèƒ½'); }
    </script>
</body>
</html>
