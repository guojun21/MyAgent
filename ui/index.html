<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI编程助手</title>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #f5f5f5; height: 100vh; }
        .container { width: 100%; height: 100vh; background: #fff; display: flex; flex-direction: column; }

        /* 工作空间Tab栏 */
        .workspace-tabs { background: #1a1a1a; padding: 0 20px; display: flex; gap: 3px; overflow-x: auto; border-bottom: 2px solid #000; }
        .workspace-tab { padding: 10px 20px; background: transparent; border: none; color: #999; font-size: 12px; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; }
        .workspace-tab:hover { color: #fff; }
        .workspace-tab.active { color: #fff; border-bottom-color: #4caf50; background: rgba(255,255,255,0.05); }
        .workspace-tab-new { background: #2c2c2c; color: #4caf50; }
        .workspace-path { font-size: 10px; color: #666; margin-top: 2px; }
        
        /* 模块Tab */
        .module-tabs { background: #2c2c2c; padding: 0 30px; display: flex; border-bottom: 1px solid #1a1a1a; }
        .module-tab { padding: 12px 24px; background: transparent; border: none; color: #999; font-size: 13px; cursor: pointer; border-bottom: 2px solid transparent; }
        .module-tab:hover { color: #fff; }
        .module-tab.active { color: #fff; border-bottom-color: #fff; }
        
        /* 对话Tab */
        .conversation-tabs { background: #f5f5f5; padding: 8px 20px; display: flex; gap: 8px; overflow-x: auto; border-bottom: 1px solid #ddd; }
        .conversation-tab { padding: 8px 16px; background: #fff; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; cursor: pointer; }
        .conversation-tab:hover { background: #f8f8f8; }
        .conversation-tab.active { background: #2c2c2c; color: #fff; border-color: #2c2c2c; }
        .conversation-tab.new { background: #4caf50; color: #fff; border-color: #4caf50; }
        
        /* 内容Tab */
        .content-tabs { background: #fafafa; padding: 0 20px; display: flex; border-bottom: 1px solid #e0e0e0; }
        .content-tab { padding: 10px 20px; background: transparent; border: none; color: #666; font-size: 12px; cursor: pointer; border-bottom: 2px solid transparent; }
        .content-tab:hover { color: #2c2c2c; }
        .content-tab.active { color: #2c2c2c; border-bottom-color: #2c2c2c; font-weight: 500; }
        
        /* 聊天区域 */
        .chat-area { flex: 1; overflow-y: auto; padding: 30px 40px; background: #fafafa; }
        .message { margin-bottom: 20px; }
        .message.user { display: flex; justify-content: flex-end; }
        .message.assistant { display: flex; justify-content: flex-start; }
        .message-content { max-width: 75%; padding: 12px 18px; border-radius: 4px; line-height: 1.3; font-size: 14px; }
        .message.user .message-content { background: #2c2c2c; color: #fff; border-left: 3px solid #666; }
        .message.assistant .message-content { background: #fff; color: #2c2c2c; border-left: 3px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        
        .input-area { padding: 20px 30px; background: #fff; border-top: 1px solid #e0e0e0; }
        .input-container { display: flex; gap: 12px; align-items: center; }
        .input-field { flex: 1; padding: 12px 18px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px; background: #fafafa; }
        .input-field:focus { outline: none; border-color: #666; background: #fff; }
        .btn-send { padding: 12px 30px; background: #2c2c2c; color: #fff; border: none; border-radius: 3px; cursor: pointer; }
        .btn-send:hover { background: #1a1a1a; }
        .btn-send:disabled { opacity: 0.5; }
        
        .context-usage { display: flex; align-items: center; gap: 8px; margin-left: 15px; }
        .circle-progress { position: relative; width: 40px; height: 40px; }
        .circle-progress svg { transform: rotate(-90deg); }
        .circle-bg { fill: none; stroke: #e0e0e0; stroke-width: 3; }
        .circle-fill { fill: none; stroke: #2c2c2c; stroke-width: 3; stroke-linecap: round; transition: stroke-dashoffset 0.3s; }
        .circle-fill.warning { stroke: #ff9800; }
        .circle-fill.danger { stroke: #f44336; }
        .circle-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; font-weight: 600; }
        
        .thinking { text-align: center; padding: 15px; color: #666; font-style: italic; font-size: 13px; }
        .empty-state { text-align: center; padding: 80px 20px; color: #999; }
        .empty-state h2 { font-size: 48px; margin-bottom: 15px; font-weight: 300; }
        
        .panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { padding: 20px 30px; background: #fafafa; border-bottom: 1px solid #e0e0e0; }
        .panel-header h3 { font-size: 16px; font-weight: 500; color: #2c2c2c; margin-bottom: 5px; }
        .panel-header p { font-size: 12px; color: #666; }
        .panel-content { flex: 1; overflow-y: auto; padding: 20px 30px; }
        
        .stat-box { background: #fff; border: 1px solid #ddd; border-radius: 3px; padding: 15px; margin-bottom: 15px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 13px; }
        .stat-label { color: #666; }
        .stat-value { font-weight: 500; color: #2c2c2c; }
        
        .message-list { background: #fff; border: 1px solid #ddd; border-radius: 3px; padding: 15px; max-height: 500px; overflow-y: auto; }
        .message-item { padding: 12px; margin-bottom: 12px; border-left: 3px solid #ddd; border-radius: 3px; }
        .message-item.user { background: #2c2c2c; color: #fff; border-left-color: #666; }
        .message-item.assistant { background: #fff; border: 1px solid #e0e0e0; }
        .message-header { font-size: 11px; opacity: 0.7; margin-bottom: 8px; }
        .message-text { font-size: 13px; line-height: 1.3; white-space: pre-wrap; font-family: Consolas, monospace; }
        
        .btn-action { padding: 8px 16px; background: #2c2c2c; color: #fff; border: none; border-radius: 3px; font-size: 12px; cursor: pointer; }
        .btn-action:hover { background: #1a1a1a; }
        .btn-secondary { background: #fff; color: #2c2c2c; border: 1px solid #ddd; }
        .btn-secondary:hover { background: #f5f5f5; }
        
        .footer-controls { padding: 10px 30px; background: #f5f5f5; border-top: 1px solid #e0e0e0; display: flex; justify-content: center; gap: 15px; }
        .btn-zoom { padding: 4px 12px; background: #fff; border: 1px solid #ddd; color: #333; border-radius: 2px; font-size: 11px; cursor: pointer; }
        .btn-zoom:hover { background: #2c2c2c; color: #fff; }
        
        .editable-name { cursor: pointer; display: inline-block; padding: 2px 6px; border-radius: 2px; }
        .editable-name:hover { background: rgba(255,255,255,0.1); }
        
        /* 流式渲染动画 */
        @keyframes fadeInPulse {
            0% { opacity: 0; transform: scale(0.95); }
            50% { opacity: 0.5; transform: scale(1.02); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 执行中指示器 */
        .executing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 12px;
            font-size: 11px;
            color: #856404;
            font-weight: 500;
            animation: slideInUp 0.3s ease;
        }
        
        .executing-indicator .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid #ffc107;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 查看参数按钮 */
        .btn-view-params {
            margin-top: 8px;
            padding: 6px 12px;
            background: #2c2c2c;
            color: #fff;
            border: none;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-view-params:hover {
            background: #1a1a1a;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .btn-view-params:active {
            transform: translateY(0);
        }
        
        /* 参数弹窗专用样式 */
        .params-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            animation: fadeIn 0.2s ease-in;
        }
        
        .params-modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .params-modal-content {
            background: #fff;
            border-radius: 6px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            width: 90%;
            max-width: 1000px;
            height: 85%;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease-out;
        }
        
        .params-modal-header {
            padding: 20px 25px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
        }
        
        .params-modal-title {
            font-size: 16px;
            font-weight: 500;
            color: #2c2c2c;
        }
        
        .params-modal-body {
            padding: 20px 25px;
            overflow-y: auto;
            flex: 1;
            background: #f5f5f5;
        }
        
        .params-section {
            margin-bottom: 20px;
            background: #fff;
            border-radius: 4px;
            padding: 15px;
            border: 1px solid #ddd;
        }
        
        .params-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .params-content {
            font-size: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            background: #fafafa;
            padding: 12px;
            border-radius: 3px;
            border: 1px solid #e0e0e0;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.5;
            color: #2c2c2c;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .params-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .params-content::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }
        
        /* 入参区域滚动条样式（添加到通用样式中）*/
        div[style*="max-height: 200px"]::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        div[style*="max-height: 200px"]::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }
        
        div[style*="max-height: 200px"]::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Level 1: 工作空间Tab -->
        <div class="workspace-tabs" id="workspaceTabs">
            <button class="workspace-tab active">
                <div class="editable-name" ondblclick="editWorkspaceName(this)" data-id="">工作空间 1</div>
                <div class="workspace-path">C:\Projects\MyAgent</div>
            </button>
            <button class="workspace-tab workspace-tab-new" onclick="addWorkspace()">+ 添加工作空间</button>
        </div>

        <!-- Level 2: 模块Tab -->
        <div class="module-tabs">
            <button class="module-tab active" onclick="switchModule('conversation')">对话管理</button>
            <button class="module-tab" onclick="switchModule('history')">聊天记录管理</button>
        </div>

        <!-- 对话管理模块 -->
        <div id="conversationModule" style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
            <!-- Level 3: 对话Tab -->
            <div class="conversation-tabs" id="conversationTabs">
                <button class="conversation-tab active">
                    <span class="editable-name" ondblclick="editConversationName(this)" data-id="">对话 1</span>
                </button>
                <button class="conversation-tab new" onclick="createConversation()">+ 新建对话</button>
            </div>

            <!-- Level 4: 内容Tab -->
            <div class="content-tabs">
                <button class="content-tab active" onclick="switchContent('chat')">对话详情</button>
                <button class="content-tab" onclick="switchContent('context')">Context预览</button>
                <button class="content-tab" onclick="switchContent('test')">测试</button>
            </div>

            <!-- 对话详情 -->
            <div id="chatPanel" class="panel">
                <div class="chat-area" id="chatArea">
                    <div class="empty-state"><h2>📖</h2><p>开始对话</p></div>
                </div>
                <div class="input-area">
                    <div class="input-container">
                        <input class="input-field" id="messageInput" placeholder="描述你的需求..." onkeypress="if(event.key==='Enter')sendMessage()">
                        <button class="btn-send" onclick="sendMessage()" id="sendBtn">发送</button>
                        <div class="context-usage">
                            <div class="circle-progress">
                                <svg width="40" height="40">
                                    <circle class="circle-bg" cx="20" cy="20" r="16"></circle>
                                    <circle class="circle-fill" id="contextCircle" cx="20" cy="20" r="16" stroke-dasharray="100.48" stroke-dashoffset="100.48"></circle>
                                </svg>
                                <div class="circle-text" id="contextPercent">0%</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #999;">Context</div>
                                <div style="font-size: 12px; font-weight: 500;" id="contextTokens">0K/131K</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Context预览 -->
            <div id="contextPanel" class="panel" style="display: none;">
                <div class="panel-header">
                    <h3>Context 预览</h3>
                    <p>当前对话的Context</p>
                </div>
                <div class="panel-content">
                    <div class="stat-box">
                        <div class="stat-row"><span class="stat-label">提示Tokens</span><span class="stat-value"><span id="promptTokens">0</span>K</span></div>
                        <div class="stat-row"><span class="stat-label">完成Tokens</span><span class="stat-value"><span id="completionTokens">0</span>K</span></div>
                        <div class="stat-row"><span class="stat-label">总计Tokens</span><span class="stat-value"><span id="totalTokens">0</span>K</span></div>
                        <div class="stat-row"><span class="stat-label">消息数</span><span class="stat-value"><span id="messageCount">0</span></span></div>
                        <div style="margin-top: 15px; text-align: right;">
                            <button class="btn-action btn-secondary" onclick="compact()">🗜️ Compact</button>
                        </div>
                    </div>
                    <div class="message-list" id="contextList"></div>
                </div>
            </div>

            <!-- 测试 -->
            <div id="testPanel" class="panel" style="display: none;">
                <div class="panel-header"><h3>自动化测试</h3></div>
                <div class="panel-content">
                    <button class="btn-action" onclick="runTests()">运行测试</button>
                    <div class="stat-box" id="testStatus" style="margin-top: 15px;">就绪</div>
                </div>
            </div>
        </div>

        <!-- 聊天记录管理模块 -->
        <div id="historyModule" style="display: none; flex-direction: column; flex: 1; overflow: hidden;">
            <div class="conversation-tabs" id="historyConversationTabs"></div>
            <div class="panel">
                <div class="panel-header"><h3>消息历史</h3><p>完整记录</p></div>
                <div class="panel-content">
                    <div class="stat-box">
                        <div class="stat-row"><span class="stat-label">总字符</span><span class="stat-value"><span id="historyTotalChars">0</span></span></div>
                        <div class="stat-row"><span class="stat-label">中文</span><span class="stat-value"><span id="historyChineseChars">0</span></span></div>
                        <div class="stat-row"><span class="stat-label">英文</span><span class="stat-value"><span id="historyEnglishChars">0</span></span></div>
                        <div class="stat-row"><span class="stat-label">消息数</span><span class="stat-value"><span id="historyCount">0</span></span></div>
                    </div>
                    <div class="message-list" id="historyList"></div>
                </div>
            </div>
        </div>

        <div class="footer-controls">
            <span style="font-size: 11px; color: #666;">缩放</span>
            <button class="btn-zoom" onclick="zoomOut()">-5%</button>
            <span style="font-size: 11px; color: #999;" id="zoomDisplay">100%</span>
            <button class="btn-zoom" onclick="zoomIn()">+5%</button>
            <button class="btn-zoom" onclick="resetZoom()">重置</button>
        </div>
    </div>

    <!-- 参数查看弹窗 -->
    <div class="params-modal" id="paramsModal" onclick="closeParamsModal(event)">
        <div class="params-modal-content" onclick="event.stopPropagation()">
            <div class="params-modal-header">
                <div class="params-modal-title" id="paramsModalTitle">工具参数详情</div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn-copy" onclick="copyParams()">📋 复制全部</button>
                    <button class="modal-close" onclick="closeParamsModal()">&times;</button>
                </div>
            </div>
            <div class="params-modal-body">
                <div class="params-section">
                    <div class="params-section-title">📥 入参 (Arguments)</div>
                    <div class="params-content" id="paramsInput"></div>
                </div>
                <div class="params-section">
                    <div class="params-section-title">📤 出参 (Result)</div>
                    <div class="params-content" id="paramsOutput"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== 前端日志系统（简化版，避免崩溃）==========
        let frontendLogs = [];
        let logSaveTimer = null;
        
        // 简单的日志收集（暂时禁用，避免崩溃）
        function logToFile(level, ...args) {
            // 只输出到console，不保存
            try {
                console[level](...args);
            } catch (e) {
                // 忽略
            }
        }
        
        // 暂时禁用日志保存（避免崩溃）
        function saveFrontendLogsNow() {
            // 禁用
        }
        
        // ========== 应用变量 ==========
        let bridge = null;
        let isProcessing = false;
        let currentZoom = 100;
        let workspaces = [];
        let conversations = [];
        let currentWorkspaceId = null;
        let currentConversationId = null;
        let isQtMode = false;
        let enableStreaming = true;  // 是否启用流式渲染（加载历史时禁用）

        // 初始化时记录（简化，避免崩溃）
        try {
            console.log('=== 前端启动 ===');
        } catch (e) {
            // 如果console出错，忽略
        }
        
        // 检测环境并初始化
        if (typeof qt !== 'undefined' && qt.webChannelTransport) {
            // Qt环境 - 使用WebChannel
            isQtMode = true;
            console.log('✅ Qt环境 - 使用WebChannel');
            
            new QWebChannel(qt.webChannelTransport, function(channel) {
                console.log('✅ QWebChannel已连接');
                
                bridge = channel.objects.bridge;
                
                console.log('✅ bridge对象获取成功');
                
                // 连接信号（加LOG）
                bridge.messageReceived.connect(msg => {
                    console.log('🔔 收到messageReceived信号');
                    handleMessage(JSON.parse(msg));
                });
                
                bridge.contextUpdated.connect(data => {
                    console.log('🔔 收到contextUpdated信号');
                    try {
                        updateContext(JSON.parse(data));
                    } catch (e) {
                        console.error('❌ updateContext失败:', e);
                    }
                });
                
                bridge.messageHistoryUpdated.connect(data => {
                    console.log('🔔 收到messageHistoryUpdated信号');
                    try {
                        updateHistory(JSON.parse(data));
                    } catch (e) {
                        console.error('❌ updateHistory失败:', e);
                    }
                });
                
                bridge.conversationsUpdated.connect(data => {
                    console.log('🔔 收到conversationsUpdated信号');
                    updateConversations(JSON.parse(data));
                });
                
                bridge.workspaceListUpdated.connect(data => {
                    console.log('🔔 收到workspaceListUpdated信号');
                    updateWorkspaces(JSON.parse(data));
                });
                
                bridge.workspaceChanged.connect(path => {
                    console.log('🔔 收到workspaceChanged信号:', path);
                });
                
                console.log('✅ 所有信号已连接');
                console.log('开始初始化...');
                
                init();
            });
        } else {
            // Web环境 - 使用RESTful API
            isQtMode = false;
            console.log('Web环境 - 使用RESTful API');
            
            // 创建API适配器
            bridge = createAPIAdapter();
            init();
        }
        
        // 统一初始化
        function init() {
            console.log('🚀 初始化前端...');
            
            isLoadingHistory = true;  // 初始化时要加载历史
            
            // 加载工作空间和对话
            loadWorkspaces();
            loadConversations();
            
            // 1500ms后再标记历史已加载（后端1000ms + 500ms缓冲）
            setTimeout(() => {
                console.log('⏰ 1500ms延迟检查');
                // 如果还没有渲染历史，手动触发一次
                if (isLoadingHistory) {
                    console.log('⚠️ 历史未渲染，强制设为false');
                    isLoadingHistory = false;
                }
            }, 1500);
        }
        
        // RESTful API适配器（模拟Qt bridge接口）
        function createAPIAdapter() {
            const API_BASE = '/api';
            
            return {
                getWorkspaceList: async function() {
                    const res = await fetch(`${API_BASE}/workspaces`);
                    const json = await res.json();
                    return JSON.stringify(json.data);
                },
                
                switchWorkspace: async function(wsId) {
                    await fetch(`${API_BASE}/workspaces/${wsId}/switch`, {method: 'POST'});
                    setTimeout(() => {
                        this.emit_workspace_list();
                        this.emit_conversations();
                    }, 50);
                },
                
                getConversationList: async function() {
                    const res = await fetch(`${API_BASE}/conversations`);
                    const json = await res.json();
                    return JSON.stringify(json.data);
                },
                
                createConversation: async function() {
                    const res = await fetch(`${API_BASE}/conversations`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({workspace_id: currentWorkspaceId})
                    });
                    const json = await res.json();
                    setTimeout(() => this.emit_conversations(), 50);
                    return json.conversation_id;
                },
                
                switchConversation: async function(convId) {
                    await fetch(`${API_BASE}/conversations/${convId}/switch`, {method: 'POST'});
                    setTimeout(() => this.emit_context(), 50);
                },
                
                sendMessage: async function(message) {
                    const res = await fetch(`${API_BASE}/agent/chat`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({message, conversation_id: currentConversationId})
                    });
                    const json = await res.json();
                    
                    if (json.success && json.data.message) {
                        handleMessage({
                            type: 'response',
                            success: true,
                            message: json.data.message
                        });
                    }
                    
                    setTimeout(() => this.emit_context(), 50);
                },
                
                manualCompact: async function() {
                    await fetch(`${API_BASE}/context/${currentConversationId}/compact`, {method: 'POST'});
                    setTimeout(() => this.emit_context(), 50);
                },
                
                renameWorkspace: async function(wsId, newName) {
                    await fetch(`${API_BASE}/workspaces/${wsId}/rename`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({new_name: newName})
                    });
                },
                
                renameConversation: async function(convId, newName) {
                    await fetch(`${API_BASE}/conversations/${convId}/rename`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({new_name: newName})
                    });
                },
                
                selectWorkspace: function() {
                    alert('Web版暂不支持文件夹选择，请使用Qt版');
                },
                
                // 模拟emit方法
                emit_workspace_list: function() {
                    this.getWorkspaceList().then(data => updateWorkspaces(JSON.parse(data)));
                },
                
                emit_conversations: function() {
                    this.getConversationList().then(data => updateConversations(JSON.parse(data)));
                },
                
                emit_context: async function() {
                    if (!currentConversationId) return;
                    const res = await fetch(`${API_BASE}/context/${currentConversationId}`);
                    const json = await res.json();
                    updateContext(json.data);
                }
            };
        }

        function loadWorkspaces() {
            if (!bridge) {
                console.log('❌ loadWorkspaces: bridge未准备好');
                return;
            }
            
            console.log('📞 调用bridge.getWorkspaceList()');
            
            try {
                const result = bridge.getWorkspaceList();
                console.log('📞 getWorkspaceList返回:', typeof result);
                
                // 处理Promise或直接字符串
                if (result && typeof result.then === 'function') {
                    // 异步Promise
                    result.then(data => {
                        console.log('✅ Promise resolved, 数据长度:', data.length);
                        workspaces = JSON.parse(data);
                        console.log('✅ 解析成功:', workspaces.length, '个工作空间');
                        renderWorkspaceTabs();
                    });
                } else if (typeof result === 'string') {
                    // 同步字符串
                    console.log('✅ 同步返回, 数据长度:', result.length);
                    workspaces = JSON.parse(result);
                    console.log('✅ 解析成功:', workspaces.length, '个工作空间');
                    renderWorkspaceTabs();
                } else {
                    console.log('❌ 未知返回类型:', typeof result, result);
                }
            } catch (e) {
                console.error('❌ loadWorkspaces错误:', e);
            }
        }

        function updateWorkspaces(data) {
            console.log('updateWorkspaces:', data.length, '个工作空间');
            workspaces = data;
            renderWorkspaceTabs();
        }

        function renderWorkspaceTabs() {
            const bar = document.getElementById('workspaceTabs');
            let html = '';
            workspaces.forEach(ws => {
                const active = ws.active ? 'active' : '';
                html += `
                    <button class="workspace-tab ${active}" onclick="selectWorkspace('${ws.id}')">
                        <div class="editable-name" ondblclick="editWorkspaceName(this)" data-id="${ws.id}">${ws.name}</div>
                        <div class="workspace-path">${ws.path}</div>
                    </button>
                `;
            });
            html += '<button class="workspace-tab workspace-tab-new" onclick="addWorkspace()">+ 添加工作空间</button>';
            bar.innerHTML = html;
        }

        function selectWorkspace(wsId) {
            if (!bridge) return;
            
            console.log('切换工作空间:', wsId);
            
            bridge.switchWorkspace(wsId);
            currentWorkspaceId = wsId;
            currentConversationId = null;  // 重置对话ID
            
            // 清空聊天区域
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '<div class="empty-state"><h2>📖</h2><p>已切换工作空间，开始新对话</p></div>';
            
            // 重置Context显示
            document.getElementById('totalTokens').textContent = '0';
            document.getElementById('messageCount').textContent = '0';
            document.getElementById('contextPercent').textContent = '0%';
            document.getElementById('contextTokens').textContent = '0K/131K';
            document.getElementById('contextList').innerHTML = '';
            
            // 刷新工作空间和对话列表
            setTimeout(() => {
                loadWorkspaces();
                loadConversations();
            }, 100);
        }

        function addWorkspace() {
            if (!bridge) return;
            bridge.selectWorkspace();
        }

        function editWorkspaceName(el) {
            const wsId = el.dataset.id;
            const oldName = el.textContent;
            const newName = prompt('重命名工作空间:', oldName);
            if (newName && newName !== oldName && bridge) {
                bridge.renameWorkspace(wsId, newName);
                el.textContent = newName;
            }
        }

        function loadConversations() {
            if (!bridge) {
                console.log('❌ loadConversations: bridge未准备好');
                return;
            }
            
            console.log('📞 调用bridge.getConversationList()');
            
            try {
                const result = bridge.getConversationList();
                console.log('📞 getConversationList返回:', typeof result);
                
                if (result && typeof result.then === 'function') {
                    result.then(data => {
                        console.log('✅ Promise resolved, 数据:', data.substring(0, 100));
                        conversations = JSON.parse(data);
                        console.log('✅ 解析成功:', conversations.length, '个对话');
                        renderConversationTabs();
                    });
                } else if (typeof result === 'string') {
                    console.log('✅ 同步返回:', result.substring(0, 100));
                    conversations = JSON.parse(result);
                    console.log('✅ 解析成功:', conversations.length, '个对话');
                    renderConversationTabs();
                } else {
                    console.log('❌ 未知返回类型:', typeof result);
                }
            } catch (e) {
                console.error('❌ loadConversations错误:', e);
            }
        }

        function renderConversationTabs() {
            console.log('📝 renderConversationTabs, 对话数:', conversations.length);
            
            const convBar = document.getElementById('conversationTabs');
            const histBar = document.getElementById('historyConversationTabs');
            
            let html = '';
            conversations.forEach((conv, idx) => {
                const active = conv.active ? 'active' : '';
                console.log(`  - 对话${idx+1}: ${conv.name}, active=${conv.active}, 消息=${conv.message_count}`);
                
                html += `
                    <button class="conversation-tab ${active}" onclick="selectConversation('${conv.id}')">
                        <span class="editable-name" ondblclick="editConversationName(this)" data-id="${conv.id}">${conv.name}</span>
                    </button>
                `;
            });
            
            console.log('📝 对话Tab HTML长度:', html.length);
            
            convBar.innerHTML = html + '<button class="conversation-tab new" onclick="createConversation()">+ 新建对话</button>';
            histBar.innerHTML = html;
            
            console.log('✅ 对话Tab渲染完成');
        }

        function createConversation() {
            if (!bridge) return;
            const result = bridge.createConversation();
            
            // 等待完成后刷新
            if (result && typeof result.then === 'function') {
                result.then(() => {
                    setTimeout(loadConversations, 100);
                });
            } else {
                setTimeout(loadConversations, 100);
            }
        }

        let isLoadingHistory = false;  // 标记是否正在加载历史

        function selectConversation(convId) {
            if (!bridge) return;
            
            console.log('🔄 切换对话:', convId);
            
            isLoadingHistory = true;  // 标记开始加载历史
            
            bridge.switchConversation(convId);
            currentConversationId = convId;
            
            // 显示加载中
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '<div class="thinking">加载对话历史...</div>';
            
            // 刷新对话列表和Context
            setTimeout(() => {
                loadConversations();
            }, 100);
        }

        function editConversationName(el) {
            const convId = el.dataset.id;
            const oldName = el.textContent;
            const newName = prompt('重命名对话:', oldName);
            if (newName && newName !== oldName && bridge) {
                bridge.renameConversation(convId, newName);
                el.textContent = newName;
            }
        }

        function switchModule(module) {
            document.querySelectorAll('.module-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('conversationModule').style.display = module === 'conversation' ? 'flex' : 'none';
            document.getElementById('historyModule').style.display = module === 'history' ? 'flex' : 'none';
        }

        function switchContent(tab) {
            document.querySelectorAll('.content-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('chatPanel').style.display = tab === 'chat' ? 'flex' : 'none';
            document.getElementById('contextPanel').style.display = tab === 'context' ? 'flex' : 'none';
            document.getElementById('testPanel').style.display = tab === 'test' ? 'flex' : 'none';
        }

        async function handleMessage(data) {
            console.log('📬 handleMessage:', data.type);
            
            if (data.type === 'thinking') {
                showThinking();
                // 创建流式消息容器
                prepareStreamingContainer();
            }
            else if (data.type === 'tool_executed') {
                // 🔥 流式渲染：收到单个工具执行结果
                console.log('🔥 收到工具执行:', data.tool_data.tool);
                await renderStreamingTool(data.tool_data);
            }
            else if (data.type === 'compressing') {
                showCompressing();
            }
            else if (data.type === 'response') {
                hideThinking();
                
                // 渲染最终文本消息
                if (data.message?.trim()) {
                    await renderFinalMessage(data.message);
                }
                
                // 清理流式容器
                finishStreamingContainer();
                
                isProcessing = false;
                updateSendButton();
            }
            else if (data.type === 'error') {
                hideThinking();
                alert(data.message);
                isProcessing = false;
                updateSendButton();
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const msg = input.value.trim();
            if (!msg || !bridge || isProcessing) return;
            
            addUserMessage(msg);
            input.value = '';
            isProcessing = true;
            updateSendButton();
            bridge.sendMessage(msg);
        }

        function addUserMessage(text) {
            const area = document.getElementById('chatArea');
            area.querySelector('.empty-state')?.remove();
            const div = document.createElement('div');
            div.className = 'message user';
            div.innerHTML = `<div class="message-content">${escapeHtml(text)}</div>`;
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        // 流式渲染助手消息
        async function addAssistantMessage(data, streaming = null) {
            // 如果未指定，使用全局设置
            const useStreaming = streaming !== null ? streaming : enableStreaming;
            
            console.log('➕ 渲染助手消息 (流式:', useStreaming, ')');
            console.log('  - 工具调用数:', data.tool_calls?.length || 0);
            
            const area = document.getElementById('chatArea');
            
            // 1. 创建消息容器
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.innerHTML = '<div class="message-content" id="streaming-message"></div>';
            area.appendChild(messageDiv);
            
            const contentDiv = document.getElementById('streaming-message');
            
            // 2. 如果有工具调用，渲染工具
            if (data.tool_calls && data.tool_calls.length > 0) {
                // 创建工具容器
                const toolsContainer = document.createElement('div');
                toolsContainer.style.cssText = 'margin-bottom: 12px; padding: 12px; background: #f5f5f5; border-radius: 3px; font-size: 12px; border-left: 3px solid #666;';
                
                // 添加标题（带脉冲动画）
                const headerDiv = document.createElement('div');
                headerDiv.style.cssText = 'font-weight: 600; margin-bottom: 10px; color: #666;';
                headerDiv.innerHTML = `🔧 执行了 ${data.tool_calls.length} 个工具`;
                
                if (useStreaming) {
                    headerDiv.style.cssText += ' opacity: 0; animation: fadeInPulse 0.5s ease forwards;';
                }
                
                toolsContainer.appendChild(headerDiv);
                contentDiv.appendChild(toolsContainer);
                
                // 逐个渲染工具调用
                for (let i = 0; i < data.tool_calls.length; i++) {
                    const call = data.tool_calls[i];
                    
                    // 流式模式：先显示"正在执行"指示器
                    let executingIndicator = null;
                    if (useStreaming) {
                        executingIndicator = document.createElement('div');
                        executingIndicator.className = 'executing-indicator';
                        executingIndicator.style.margin = '8px 0';
                        executingIndicator.innerHTML = `
                            <div class="spinner"></div>
                            <span>正在执行 ${call.tool}...</span>
                        `;
                        toolsContainer.appendChild(executingIndicator);
                        area.scrollTop = area.scrollHeight;
                        await sleep(300);
                    }
                    
                    // 创建工具卡片
                    const toolCard = document.createElement('div');
                    const baseStyle = 'padding: 10px; margin: 8px 0; background: #fff; border-radius: 3px; border: 1px solid #ddd;';
                    
                    if (useStreaming) {
                        toolCard.style.cssText = baseStyle + ' opacity: 0; transform: translateY(10px); transition: all 0.3s ease;';
                    } else {
                        toolCard.style.cssText = baseStyle;
                    }
                    
                    // 工具名（带图标）
                    toolCard.innerHTML = `<div style="font-weight: 600; color: #2c2c2c; margin-bottom: 8px; font-size: 13px; font-family: Consolas, monospace;">⚡ ${i+1}. ${call.tool}</div>`;
                    
                    // 入参
                    toolCard.innerHTML += `
                        <div style="margin-bottom: 6px;">
                            <div style="font-size: 10px; color: #999; margin-bottom: 3px; font-weight: 500;">📥 入参:</div>
                            <div style="font-size: 11px; color: #2c2c2c; font-family: Consolas, monospace; background: #fafafa; padding: 6px 8px; border-radius: 2px; border: 1px solid #e0e0e0; white-space: pre-wrap;">${JSON.stringify(call.arguments, null, 2)}</div>
                        </div>
                    `;
                    
                    // 出参
                    if (call.result) {
                        const success = call.result.success;
                        const statusColor = success ? '#4caf50' : '#f44336';
                        const statusText = success ? '✅ 成功' : '⚠️ 失败（AI将自动修正）';
                        
                        toolCard.innerHTML += `
                            <div>
                                <div style="font-size: 10px; color: #999; margin-bottom: 3px; font-weight: 500;">📤 出参:</div>
                                <div style="font-size: 11px; font-family: Consolas, monospace; background: #fafafa; padding: 6px 8px; border-radius: 2px; border: 1px solid #e0e0e0;">
                                    <div style="color: ${statusColor}; font-weight: 600; margin-bottom: 4px;">${statusText}</div>
                                    <div style="color: #666; white-space: pre-wrap;">${JSON.stringify(call.result, null, 2)}</div>
                                </div>
                    </div>
                `;
            }
                    
                    // 移除"正在执行"指示器，显示实际结果
                    if (useStreaming && executingIndicator) {
                        executingIndicator.remove();
                    }
                    
                    toolsContainer.appendChild(toolCard);
                    
                    // 流式渲染：延迟后显示
                    if (useStreaming) {
                        await sleep(100);
                        toolCard.style.opacity = '1';
                        toolCard.style.transform = 'translateY(0)';
                        area.scrollTop = area.scrollHeight;
                    }
                }
                
                // 工具渲染完成后稍作停顿
                if (useStreaming) {
                    await sleep(200);
                }
            }
            
            // 3. 渲染文本消息
            if (data.message && data.message.trim()) {
                const textDiv = document.createElement('div');
                
                if (useStreaming) {
                    textDiv.style.cssText = 'opacity: 0; transform: translateY(5px); transition: all 0.4s ease;';
                }
                
                contentDiv.appendChild(textDiv);
                
                if (useStreaming) {
                    await sleep(100);
                }
                
                textDiv.innerHTML = formatMarkdown(data.message);
                
                if (useStreaming) {
                    textDiv.style.opacity = '1';
                    textDiv.style.transform = 'translateY(0)';
                }
                
                area.scrollTop = area.scrollHeight;
            }
            
            // 移除临时ID
            contentDiv.removeAttribute('id');
            
            console.log('✅ 消息渲染完成');
        }
        
        // 辅助函数：延迟
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // === 流式渲染核心函数 ===
        let streamingMessageDiv = null;
        let streamingContentDiv = null;
        let streamingToolsContainer = null;
        let streamingToolCount = 0;
        
        function prepareStreamingContainer() {
            /* 创建流式渲染容器 */
            console.log('📦 创建流式渲染容器');
            
            const area = document.getElementById('chatArea');
            
            // 创建消息容器
            streamingMessageDiv = document.createElement('div');
            streamingMessageDiv.className = 'message assistant';
            streamingMessageDiv.id = 'streaming-message-container';
            
            streamingContentDiv = document.createElement('div');
            streamingContentDiv.className = 'message-content';
            
            // 创建工具容器
            streamingToolsContainer = document.createElement('div');
            streamingToolsContainer.style.cssText = 'margin-bottom: 12px; padding: 12px; background: #f5f5f5; border-radius: 3px; font-size: 12px; border-left: 3px solid #666;';
            
            streamingContentDiv.appendChild(streamingToolsContainer);
            streamingMessageDiv.appendChild(streamingContentDiv);
            area.appendChild(streamingMessageDiv);
            
            streamingToolCount = 0;
        }
        
        async function renderStreamingTool(toolData) {
            /* 流式渲染单个工具 */
            if (!streamingToolsContainer) {
                console.error('❌ streamingToolsContainer未初始化');
                return;
            }
            
            streamingToolCount++;
            const area = document.getElementById('chatArea');
            
            console.log(`🔧 渲染工具 #${streamingToolCount}: ${toolData.tool}`);
            
            // 更新标题
            const headerDiv = streamingToolsContainer.querySelector('.tool-header') || createToolHeader();
            headerDiv.innerHTML = `🔧 执行了 ${streamingToolCount} 个工具`;
            
            // 显示"正在执行"指示器
            const executingIndicator = document.createElement('div');
            executingIndicator.className = 'executing-indicator';
            executingIndicator.style.margin = '8px 0';
            executingIndicator.innerHTML = `
                <div class="spinner"></div>
                <span>正在执行 ${toolData.tool}...</span>
            `;
            streamingToolsContainer.appendChild(executingIndicator);
            area.scrollTop = area.scrollHeight;
            
            await sleep(300);
            
            // 移除指示器
            executingIndicator.remove();
            
            // 创建工具卡片
            const toolCard = document.createElement('div');
            
            // Phase Planner工具特殊渲染（复杂度评估+Phase划分）
            if (toolData.tool === 'phase_planner') {
                toolCard.style.cssText = 'padding: 16px 20px; margin: 8px 0; background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%); border-radius: 8px; border-left: 4px solid #5c6bc0; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(92,107,192,0.2);';
                
                const complexity = toolData.arguments?.complexity_analysis || {};
                const needsPhases = toolData.arguments?.needs_phases || false;
                const phases = toolData.arguments?.phases || [];
                const totalTime = toolData.arguments?.total_estimated_time || 0;
                const totalCost = toolData.arguments?.total_estimated_cost || 0;
                
                // 复杂度评分颜色
                const complexityScore = complexity.score || 0;
                const scoreColor = complexityScore >= 7 ? '#f44336' : (complexityScore >= 4 ? '#ff9800' : '#4caf50');
                
                let contentHtml = `
                    <div style="margin-bottom: 12px; padding: 12px; background: rgba(255,255,255,0.6); border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">任务复杂度</div>
                                <div style="font-size: 24px; font-weight: 700; color: ${scoreColor};">${complexityScore.toFixed(1)}/10</div>
                                <div style="font-size: 11px; color: #666; margin-top: 2px;">${complexity.category || ''}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 11px; color: #666;">需要Phase划分</div>
                                <div style="font-size: 18px; margin-top: 4px;">${needsPhases ? '✅ 是' : '❌ 否'}</div>
                            </div>
                        </div>
                        ${complexity.reasoning ? `<div style="font-size: 11px; color: #666; margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd;">💡 ${escapeHtml(complexity.reasoning)}</div>` : ''}
                    </div>
                `;
                
                if (needsPhases && phases.length > 0) {
                    contentHtml += `<div style="font-size: 13px; color: #5c6bc0; font-weight: 700; margin-bottom: 8px;">📊 执行计划 (${phases.length}个Phases):</div>`;
                    phases.forEach((phase, i) => {
                        const priorityColor = phase.priority === 'high' ? '#f44336' : (phase.priority === 'medium' ? '#ff9800' : '#4caf50');
                        contentHtml += `
                            <div style="padding: 12px; margin: 8px 0; background: rgba(255,255,255,0.7); border-radius: 4px; border-left: 4px solid ${priorityColor};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 14px; font-weight: 700; color: #5c6bc0;">Phase ${phase.id}: ${escapeHtml(phase.name)}</div>
                                        <div style="font-size: 12px; color: #666; margin-top: 3px;">${escapeHtml(phase.goal)}</div>
                                    </div>
                                    <div style="font-size: 10px; color: ${priorityColor}; font-weight: 600; margin-left: 10px;">⭐ ${phase.priority}</div>
                                </div>
                                <div style="display: flex; gap: 12px; font-size: 10px; color: #999; margin-top: 6px;">
                                    <span>📋 ~${phase.estimated_tasks || 0} Tasks</span>
                                    <span>⏱️ ~${phase.estimated_time || 0}s</span>
                                    <span>💰 ~${((phase.estimated_tokens || 0) / 1000).toFixed(1)}K tokens</span>
                                    ${phase.dependencies && phase.dependencies.length > 0 ? `<span style="color: #2196f3;">🔗 依赖: Phase ${phase.dependencies.join(',')}</span>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    contentHtml += `
                        <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 4px; text-align: center;">
                            <div style="font-size: 11px; color: #666;">总预估</div>
                            <div style="font-size: 13px; font-weight: 600; color: #5c6bc0;">⏱️ ${totalTime}秒 | 💰 $${totalCost.toFixed(3)}</div>
                        </div>
                    `;
                } else {
                    contentHtml += `<div style="font-size: 13px; color: #4caf50; font-weight: 600; margin: 10px 0;">✅ 简单任务，直接执行，无需划分Phase</div>`;
                }
                
                toolCard.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <div style="font-size: 24px; line-height: 1;">🏗️</div>
                        <div style="flex: 1;">
                            <div style="font-size: 14px; color: #5c6bc0; font-weight: 700; margin-bottom: 8px;">📐 Phase规划与复杂度评估</div>
                            ${contentHtml}
                        </div>
                    </div>
                `;
            } else if (toolData.tool === 'plan_tool_call') {
                toolCard.style.cssText = 'padding: 12px 16px; margin: 8px 0; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 8px; border-left: 4px solid #ff9800; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
                
                // Phase-Task模式：显示Task列表
                const tasks = toolData.arguments?.tasks || toolData.result?.tasks || [];
                const plannedTools = toolData.arguments?.tools || [];  // 兼容旧格式
                const reasoning = toolData.arguments?.plan_reasoning || toolData.result?.reasoning || '';
                
                let contentHtml = '';
                
                // 优先显示Task列表（Phase-Task模式）
                if (tasks.length > 0) {
                    contentHtml = `<div style="font-size: 13px; color: #e65100; font-weight: 600; margin-bottom: 8px;">📋 规划的Tasks (${tasks.length}个):</div>`;
                    tasks.forEach((task, i) => {
                        const taskTitle = task.title || '未命名Task';
                        const taskTool = task.tool || '未知';
                        const priority = task.priority || 5;
                        const deps = task.dependencies || [];
                        
                        contentHtml += `
                            <div style="display: flex; align-items: flex-start; gap: 8px; margin: 6px 0; padding: 10px 12px; background: rgba(255,255,255,0.7); border-radius: 4px; border-left: 3px solid ${priority >= 8 ? '#ff5722' : priority >= 5 ? '#ff9800' : '#ffc107'};">
                                <div style="font-size: 16px; font-weight: 700; color: #ff9800; min-width: 24px;">${task.id}</div>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; font-weight: 700; color: #e65100; margin-bottom: 3px;">${escapeHtml(taskTitle)}</div>
                                    <div style="font-size: 11px; color: #666; margin-bottom: 2px;">${escapeHtml(task.description || '')}</div>
                                    <div style="font-size: 10px; color: #999; font-family: Consolas, monospace;">
                                        <span style="color: #ff9800;">🔧 ${escapeHtml(taskTool)}</span>
                                        ${deps.length > 0 ? ` | <span style="color: #2196f3;">依赖: ${deps.join(',')}</span>` : ''}
                                        <span style="color: #4caf50;"> | ⭐ 优先级: ${priority}/10</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    if (reasoning) {
                        contentHtml += `<div style="font-size: 11px; color: #666; margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 4px;">💡 ${escapeHtml(reasoning)}</div>`;
                    }
                } else if (plannedTools.length > 0) {
                    // 兼容旧格式（工具列表）
                    contentHtml = '<div style="font-size: 13px; color: #e65100; font-weight: 600; margin-bottom: 8px;">执行步骤：</div>';
                    plannedTools.forEach((tool, i) => {
                        const toolName = tool.tool || '未知工具';
                        contentHtml += `
                            <div style="display: flex; align-items: center; gap: 8px; margin: 6px 0; padding: 8px 10px; background: rgba(255,255,255,0.6); border-radius: 4px;">
                                <div style="font-size: 16px; font-weight: 700; color: #ff9800; min-width: 24px;">${i+1}</div>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; font-weight: 600; color: #e65100; font-family: Consolas, monospace;">${escapeHtml(toolName)}</div>
                                    <div style="font-size: 11px; color: #666; margin-top: 2px;">${escapeHtml(JSON.stringify(tool.arguments || {}))}</div>
                                </div>
                                <div style="font-size: 18px;">⚡</div>
                            </div>
                        `;
                    });
                } else {
                    contentHtml = '<div style="font-size: 13px; color: #666; font-style: italic;">无需调用工具，直接回答</div>';
                }
                
                toolCard.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <div style="font-size: 20px; line-height: 1;">📋</div>
                        <div style="flex: 1;">
                            <div style="font-size: 13px; color: #e65100; font-weight: 600; margin-bottom: 6px;">🎯 AI 正在规划...</div>
                            ${contentHtml}
                        </div>
                    </div>
                `;
            } else if (toolData.tool === 'judge_tasks') {
                // Judge工具特殊渲染（客观评判）
                toolCard.style.cssText = 'padding: 16px 20px; margin: 8px 0; background: linear-gradient(135deg, #fff9e6 0%, #ffe6b3 100%); border-radius: 8px; border-left: 4px solid #ffa726; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(255,167,38,0.2);';
                
                const phaseMetrics = toolData.arguments?.phase_metrics || {};
                const taskEval = toolData.arguments?.task_evaluation || [];
                const decision = toolData.arguments?.decision || {};
                
                let metricsHtml = `
                    <div style="display: flex; gap: 15px; margin: 10px 0;">
                        <div style="flex: 1; text-align: center; background: rgba(255,255,255,0.6); padding: 8px; border-radius: 4px;">
                            <div style="font-size: 11px; color: #666;">完成率</div>
                            <div style="font-size: 18px; font-weight: 700; color: #ffa726;">${((phaseMetrics.completion_rate || 0) * 100).toFixed(0)}%</div>
                        </div>
                        <div style="flex: 1; text-align: center; background: rgba(255,255,255,0.6); padding: 8px; border-radius: 4px;">
                            <div style="font-size: 11px; color: #666;">成功率</div>
                            <div style="font-size: 18px; font-weight: 700; color: #4caf50;">${((phaseMetrics.success_rate || 0) * 100).toFixed(0)}%</div>
                        </div>
                        <div style="flex: 1; text-align: center; background: rgba(255,255,255,0.6); padding: 8px; border-radius: 4px;">
                            <div style="font-size: 11px; color: #666;">平均质量</div>
                            <div style="font-size: 18px; font-weight: 700; color: #2196f3;">${(phaseMetrics.quality_average || 0).toFixed(1)}</div>
                        </div>
                    </div>
                `;
                
                let tasksHtml = '';
                if (taskEval.length > 0) {
                    tasksHtml = '<div style="margin-top: 10px;">';
                    taskEval.forEach(task => {
                        const statusIcon = task.status === 'done' ? '✅' : (task.status === 'failed' ? '❌' : '⏸️');
                        const scoreColor = task.quality_score >= 8 ? '#4caf50' : (task.quality_score >= 5 ? '#ff9800' : '#f44336');
                        tasksHtml += `
                            <div style="padding: 6px 10px; margin: 4px 0; background: rgba(255,255,255,0.7); border-radius: 4px; border-left: 3px solid ${scoreColor};">
                                <div style="font-size: 12px; font-weight: 600; color: #333;">
                                    ${statusIcon} Task ${task.task_id} - 质量: ${task.quality_score.toFixed(1)}/10
                                </div>
                                ${task.notes ? `<div style="font-size: 11px; color: #666; margin-top: 2px;">${escapeHtml(task.notes)}</div>` : ''}
                            </div>
                        `;
                    });
                    tasksHtml += '</div>';
                }
                
                let decisionHtml = '';
                if (decision.action) {
                    const actionText = {
                        'end': '✅ 结束Phase',
                        'continue': '🔄 继续执行',
                        'retry_with_adjustment': '🔁 重试失败Task',
                        'replan': '📝 重新规划'
                    }[decision.action] || decision.action;
                    
                    decisionHtml = `
                        <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.6); border-radius: 4px;">
                            <div style="font-size: 12px; font-weight: 700; color: #e65100; margin-bottom: 4px;">决策: ${actionText}</div>
                            <div style="font-size: 11px; color: #666;">${escapeHtml(decision.reason || '')}</div>
                        </div>
                    `;
                }
                
                toolCard.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <div style="font-size: 24px; line-height: 1;">⚖️</div>
                        <div style="flex: 1;">
                            <div style="font-size: 14px; color: #e65100; font-weight: 700; margin-bottom: 8px;">📊 Judge评判</div>
                            ${metricsHtml}
                            ${tasksHtml}
                            ${decisionHtml}
                        </div>
                    </div>
                `;
            } else if (toolData.tool === 'judge' || toolData.tool === 'think' || toolData.tool === 'judge_tasks') {
                // Judge工具特殊渲染（评判+分析）
                const hasEvaluation = toolData.arguments?.task_evaluation || toolData.arguments?.phase_metrics;
                
                if (hasEvaluation) {
                    // 包含评判数据：完整渲染
                    toolCard.style.cssText = 'padding: 16px 20px; margin: 8px 0; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 8px; border-left: 4px solid #66bb6a; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(102,187,106,0.2);';
                    
                    const phaseMetrics = toolData.arguments?.phase_metrics || {};
                    const taskEval = toolData.arguments?.task_evaluation || [];
                    const decision = toolData.arguments?.decision || {};
                    const userSummary = toolData.arguments?.user_summary || toolData.arguments?.summary || '';
                    
                    let metricsHtml = `
                        <div style="display: flex; gap: 15px; margin: 10px 0;">
                            <div style="flex: 1; text-align: center; background: rgba(255,255,255,0.7); padding: 8px; border-radius: 4px;">
                                <div style="font-size: 11px; color: #666;">完成率</div>
                                <div style="font-size: 18px; font-weight: 700; color: #66bb6a;">${((phaseMetrics.completion_rate || 0) * 100).toFixed(0)}%</div>
                            </div>
                            <div style="flex: 1; text-align: center; background: rgba(255,255,255,0.7); padding: 8px; border-radius: 4px;">
                                <div style="font-size: 11px; color: #666;">成功率</div>
                                <div style="font-size: 18px; font-weight: 700; color: #4caf50;">${((phaseMetrics.success_rate || 0) * 100).toFixed(0)}%</div>
                            </div>
                            <div style="flex: 1; text-align: center; background: rgba(255,255,255,0.7); padding: 8px; border-radius: 4px;">
                                <div style="font-size: 11px; color: #666;">平均质量</div>
                                <div style="font-size: 18px; font-weight: 700; color: #2196f3;">${(phaseMetrics.quality_average || 0).toFixed(1)}</div>
                            </div>
                        </div>
                    `;
                    
                    let tasksHtml = '';
                    if (taskEval.length > 0) {
                        tasksHtml = '<div style="margin-top: 10px;">';
                        taskEval.forEach(task => {
                            const statusIcon = task.status === 'done' ? '✅' : (task.status === 'failed' ? '❌' : '⏸️');
                            const scoreColor = task.quality_score >= 8 ? '#4caf50' : (task.quality_score >= 5 ? '#ff9800' : '#f44336');
                            tasksHtml += `
                                <div style="padding: 6px 10px; margin: 4px 0; background: rgba(255,255,255,0.8); border-radius: 4px; border-left: 3px solid ${scoreColor};">
                                    <div style="font-size: 12px; font-weight: 600; color: #333;">
                                        ${statusIcon} Task ${task.task_id} - 质量: ${task.quality_score.toFixed(1)}/10
                                    </div>
                                    ${task.notes ? `<div style="font-size: 11px; color: #666; margin-top: 2px;">${escapeHtml(task.notes)}</div>` : ''}
                                </div>
                            `;
                        });
                        tasksHtml += '</div>';
                    }
                    
                    let decisionHtml = '';
                    if (decision.action) {
                        const actionText = {
                            'end': '✅ 结束Phase',
                            'continue': '🔄 继续执行',
                            'retry_with_adjustment': '🔁 重试失败Task',
                            'replan': '📝 重新规划'
                        }[decision.action] || decision.action;
                        
                        decisionHtml = `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 4px;">
                                <div style="font-size: 12px; font-weight: 700; color: #43a047; margin-bottom: 4px;">决策: ${actionText}</div>
                                <div style="font-size: 11px; color: #666;">${escapeHtml(decision.reason || '')}</div>
                            </div>
                        `;
                    }
                    
                    toolCard.innerHTML = `
                        <div style="display: flex; align-items: flex-start; gap: 10px;">
                            <div style="font-size: 24px; line-height: 1;">💡</div>
                            <div style="flex: 1;">
                                <div style="font-size: 14px; color: #43a047; font-weight: 700; margin-bottom: 8px;">⚖️ AI评判与分析</div>
                                ${metricsHtml}
                                ${tasksHtml}
                                ${decisionHtml}
                                ${userSummary ? `<div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 4px; border-top: 2px solid #66bb6a;"><div style="font-size: 11px; color: #666; margin-bottom: 4px;">💬 总结</div><div style="font-size: 13px; color: #2e7d32; line-height: 1.5; white-space: pre-wrap;">${escapeHtml(userSummary)}</div></div>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // 简单Judge（无评判数据，纯总结）
                    toolCard.style.cssText = 'padding: 12px 16px; margin: 8px 0; background: linear-gradient(135deg, #f1f8e9 0%, #dcedc8 100%); border-radius: 8px; border-left: 4px solid #7cb342; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(124,179,66,0.1);';
                    
                    const summary = toolData.result?.summary || toolData.arguments?.summary || toolData.arguments?.user_summary || '';
                    toolCard.innerHTML = `
                        <div style="display: flex; align-items: flex-start; gap: 10px;">
                            <div style="font-size: 20px; line-height: 1;">💡</div>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; color: #558b2f; font-weight: 600; margin-bottom: 6px;">AI 分析中...</div>
                                <div style="font-size: 14px; color: #33691e; line-height: 1.6; white-space: pre-wrap;">${escapeHtml(summary)}</div>
                            </div>
                        </div>
                    `;
                }
            } else if (toolData.tool === 'summarizer' || toolData.tool === 'task_done') {
                // Summarizer工具特殊渲染（任务总结）
                toolCard.style.cssText = 'padding: 16px 20px; margin: 8px 0; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border-radius: 8px; border-left: 4px solid #28a745; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(40,167,69,0.2);';
                
                const summary = toolData.result?.summary || toolData.arguments?.summary || '任务已完成';
                toolCard.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <div style="font-size: 24px; line-height: 1;">✅</div>
                        <div style="flex: 1;">
                            <div style="font-size: 14px; color: #28a745; font-weight: 700; margin-bottom: 8px;">✨ 任务完成</div>
                            <div style="font-size: 14px; color: #155724; line-height: 1.6; white-space: pre-wrap; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 4px;">${escapeHtml(summary)}</div>
                        </div>
                    </div>
                `;
            } else {
                // 普通工具渲染
                toolCard.style.cssText = 'padding: 10px; margin: 8px 0; background: #fff; border-radius: 3px; border: 1px solid #ddd; opacity: 0; transform: translateY(10px); transition: all 0.3s ease;';
                
                // 工具名和状态
                const success = toolData.result ? toolData.result.success : true;
                const statusColor = success ? '#4caf50' : '#f44336';
                const statusIcon = success ? '✅' : '⚠️';
                
                toolCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 600; color: #2c2c2c; font-size: 13px; font-family: Consolas, monospace;">⚡ ${streamingToolCount}. ${toolData.tool}</div>
                        <div style="color: ${statusColor}; font-weight: 600; font-size: 12px;">${statusIcon} ${success ? '成功' : '失败'}</div>
                    </div>
                    <div style="margin-bottom: 6px;">
                        <div style="font-size: 10px; color: #999; margin-bottom: 3px; font-weight: 500;">📥 入参:</div>
                        <div style="font-size: 11px; color: #2c2c2c; font-family: Consolas, monospace; background: #fafafa; padding: 6px 8px; border-radius: 2px; border: 1px solid #e0e0e0; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${JSON.stringify(toolData.arguments, null, 2)}</div>
                    </div>
                `;
                
                // 添加查看完整参数按钮（主要看出参）
                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn-view-params';
                viewBtn.innerHTML = '📤 查看完整出参';
                viewBtn.onclick = () => showParamsModal(toolData.tool, toolData.arguments, toolData.result);
                toolCard.appendChild(viewBtn);
            }
            
            streamingToolsContainer.appendChild(toolCard);
            
            await sleep(100);
            toolCard.style.opacity = '1';
            toolCard.style.transform = 'translateY(0)';
            area.scrollTop = area.scrollHeight;
        }
        
        function createToolHeader() {
            /* 创建工具标题 */
            const headerDiv = document.createElement('div');
            headerDiv.className = 'tool-header';
            headerDiv.style.cssText = 'font-weight: 600; margin-bottom: 10px; color: #666; opacity: 0; animation: fadeInPulse 0.5s ease forwards;';
            streamingToolsContainer.insertBefore(headerDiv, streamingToolsContainer.firstChild);
            return headerDiv;
        }
        
        async function renderFinalMessage(message) {
            /* 渲染最终文本消息 */
            if (!streamingContentDiv) {
                console.error('❌ streamingContentDiv未初始化');
                return;
            }
            
            console.log('💬 渲染最终消息');
            
            const area = document.getElementById('chatArea');
            const textDiv = document.createElement('div');
            textDiv.style.cssText = 'opacity: 0; transform: translateY(5px); transition: all 0.4s ease;';
            streamingContentDiv.appendChild(textDiv);
            
            await sleep(100);
            textDiv.innerHTML = formatMarkdown(message);
            textDiv.style.opacity = '1';
            textDiv.style.transform = 'translateY(0)';
            area.scrollTop = area.scrollHeight;
        }
        
        function finishStreamingContainer() {
            /* 完成流式渲染 */
            console.log('✅ 流式渲染完成');
            streamingMessageDiv = null;
            streamingContentDiv = null;
            streamingToolsContainer = null;
            streamingToolCount = 0;
        }
        
        // === 参数弹窗函数 ===
        function showParamsModal(toolName, arguments_data, result_data) {
            /* 显示工具参数弹窗 */
            const modal = document.getElementById('paramsModal');
            const title = document.getElementById('paramsModalTitle');
            const inputEl = document.getElementById('paramsInput');
            const outputEl = document.getElementById('paramsOutput');
            
            // 设置标题
            title.textContent = `工具参数 - ${toolName}`;
            
            // 显示入参
            inputEl.textContent = JSON.stringify(arguments_data, null, 2);
            
            // 显示出参
            if (result_data) {
                outputEl.textContent = JSON.stringify(result_data, null, 2);
            } else {
                outputEl.textContent = '(无返回结果)';
            }
            
            // 显示弹窗
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeParamsModal(event) {
            /* 关闭参数弹窗 */
            const modal = document.getElementById('paramsModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        function copyParams() {
            /* 复制全部参数 */
            const inputText = document.getElementById('paramsInput').textContent;
            const outputText = document.getElementById('paramsOutput').textContent;
            const fullText = `入参:\n${inputText}\n\n出参:\n${outputText}`;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(fullText).then(() => {
                    const btn = event.target;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '✓ 已复制';
                    btn.style.background = '#4caf50';
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '#2c2c2c';
                    }, 2000);
                }).catch(err => {
                    console.error('复制失败:', err);
                    alert('复制失败');
                });
            }
        }
        
        // ESC键关闭参数弹窗
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' || event.key === 'Esc') {
                const paramsModal = document.getElementById('paramsModal');
                if (paramsModal && paramsModal.classList.contains('active')) {
                    closeParamsModal();
                }
            }
        });

        function showThinking() {
            const area = document.getElementById('chatArea');
            const div = document.createElement('div');
            div.className = 'thinking';
            div.id = 'thinking';
            div.textContent = '思考中...';
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function showCompressing() {
            hideThinking();
            const area = document.getElementById('chatArea');
            const div = document.createElement('div');
            div.className = 'thinking';
            div.id = 'thinking';
            div.textContent = '🗜️ 正在整理对话...';
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function hideThinking() {
            document.getElementById('thinking')?.remove();
        }

        function updateSendButton() {
            const btn = document.getElementById('sendBtn');
            btn.disabled = isProcessing;
            btn.textContent = isProcessing ? '处理中...' : '发送';
        }

        function updateContext(data) {
            console.log('updateContext:', data.message_count, '条消息', data.token_usage.total_tokens, 'tokens');
            
            document.getElementById('promptTokens').textContent = (data.token_usage.prompt_tokens / 1000).toFixed(1);
            document.getElementById('completionTokens').textContent = (data.token_usage.completion_tokens / 1000).toFixed(1);
            document.getElementById('totalTokens').textContent = (data.token_usage.total_tokens / 1000).toFixed(1);
            document.getElementById('messageCount').textContent = data.message_count;
            updateContextCircle(data.token_usage.total_tokens);
            
            const list = document.getElementById('contextList');
            if (data.messages.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Context为空</div>';
            } else {
                let html = '';
                data.messages.forEach((msg, idx) => {
                    const role = msg.role === 'user' ? 'user' : 'assistant';
                    const name = msg.role === 'user' ? '用户' : '助手';
                    const display = msg.content.length > 300 ? msg.content.substring(0, 300) + '...' : msg.content;
                    
                    html += `<div class="message-item ${role}">`;
                    html += `<div class="message-header">[${idx+1}] ${name}</div>`;
                    html += `<div class="message-text">${escapeHtml(display)}</div>`;
                    
                    // Context预览 - 工具调用（显示入参+按钮查看出参）
                    if (msg.tool_calls && msg.tool_calls.length > 0) {
                        html += `<div style="margin-top: 10px; padding: 10px; background: rgba(76,175,80,0.08); border: 1px solid rgba(76,175,80,0.3); border-radius: 3px;">`;
                        html += `<div style="font-size: 11px; color: #4caf50; font-weight: 600; margin-bottom: 8px;">🔧 执行了 ${msg.tool_calls.length} 个工具</div>`;
                        
                        msg.tool_calls.forEach((call, i) => {
                            // Plan工具特殊渲染
                            if (call.tool === 'plan_tool_call') {
                                const plannedTools = call.arguments?.tools || [];
                                html += `<div style="padding: 12px 16px; margin: 8px 0; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 8px; border-left: 4px solid #ff9800; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">`;
                                html += `<div style="display: flex; align-items: flex-start; gap: 10px;">`;
                                html += `<div style="font-size: 18px; line-height: 1;">📋</div>`;
                                html += `<div style="flex: 1;">`;
                                html += `<div style="font-size: 11px; color: #e65100; font-weight: 600; margin-bottom: 4px;">AI 规划</div>`;
                                if (plannedTools.length === 0) {
                                    html += `<div style="font-size: 11px; color: #666; font-style: italic;">无需调用工具</div>`;
                                } else {
                                    plannedTools.forEach((tool, idx) => {
                                        html += `<div style="font-size: 11px; color: #e65100; margin: 2px 0;">${idx+1}. ${escapeHtml(tool.tool || '未知')}</div>`;
                                    });
                                }
                                html += `</div></div></div>`;
                            } else if (call.tool === 'think') {
                                // Think工具特殊渲染
                                const summary = call.result?.summary || call.arguments?.summary || '';
                                html += `<div style="padding: 12px 16px; margin: 8px 0; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">`;
                                html += `<div style="display: flex; align-items: flex-start; gap: 10px;">`;
                                html += `<div style="font-size: 18px; line-height: 1;">💭</div>`;
                                html += `<div style="flex: 1;">`;
                                html += `<div style="font-size: 11px; color: #1976d2; font-weight: 600; margin-bottom: 4px;">AI 思考</div>`;
                                html += `<div style="font-size: 12px; color: #424242; line-height: 1.5; white-space: pre-wrap;">${escapeHtml(summary)}</div>`;
                                html += `</div></div></div>`;
                            } else {
                                // 普通工具渲染
                                const success = call.result ? call.result.success : true;
                                const statusColor = success ? '#4caf50' : '#f44336';
                                const statusIcon = success ? '✅' : '⚠️';
                                
                                html += `<div style="padding: 10px; margin: 8px 0; background: #fff; border-radius: 3px; border: 1px solid #e0e0e0;">`;
                                html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">`;
                                html += `<div style="font-weight: 600; color: #2c2c2c; font-size: 12px; font-family: Consolas, monospace;">${i+1}. ${call.tool}</div>`;
                                html += `<div style="color: ${statusColor}; font-weight: 600; font-size: 11px;">${statusIcon} ${success ? '成功' : '失败'}</div>`;
                                html += `</div>`;
                                
                                // 显示入参
                                html += `<div style="margin-bottom: 6px;">`;
                                html += `<div style="font-size: 10px; color: #999; margin-bottom: 3px; font-weight: 500;">📥 入参:</div>`;
                                html += `<div style="font-size: 10px; color: #2c2c2c; font-family: Consolas, monospace; background: #fafafa; padding: 6px 8px; border-radius: 2px; border: 1px solid #e0e0e0; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${JSON.stringify(call.arguments, null, 2)}</div>`;
                                html += `</div>`;
                                
                                // 按钮查看完整出参
                                const argsJson = escapeHtml(JSON.stringify(call.arguments));
                                const resultJson = call.result ? escapeHtml(JSON.stringify(call.result)) : '';
                                html += `<button class="btn-view-params" data-tool="${escapeHtml(call.tool)}" data-args='${argsJson}' data-result='${resultJson}' onclick="showParamsModal(this.dataset.tool, JSON.parse(this.dataset.args), this.dataset.result ? JSON.parse(this.dataset.result) : null)">📤 查看完整出参</button>`;
                                html += `</div>`;
                            }
                        });
                        
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                });
                list.innerHTML = html;
            }
        }

        function updateHistory(data) {
            const msgs = data.messages || [];
            console.log('📨 updateHistory被调用');
            console.log('  - 消息数:', msgs.length);
            console.log('  - conversation_id:', data.conversation_id);
            console.log('  - isLoadingHistory:', isLoadingHistory);
            console.log('  - 将渲染到聊天界面:', isLoadingHistory && msgs.length > 0);
            
            // 统计字符（聊天记录管理模块用）
            let total = 0, chinese = 0, english = 0;
            msgs.forEach(m => {
                const c = m.content || '';
                total += c.length;
                chinese += (c.match(/[\u4e00-\u9fa5]/g) || []).length;
                english += (c.match(/[a-zA-Z]/g) || []).length;
            });
            
            document.getElementById('historyTotalChars').textContent = total.toLocaleString();
            document.getElementById('historyChineseChars').textContent = chinese.toLocaleString();
            document.getElementById('historyEnglishChars').textContent = english.toLocaleString();
            document.getElementById('historyCount').textContent = msgs.length;
            
            // 渲染到聊天记录管理模块（和Context预览一样详细）
            const list = document.getElementById('historyList');
            if (msgs.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">暂无消息</div>';
            } else {
                let html = '';
                msgs.forEach((msg, idx) => {
                    const role = msg.role === 'user' ? 'user' : 'assistant';
                    const name = msg.role === 'user' ? '用户' : '助手';
                    const display = msg.content.length > 300 ? msg.content.substring(0, 300) + '...' : msg.content;
                    
                    html += `<div class="message-item ${role}">`;
                    html += `<div class="message-header">[${idx+1}] ${name}</div>`;
                    html += `<div class="message-text">${escapeHtml(display)}</div>`;
                    
                    // 工具调用（显示入参+按钮查看出参）
                    if (msg.tool_calls && msg.tool_calls.length > 0) {
                        html += `<div style="margin-top: 10px; padding: 10px; background: rgba(76,175,80,0.08); border: 1px solid rgba(76,175,80,0.3); border-radius: 3px;">`;
                        html += `<div style="font-size: 11px; color: #4caf50; font-weight: 600; margin-bottom: 8px;">🔧 执行了 ${msg.tool_calls.length} 个工具</div>`;
                        
                        msg.tool_calls.forEach((call, i) => {
                            // Plan工具特殊渲染
                            if (call.tool === 'plan_tool_call') {
                                const plannedTools = call.arguments?.tools || [];
                                html += `<div style="padding: 12px 16px; margin: 8px 0; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 8px; border-left: 4px solid #ff9800; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">`;
                                html += `<div style="display: flex; align-items: flex-start; gap: 10px;">`;
                                html += `<div style="font-size: 18px; line-height: 1;">📋</div>`;
                                html += `<div style="flex: 1;">`;
                                html += `<div style="font-size: 11px; color: #e65100; font-weight: 600; margin-bottom: 4px;">AI 规划</div>`;
                                if (plannedTools.length === 0) {
                                    html += `<div style="font-size: 11px; color: #666; font-style: italic;">无需调用工具</div>`;
                                } else {
                                    plannedTools.forEach((tool, idx) => {
                                        html += `<div style="font-size: 11px; color: #e65100; margin: 2px 0;">${idx+1}. ${escapeHtml(tool.tool || '未知')}</div>`;
                                    });
                                }
                                html += `</div></div></div>`;
                            } else if (call.tool === 'think') {
                                // Think工具特殊渲染
                                const summary = call.result?.summary || call.arguments?.summary || '';
                                html += `<div style="padding: 12px 16px; margin: 8px 0; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">`;
                                html += `<div style="display: flex; align-items: flex-start; gap: 10px;">`;
                                html += `<div style="font-size: 18px; line-height: 1;">💭</div>`;
                                html += `<div style="flex: 1;">`;
                                html += `<div style="font-size: 11px; color: #1976d2; font-weight: 600; margin-bottom: 4px;">AI 思考</div>`;
                                html += `<div style="font-size: 12px; color: #424242; line-height: 1.5; white-space: pre-wrap;">${escapeHtml(summary)}</div>`;
                                html += `</div></div></div>`;
                            } else {
                                // 普通工具渲染
                                const success = call.result ? call.result.success : true;
                                const statusColor = success ? '#4caf50' : '#f44336';
                                const statusIcon = success ? '✅' : '⚠️';
                                
                                html += `<div style="padding: 10px; margin: 8px 0; background: #fff; border-radius: 3px; border: 1px solid #e0e0e0;">`;
                                html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">`;
                                html += `<div style="font-weight: 600; color: #2c2c2c; font-size: 12px; font-family: Consolas, monospace;">${i+1}. ${call.tool}</div>`;
                                html += `<div style="color: ${statusColor}; font-weight: 600; font-size: 11px;">${statusIcon} ${success ? '成功' : '失败'}</div>`;
                                html += `</div>`;
                                
                                // 显示入参
                                html += `<div style="margin-bottom: 6px;">`;
                                html += `<div style="font-size: 10px; color: #999; margin-bottom: 3px; font-weight: 500;">📥 入参:</div>`;
                                html += `<div style="font-size: 10px; color: #2c2c2c; font-family: Consolas, monospace; background: #fafafa; padding: 6px 8px; border-radius: 2px; border: 1px solid #e0e0e0; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${JSON.stringify(call.arguments, null, 2)}</div>`;
                                html += `</div>`;
                                
                                // 按钮查看完整出参
                                const argsJson = escapeHtml(JSON.stringify(call.arguments));
                                const resultJson = call.result ? escapeHtml(JSON.stringify(call.result)) : '';
                                html += `<button class="btn-view-params" data-tool="${escapeHtml(call.tool)}" data-args='${argsJson}' data-result='${resultJson}' onclick="showParamsModal(this.dataset.tool, JSON.parse(this.dataset.args), this.dataset.result ? JSON.parse(this.dataset.result) : null)">📤 查看完整出参</button>`;
                                html += `</div>`;
                            }
                        });
                        
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                });
                list.innerHTML = html;
            }
            
            // ========== 只在切换对话/启动时渲染历史 ==========
            if (isLoadingHistory) {
                if (msgs.length > 0) {
                    console.log('🔄 isLoadingHistory=true，渲染历史到聊天界面');
                    renderChatHistory(msgs);
                } else {
                    console.log('⚠️ 历史为空，显示空状态');
            const chatArea = document.getElementById('chatArea');
                    if (chatArea) {
                        chatArea.innerHTML = '<div class="empty-state"><h2>📖</h2><p>开始对话</p></div>';
                    }
                }
                isLoadingHistory = false;  // 重置标记（只渲染一次）
            } else {
                console.log('⏭️ isLoadingHistory=false，跳过聊天界面渲染');
            }
        }
        
        function renderChatHistory(msgs) {
            console.log('🎨 renderChatHistory被调用, 消息数:', msgs.length);
            
            const chatArea = document.getElementById('chatArea');
            
            if (!chatArea) {
                console.error('❌ chatArea元素不存在！');
                return;
            }
            
            if (msgs.length === 0) {
                console.log('⚠️ 消息为0，显示空状态');
                chatArea.innerHTML = '<div class="empty-state"><h2>📖</h2><p>开始对话</p></div>';
                return;
            }
            
            console.log('🎨 清空chatArea，重新渲染历史');
            
            // 清空
            chatArea.innerHTML = '';
            
            // 渲染所有历史消息（包含工具调用）
            msgs.forEach((msg, idx) => {
                console.log(`  渲染消息${idx+1}: ${msg.role}, 工具=${msg.tool_calls?.length || 0}`);
                
                const div = document.createElement('div');
                div.className = 'message ' + (msg.role === 'user' ? 'user' : 'assistant');
                
                let content = `<div class="message-content">${formatMarkdown(msg.content)}`;
                
                // 工具调用（显示入参+按钮查看出参）
                if (msg.tool_calls && msg.tool_calls.length > 0) {
                    content += `<div style="margin-top: 12px; padding: 12px; background: #f5f5f5; border-radius: 3px; border-left: 3px solid #666;">`;
                    content += `<div style="font-weight: 600; margin-bottom: 10px; color: #666; font-size: 12px;">🔧 执行了 ${msg.tool_calls.length} 个工具</div>`;
                    
                    msg.tool_calls.forEach((call, i) => {
                        // Plan工具特殊渲染
                        if (call.tool === 'plan_tool_call') {
                            const plannedTools = call.arguments?.tools || [];
                            content += `<div style="padding: 12px 16px; margin: 8px 0; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 8px; border-left: 4px solid #ff9800; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">`;
                            content += `<div style="display: flex; align-items: flex-start; gap: 10px;">`;
                            content += `<div style="font-size: 20px; line-height: 1;">📋</div>`;
                            content += `<div style="flex: 1;">`;
                            content += `<div style="font-size: 13px; color: #e65100; font-weight: 600; margin-bottom: 6px;">AI 规划</div>`;
                            if (plannedTools.length === 0) {
                                content += `<div style="font-size: 13px; color: #666; font-style: italic;">无需调用工具</div>`;
                            } else {
                                plannedTools.forEach((tool, idx) => {
                                    content += `<div style="font-size: 13px; color: #e65100; margin: 4px 0; font-weight: 600;">${idx+1}. ${escapeHtml(tool.tool || '未知')}</div>`;
                                });
                            }
                            content += `</div></div></div>`;
                        } else if (call.tool === 'think') {
                            // Think工具特殊渲染
                            const summary = call.result?.summary || call.arguments?.summary || '';
                            content += `<div style="padding: 12px 16px; margin: 8px 0; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 8px; border-left: 4px solid #2196f3; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">`;
                            content += `<div style="display: flex; align-items: flex-start; gap: 10px;">`;
                            content += `<div style="font-size: 20px; line-height: 1;">💭</div>`;
                            content += `<div style="flex: 1;">`;
                            content += `<div style="font-size: 13px; color: #1976d2; font-weight: 600; margin-bottom: 6px;">AI 思考</div>`;
                            content += `<div style="font-size: 14px; color: #424242; line-height: 1.6; white-space: pre-wrap;">${escapeHtml(summary)}</div>`;
                            content += `</div></div></div>`;
                        } else if (call.tool === 'task_done') {
                            // Task Done工具特殊渲染
                            const summary = call.result?.summary || call.arguments?.summary || '任务已完成';
                            content += `<div style="padding: 16px 20px; margin: 8px 0; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border-radius: 8px; border-left: 4px solid #28a745; box-shadow: 0 2px 8px rgba(40,167,69,0.2);">`;
                            content += `<div style="display: flex; align-items: flex-start; gap: 10px;">`;
                            content += `<div style="font-size: 22px; line-height: 1;">✅</div>`;
                            content += `<div style="flex: 1;">`;
                            content += `<div style="font-size: 14px; color: #28a745; font-weight: 700; margin-bottom: 8px;">✨ 任务完成</div>`;
                            content += `<div style="font-size: 14px; color: #155724; line-height: 1.6; white-space: pre-wrap; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 4px;">${escapeHtml(summary)}</div>`;
                            content += `</div></div></div>`;
                        } else {
                            // 普通工具渲染
                            const success = call.result ? call.result.success : true;
                            const statusColor = success ? '#4caf50' : '#f44336';
                            const statusIcon = success ? '✅' : '⚠️';
                            
                            content += `<div style="padding: 10px; margin: 8px 0; background: #fff; border-radius: 3px; border: 1px solid #ddd;">`;
                            content += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">`;
                            content += `<div style="font-weight: 600; color: #2c2c2c; font-size: 13px; font-family: Consolas, monospace;">${i+1}. ${call.tool}</div>`;
                            content += `<div style="color: ${statusColor}; font-weight: 600; font-size: 12px;">${statusIcon} ${success ? '成功' : '失败'}</div>`;
                            content += `</div>`;
                            
                            // 显示入参
                            content += `<div style="margin-bottom: 6px;">`;
                            content += `<div style="font-size: 10px; color: #999; margin-bottom: 3px; font-weight: 500;">📥 入参:</div>`;
                            content += `<div style="font-size: 11px; color: #2c2c2c; font-family: Consolas, monospace; background: #fafafa; padding: 6px 8px; border-radius: 2px; border: 1px solid #e0e0e0; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${JSON.stringify(call.arguments, null, 2)}</div>`;
                            content += `</div>`;
                            
                            // 按钮查看完整出参
                            const argsJson = escapeHtml(JSON.stringify(call.arguments));
                            const resultJson = call.result ? escapeHtml(JSON.stringify(call.result)) : '';
                            content += `<button class="btn-view-params" data-tool="${escapeHtml(call.tool)}" data-args='${argsJson}' data-result='${resultJson}' onclick="showParamsModal(this.dataset.tool, JSON.parse(this.dataset.args), this.dataset.result ? JSON.parse(this.dataset.result) : null)">📤 查看完整出参</button>`;
                            content += `</div>`;
                        }
                    });
                    
                    content += `</div>`;
                }
                
                content += `</div>`;
                div.innerHTML = content;
                chatArea.appendChild(div);
            });
            
            console.log('✅ 历史消息渲染完成（含工具调用），子元素数:', chatArea.children.length);
            
            // 滚动到底部
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function updateConversations(data) {
            console.log('updateConversations:', data.length, '个对话');
            conversations = data;
            renderConversationTabs();
        }

        function updateContextCircle(totalTokens) {
            const maxTokens = 131072;
            const percentage = (totalTokens / maxTokens) * 100;
            const circumference = 100.48;
            const offset = circumference - (percentage / 100) * circumference;
            
            const circle = document.getElementById('contextCircle');
            circle.style.strokeDashoffset = offset;
            
            if (percentage >= 90) {
                circle.classList.add('danger');
                circle.classList.remove('warning');
            } else if (percentage >= 70) {
                circle.classList.add('warning');
                circle.classList.remove('danger');
            } else {
                circle.classList.remove('warning', 'danger');
            }
            
            document.getElementById('contextPercent').textContent = percentage.toFixed(0) + '%';
            document.getElementById('contextTokens').textContent = (totalTokens / 1000).toFixed(1) + 'K/131K';
        }

        function compact() {
            if (!bridge) return;
            if (confirm('确定压缩Context？')) bridge.manualCompact();
        }

        function formatMarkdown(text) {
            let html = escapeHtml(text);
            
            // 代码块 ```code```
            html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, function(match, lang, code) {
                return `<pre style="background:#2c2c2c;color:#e0e0e0;padding:8px;border-radius:3px;overflow-x:auto;margin:6px 0;line-height:1.3;"><code>${code.trim()}</code></pre>`;
            });
            
            // 行内代码 `code`
            html = html.replace(/`([^`]+)`/g, '<code style="background:#f0f0f0;padding:2px 6px;border-radius:2px;font-family:Consolas,monospace;font-size:13px;color:#2c2c2c;">$1</code>');
            
            // 粗体 **text**
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong style="color:#1a1a1a;font-weight:600;">$1</strong>');
            
            // 斜体 *text*
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
            
            // 列表 - item (紧凑样式)
            html = html.replace(/^- (.+)$/gm, '<li style="margin-left:25px;color:#333;line-height:1.3;margin-bottom:3px;">$1</li>');
            
            // 标题 (按从多到少的顺序，避免匹配冲突)
            html = html.replace(/^#### (.+)$/gm, '<h5 style="margin:6px 0 4px 0;color:#2c2c2c;font-weight:500;font-size:14px;line-height:1.3;">$1</h5>');
            html = html.replace(/^### (.+)$/gm, '<h4 style="margin:6px 0 4px 0;color:#2c2c2c;font-weight:500;font-size:15px;line-height:1.3;">$1</h4>');
            html = html.replace(/^## (.+)$/gm, '<h3 style="margin:8px 0 5px 0;color:#2c2c2c;font-weight:500;font-size:16px;line-height:1.3;">$1</h3>');
            html = html.replace(/^# (.+)$/gm, '<h2 style="margin:8px 0 5px 0;color:#2c2c2c;font-weight:500;font-size:18px;line-height:1.3;">$1</h2>');
            
            // 换行 (使用更紧凑的行高)
            html = html.replace(/\n/g, '<br style="line-height:1.3;">');
            
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 根据工具类型定制结果渲染
        function renderToolResult(toolName, result) {
            let html = '';
            
            // list_files - 文件列表
            if (toolName === 'list_files') {
                const files = result.files || [];
                const dirs = result.directories || [];
                
                html += `<div style="color: #666;">`;
                html += `<div>文件数: ${result.total_files || files.length}</div>`;
                html += `<div>目录数: ${result.total_directories || dirs.length}</div>`;
                
                if (files.length > 0) {
                    html += `<div style="margin-top: 6px; font-weight: 500;">📄 文件:</div>`;
                    files.slice(0, 10).forEach(f => {
                        html += `<div style="padding-left: 10px; font-size: 10px;">- ${f.name || f.path}</div>`;
                    });
                    if (files.length > 10) {
                        html += `<div style="padding-left: 10px; font-size: 10px; color: #999;">... 还有 ${files.length - 10} 个文件</div>`;
                    }
                }
                
                if (dirs.length > 0) {
                    html += `<div style="margin-top: 6px; font-weight: 500;">📁 目录:</div>`;
                    dirs.slice(0, 5).forEach(d => {
                        html += `<div style="padding-left: 10px; font-size: 10px;">- ${d.name || d.path}</div>`;
                    });
                    if (dirs.length > 5) {
                        html += `<div style="padding-left: 10px; font-size: 10px; color: #999;">... 还有 ${dirs.length - 5} 个目录</div>`;
                    }
                }
                
                html += `</div>`;
            }
            // read_file - 文件内容
            else if (toolName === 'read_file') {
                html += `<div style="color: #666;">`;
                html += `<div>路径: ${result.path || ''}</div>`;
                html += `<div>行数: ${result.lines || 0}</div>`;
                const content = result.content || '';
                const preview = content.substring(0, 200);
                html += `<div style="margin-top: 6px;">内容预览:</div>`;
                html += `<div style="background: #f5f5f5; padding: 6px; border-radius: 2px; font-size: 10px; white-space: pre-wrap; max-height: 100px; overflow-y: auto;">${escapeHtml(preview)}${content.length > 200 ? '\n...' : ''}</div>`;
                html += `</div>`;
            }
            // write_file - 写入结果
            else if (toolName === 'write_file') {
                html += `<div style="color: #666;">`;
                html += `<div>路径: ${result.path || ''}</div>`;
                html += `<div>写入: ${result.bytes_written || 0} 字节</div>`;
                html += `</div>`;
            }
            // edit_file - 编辑结果（批量）
            else if (toolName === 'edit_file') {
                html += `<div style="color: #666;">`;
                html += `<div>路径: ${result.path || ''}</div>`;
                html += `<div>总编辑数: ${result.total_edits || 0}</div>`;
                html += `<div style="color: #4caf50;">成功: ${result.successful_edits || 0}</div>`;
                if (result.failed_edits > 0) {
                    html += `<div style="color: #ff9800;">失败: ${result.failed_edits}</div>`;
                }
                html += `</div>`;
            }
            // search_code - 搜索结果
            else if (toolName === 'search_code') {
                const results = result.results || [];
                html += `<div style="color: #666;">`;
                html += `<div>找到: ${result.total || results.length} 处</div>`;
                
                if (results.length > 0) {
                    html += `<div style="margin-top: 6px;">匹配:</div>`;
                    results.slice(0, 5).forEach(r => {
                        html += `<div style="padding-left: 10px; font-size: 10px;">- ${r.file}:${r.line}</div>`;
                    });
                    if (results.length > 5) {
                        html += `<div style="padding-left: 10px; font-size: 10px; color: #999;">... 还有 ${results.length - 5} 处</div>`;
                    }
                }
                html += `</div>`;
            }
            // get_project_structure - 项目结构
            else if (toolName === 'get_project_structure') {
                html += `<div style="color: #666;">`;
                html += `<div>路径: ${result.path || ''}</div>`;
                if (result.tree) {
                    html += `<div style="margin-top: 6px;">结构: (已生成)</div>`;
                }
                html += `</div>`;
            }
            // run_terminal - 终端输出
            else if (toolName === 'run_terminal') {
                const output = result.output || '';
                html += `<div style="color: #666;">`;
                html += `<div>返回码: ${result.return_code || 0}</div>`;
                if (output) {
                    const preview = output.substring(0, 150);
                    html += `<div style="margin-top: 6px;">输出:</div>`;
                    html += `<div style="background: #2c2c2c; color: #e0e0e0; padding: 6px; border-radius: 2px; font-size: 10px; white-space: pre-wrap; max-height: 80px; overflow-y: auto;">${escapeHtml(preview)}${output.length > 150 ? '\n...' : ''}</div>`;
                }
                html += `</div>`;
            }
            // query_history - 聊天记录查询
            else if (toolName === 'query_history') {
                const results = result.results || [];
                html += `<div style="color: #666;">`;
                html += `<div>搜索: "${result.query}"</div>`;
                html += `<div>匹配: ${result.total || 0} 条</div>`;
                html += `<div>搜索范围: ${result.searched_messages || 0} 条消息</div>`;
                
                if (results.length > 0) {
                    html += `<div style="margin-top: 8px; font-weight: 500;">🔍 查询结果:</div>`;
                    results.forEach((r, i) => {
                        const content = r.content || '';
                        const preview = content.length > 100 ? content.substring(0, 100) + '...' : content;
                        html += `<div style="margin: 6px 0; padding: 6px; background: #f9f9f9; border-left: 2px solid #4caf50; border-radius: 2px;">`;
                        html += `<div style="font-size: 10px; color: #4caf50; font-weight: 600;">[${r.index}] ${r.role}</div>`;
                        html += `<div style="font-size: 10px; color: #666; margin-top: 2px;">${escapeHtml(preview)}</div>`;
                        if (r.relevance) {
                            html += `<div style="font-size: 9px; color: #999; margin-top: 2px; font-style: italic;">相关度: ${r.relevance}</div>`;
                        }
                        html += `</div>`;
                    });
                }
                html += `</div>`;
            }
            // 默认 - 完整JSON
            else {
                html += `<div style="color: #666; white-space: pre-wrap;">${JSON.stringify(result, null, 2)}</div>`;
            }
            
            return html;
        }

        function zoomIn() { currentZoom = Math.min(currentZoom + 5, 200); applyZoom(); }
        function zoomOut() { currentZoom = Math.max(currentZoom - 5, 50); applyZoom(); }
        function resetZoom() { currentZoom = 100; applyZoom(); }
        function applyZoom() {
            document.body.style.zoom = currentZoom + '%';
            document.getElementById('zoomDisplay').textContent = currentZoom + '%';
        }

        function runTests() { alert('测试功能'); }
    </script>
</body>
</html>
